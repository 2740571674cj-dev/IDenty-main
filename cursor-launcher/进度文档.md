# Cursor Agent å¯¹é½å¤åˆ» â€” å®æ–½è¿›åº¦æ–‡æ¡£

> **æ—¥æœŸ**: 2026-02-18  
> **å®æ–½èŒƒå›´**: MW1 ~ MW12 å…¨é‡å®æ–½  
> **å®æ–½çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

---

## æ€»è§ˆ

| Phase | æ”¹é€ é¡¹ | çŠ¶æ€ | ä¸»è¦å˜æ›´ |
|-------|--------|------|---------|
| Phase 1 | MW1-MW7ï¼ˆæ ¸å¿ƒå¯¹é½ï¼‰ | âœ… å®Œæˆ | 28 ä¸ªæ–‡ä»¶æ–°å¢ï¼Œ2 ä¸ªä¿®æ”¹ |
| Phase 2 | MW8, MW10ï¼ˆèƒ½åŠ›æ‰©å±•ï¼‰ | âœ… å®Œæˆ | 5 ä¸ªæ–‡ä»¶æ–°å¢ |
| Phase 3 | MW9ï¼ˆWeb å·¥å…·ï¼‰ | âœ… å®Œæˆ | 2 ä¸ªæ–‡ä»¶æ–°å¢ |
| Phase 4 | MW11, MW12ï¼ˆé«˜çº§å·¥å…·ï¼‰ | âœ… å®Œæˆ | 2 ä¸ªæ–‡ä»¶æ–°å¢ |
| Phase 6-12D | è¡¥å…¨+UIæ·±åº¦å¯¹é½+ä¿®å¤ | âœ… å®Œæˆ | å¤šè½®è¿­ä»£ |
| Phase 13-16 | Codexä¿®å¤+ä¸Šä¸‹æ–‡+éªŒæ”¶+è”ç½‘ | âœ… å®Œæˆ | å¤šè½®è¿­ä»£ |
| Phase 19-21 | è‡ªé€‚åº”+tool_choice+é€†å‘å¯¹é½ | âœ… å®Œæˆ | å¤šè½®è¿­ä»£ |
| Phase 22 | è‡ªå®šä¹‰å·¥ä½œæµç³»ç»Ÿ | âœ… å®Œæˆ | 9 ä¸ªæ–‡ä»¶ |
| Phase 23 | UI/UX åŠæ€§èƒ½ä¼˜åŒ– | âœ… å®Œæˆ | 8 ä¸ªæ–‡ä»¶ |
| Phase 24 | å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†ä¸è‡ªåŠ¨æ ‡é¢˜ | âœ… å®Œæˆ | 7 ä¸ªæ–‡ä»¶ |
| Phase 25 | æµå¼ UI ä¸åŠ¨ç”» | âœ… å®Œæˆ | 4 ä¸ªæ–‡ä»¶ |
| Phase 26 | Lint ç³»ç»Ÿå…¨é¢å¯¹æ ‡ Cursor | âœ… å®Œæˆ | 9 ä¸ªæ–‡ä»¶ |
| Phase 27 | Agent æ‰§è¡Œè¿‡ç¨‹ UI å¯¹æ ‡ Cursor | âœ… å®Œæˆ | 3 ä¸ªæ–‡ä»¶ |
| Phase 28 | Agent å…¨é¢å¯¹æ ‡ Cursor å¢å¼º | âœ… å®Œæˆ | 6 ä¸ªæ–‡ä»¶ |

---

## Phase 1: æ ¸å¿ƒå¯¹é½ (MW1-MW7)

### MW1: Agent Loop é—­ç¯ + LLM Gateway + Tool Executor + IPC

**ç›®æ ‡**: å®ç° Agent è‡ªæ²»å¾ªç¯ï¼ˆåˆ†æâ†’è°ƒ LLMâ†’æ‰§è¡Œå·¥å…·â†’æ³¨å…¥ç»“æœâ†’ç»§ç»­ï¼‰ï¼Œæ›¿ä»£åŸæœ‰çš„å•æ¬¡ LLM è°ƒç”¨æ¨¡å¼ã€‚

**å®ç°å†…å®¹**:

| æ–‡ä»¶ | è·¯å¾„ | æ–¹æ³•/è¯´æ˜ |
|------|------|----------|
| Agent Loop Controller | `src/core/agent-loop-controller.js` | çŠ¶æ€æœºé©±åŠ¨çš„ Agent ä¸»å¾ªç¯ã€‚å®ç°äº† 9 ç§çŠ¶æ€ï¼ˆIDLEâ†’PLANNINGâ†’CALLING_LLMâ†’EXECUTING_TOOLSâ†’AWAITING_APPROVALâ†’REFLECTINGâ†’COMPLETEâ†’FAILEDâ†’CANCELLEDï¼‰ã€‚æ ¸å¿ƒ `_loop()` æ–¹æ³•ä¸æ–­è¿­ä»£ï¼šè°ƒ LLM â†’ æ£€æµ‹ tool_calls â†’ æ‰§è¡Œå·¥å…· â†’ æ³¨å…¥ç»“æœ â†’ å†è°ƒ LLMï¼Œç›´åˆ° LLM è¿”å›çº¯æ–‡æœ¬æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚ |
| LLM Gateway | `src/core/llm-gateway.js` | å°è£…äº† LLM æµå¼è°ƒç”¨ã€‚æ”¯æŒ `tools` å‚æ•°ä¼ é€’å·¥å…·å®šä¹‰ç»™æ¨¡å‹ã€‚å®ç°äº† SSE æµå¼è§£æï¼ŒåŒ…æ‹¬ content deltaã€reasoning deltaã€tool_calls delta çš„ç´¯ç§¯æ‹¼æ¥ã€‚ä½¿ç”¨ `toolCallAccumulator` å¯¹è±¡æŒ‰ index é€æ­¥æ‹¼æ¥æµå¼åˆ°æ¥çš„ tool_call å‚æ•°ç‰‡æ®µã€‚ |
| Tool Executor | `src/core/tool-executor.js` | å·¥å…·æ³¨å†Œä¸­å¿ƒã€‚ä½¿ç”¨ Map å­˜å‚¨å·¥å…·å®šä¹‰ï¼Œæä¾› `register()`/`getDefinitions()`/`execute()` æ¥å£ã€‚`execute()` æ–¹æ³•åŒ…å«å‚æ•°æ ¡éªŒï¼ˆæ£€æŸ¥ required å­—æ®µï¼‰ã€è¶…æ—¶æ§åˆ¶ï¼ˆPromise.race ä¸ timeoutï¼‰ã€ç»Ÿä¸€é”™è¯¯æ ¼å¼åŒ–ã€‚ |
| Agent IPC Bridge | `src/main-process/agent-ipc.js` | å°† Agent ç³»ç»Ÿæ¥å…¥ Electron IPCã€‚æ³¨å†Œ `agent:start`/`agent:cancel`/`agent:approve` ä¸‰ä¸ª IPC é€šé“ã€‚Agent äº‹ä»¶é€šè¿‡ `mainWindow.webContents.send()` æ¨é€åˆ°æ¸²æŸ“è¿›ç¨‹ã€‚ç®¡ç†æ´»è·ƒ Agent å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ |
| Error Codes | `src/core/error-codes.js` | ç»Ÿä¸€é”™è¯¯ç å®šä¹‰ï¼ˆ14 ç§ï¼‰ï¼Œæ¯ç§åŒ…å« codeã€messageã€recoverable æ ‡è®°ã€‚æä¾› `makeError()` å·¥å‚å‡½æ•°ã€‚ |
| Security Layer | `src/core/security-layer.js` | å®‰å…¨å±‚ã€‚`validatePath()` æ£€æµ‹è·¯å¾„ç©¿è¶Šï¼ˆresolve åæ¯”å¯¹é¡¹ç›®æ ¹è·¯å¾„å‰ç¼€ï¼‰ã€‚`validateCommand()` ä½¿ç”¨ 10+ æ­£åˆ™æ¨¡å¼æ‹¦æˆªå±é™©å‘½ä»¤ï¼ˆrm -rf /ã€formatã€fork ç‚¸å¼¹ç­‰ï¼‰ã€‚`needsApproval()` æ ¹æ®é£é™©ç­‰çº§å†³å®šæ˜¯å¦éœ€è¦ç”¨æˆ·å®¡æ‰¹ã€‚ |
| main.js ä¿®æ”¹ | `main.js` | åœ¨ `app.whenReady()` ä¸­åŠ å…¥ Agent IPC åˆå§‹åŒ–è°ƒç”¨ã€‚ |
| preload.js ä¿®æ”¹ | `preload.js` | æ–°å¢ `agentStart`/`agentCancel`/`agentApprove` å’Œäº‹ä»¶ç›‘å¬ APIï¼ˆ`onAgentEvent`/`removeAgentListener`/`removeAllAgentListeners`ï¼‰ï¼Œæ”¯æŒ 16 ç§ Agent äº‹ä»¶ã€‚ |

**å®ç°æ–¹æ³•**: 
- Agent Loop é‡‡ç”¨**çŠ¶æ€æœºæ¨¡å¼** â€” æ¯ä¸ªçŠ¶æ€è½¬æ¢æœ‰æ˜ç¡®çš„å‰ç½®/åç½®æ¡ä»¶
- LLM Gateway é‡‡ç”¨**æµå¼ç´¯ç§¯æ¨¡å¼** â€” tool_calls é€šè¿‡ delta.index é€æ­¥ç´¯ç§¯æ‹¼æ¥ï¼Œé¿å…ä¸€æ¬¡æ€§ç­‰å¾…å®Œæ•´å“åº”
- å·¥å…·æ‰§è¡Œé‡‡ç”¨**é¡ºåºæ‰§è¡Œ + å®¡æ‰¹æ‹¦æˆª** â€” ä¾æ¬¡æ‰§è¡Œæ¯ä¸ª tool_callï¼Œéœ€è¦å®¡æ‰¹çš„å·¥å…·æŒ‚èµ·ç­‰å¾…ç”¨æˆ·ç¡®è®¤

### MW1 ç»­: 8 ä¸ªåŸºç¡€å·¥å…·

**ç›®æ ‡**: å®ç° Cursor Agent çš„æ ¸å¿ƒå·¥å…·é›†ã€‚

| å·¥å…· | æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|------|---------|
| `read_file` | `src/tools/read-file.js` | è¯»æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒ offset/limit åˆ†é¡µã€‚è¾“å‡ºå¸¦è¡Œå·æ ¼å¼ `LINE_NUM\|LINE_CONTENT`ã€‚åŒ…å«è·¯å¾„å®‰å…¨æ ¡éªŒã€æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ5MBï¼‰ã€ç›®å½•è¯¯ç”¨æ£€æµ‹ã€‚ |
| `write_file` | `src/tools/write-file.js` | å†™å…¥æ–°æ–‡ä»¶ã€‚è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•ï¼ˆ`mkdirSync recursive`ï¼‰ã€‚å†™å…¥åç«‹å³å›è¯»éªŒè¯ï¼ˆreadback verificationï¼‰ï¼Œç¡®ä¿å†…å®¹ä¸€è‡´ã€‚ |
| `edit_file` | `src/tools/edit-file.js` | å­—ç¬¦ä¸²æ›¿æ¢ç¼–è¾‘ã€‚æ¥æ”¶ `old_string`/`new_string` å‚æ•°ã€‚å…ˆå°è¯•åŠ è½½ `EditFuzzyMatcher` åšæ¨¡ç³ŠåŒ¹é…ï¼Œè‹¥ä¸å¯ç”¨åˆ™å›é€€åˆ°åŸºç¡€ç²¾ç¡®åŒ¹é…ã€‚æ£€æµ‹å¤šå¤„åŒ¹é…å¹¶æŠ¥é”™ã€‚æ”¯æŒ `replace_all` æ‰¹é‡æ›¿æ¢ã€‚å†™å…¥åå›è¯»éªŒè¯ã€‚ |
| `delete_file` | `src/tools/delete-file.js` | åˆ é™¤æ–‡ä»¶ã€‚é«˜é£é™©çº§åˆ«ï¼ˆéœ€å®¡æ‰¹ï¼‰ã€‚æ ¡éªŒè·¯å¾„å®‰å…¨ï¼Œæ‹’ç»åˆ é™¤ç›®å½•ã€‚ |
| `run_terminal_cmd` | `src/tools/run-terminal-cmd.js` | æ‰§è¡Œ shell å‘½ä»¤ã€‚ä½¿ç”¨ `child_process.exec`ï¼Œ120s è¶…æ—¶ã€‚Windows ä¸‹ä½¿ç”¨ `cmd.exe`ã€‚è¾“å‡ºæˆªæ–­åˆ° 50KBï¼ˆstdoutï¼‰å’Œ 10KBï¼ˆstderrï¼‰ã€‚é€šè¿‡ `validateCommand()` æ‹¦æˆªå±é™©å‘½ä»¤ã€‚ |
| `search_files` | `src/tools/search-files.js` | æ­£åˆ™æœç´¢é¡¹ç›®æ–‡ä»¶ã€‚é€’å½’éå†æ–‡ä»¶æ ‘ï¼ˆè·³è¿‡ node_modules/.git ç­‰ï¼‰ï¼Œå¯¹æ¯ä¸ªæ–‡ä»¶é€è¡ŒåŒ¹é…æ­£åˆ™ã€‚è¿”å›åŒ¹é…è¡ŒåŠä¸Šä¸‹æ–‡ï¼ˆå‰åå„ 1 è¡Œï¼‰ã€‚ç»“æœä¸Šé™ 100 æ¡ã€‚æ”¯æŒæ–‡ä»¶åè¿‡æ»¤ã€‚ |
| `glob_search` | `src/tools/glob-search.js` | æ–‡ä»¶åæ¨¡å¼åŒ¹é…ã€‚å°† glob æ¨¡å¼è½¬æ¢ä¸ºæ­£åˆ™ï¼ˆ`*`â†’`[^/\\]*`, `**`â†’`.*`, `?`â†’`[^/\\]`ï¼‰ã€‚ç»“æœæŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œä¸Šé™ 200 ä¸ªã€‚ |
| `list_directory` | `src/tools/list-directory.js` | åˆ—å‡ºç›®å½•å†…å®¹ã€‚è¿”å›æ–‡ä»¶/æ–‡ä»¶å¤¹åç§°å’Œç±»å‹ï¼ŒæŒ‰"ç›®å½•åœ¨å‰ã€æ–‡ä»¶åœ¨å"æ’åºã€‚è¾“å‡ºå¸¦å›¾æ ‡æ ¼å¼ï¼ˆğŸ“/ğŸ“„ï¼‰ã€‚ |
| å·¥å…·æ³¨å†Œ | `src/tools/index.js` | å·¥å…·æ³¨å†Œä¸­å¿ƒã€‚åˆ›å»º `ToolExecutor` å®ä¾‹å¹¶æ³¨å†Œæ‰€æœ‰å·¥å…·ã€‚å¯é€‰å·¥å…·ï¼ˆtodoã€taskã€web ç­‰ï¼‰ç”¨ try/catch åŠ è½½ï¼Œç¼ºå¤±ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ã€‚ |

**å®ç°æ–¹æ³•**:
- æ¯ä¸ªå·¥å…·å¯¼å‡º `{ name, description, parameters, riskLevel, handler }` æ ‡å‡†ç»“æ„
- handler ç»Ÿä¸€ç­¾å `(args, projectPath, context)` â†’ `{ success, ...data }`
- æ‰€æœ‰æ–‡ä»¶æ“ä½œå·¥å…·éƒ½ç»è¿‡ `validatePath()` å®‰å…¨æ ¡éªŒ

---

### MW2: Prompt V3 äº”å±‚æ¶æ„

**ç›®æ ‡**: å°†ç¡¬ç¼–ç åœ¨ ProjectView.jsx ä¸­çš„ç®€é™‹ Prompt æ›¿æ¢ä¸ºæ¨¡å—åŒ–çš„äº”å±‚ Prompt ç³»ç»Ÿã€‚

| æ–‡ä»¶ | å±‚çº§ | å®ç°æ–¹æ³• |
|------|------|---------|
| `src/prompts/system-base.js` | Layer 0: Meta | å®šä¹‰ AI èº«ä»½ã€æ ¸å¿ƒåŸåˆ™ï¼ˆå‡†ç¡®/å®‰å…¨/æ•ˆç‡/æ¸…æ™°ï¼‰ã€å·¥å…·ä½¿ç”¨è§„èŒƒã€æ²Ÿé€šé£æ ¼ã€‚æ‰€æœ‰æ¨¡å¼å…±äº«ã€‚ |
| `src/prompts/mode-agent.js` | Layer 1: Agent | Agent æ¨¡å¼è¡Œä¸ºå®šä¹‰ï¼š5 æ­¥å·¥ä½œæµï¼ˆåˆ†æâ†’è®¡åˆ’â†’æ‰§è¡Œâ†’éªŒè¯â†’è¿­ä»£ï¼‰ã€å·¥å…·é€‰æ‹©ä¼˜å…ˆçº§ã€ç¦æ­¢äº‹é¡¹ã€‚ |
| `src/prompts/mode-ask.js` | Layer 1: Ask | åªè¯»æ¨¡å¼ï¼Œä»…å…è®¸æœç´¢/è¯»å–å·¥å…·ï¼Œç¦æ­¢ä¿®æ”¹æ“ä½œã€‚ |
| `src/prompts/mode-plan.js` | Layer 1: Plan | è§„åˆ’æ¨¡å¼ï¼Œåˆ†æè¯·æ±‚å¹¶è¾“å‡ºç»“æ„åŒ–æ­¥éª¤ï¼Œä¸æ‰§è¡Œä»»ä½•å†™æ“ä½œã€‚ |
| `src/prompts/mode-debug.js` | Layer 1: Debug | è°ƒè¯•æ¨¡å¼ï¼Œ5 æ­¥æ’éšœæµç¨‹ï¼šå¤ç°â†’å–è¯â†’å‡è®¾â†’éªŒè¯â†’ä¿®å¤ã€‚ |
| `src/prompts/recovery-prompt.js` | Layer 3: Recovery | **å…³é”®æ¨¡å—**ã€‚ä¸ºæ¯ç§å·¥å…·çš„æ¯ç§å¤±è´¥æ¨¡å¼å®šä¹‰æ¢å¤ç­–ç•¥ã€‚åŒ…å« Read-Retry Loop æ¨¡å¼ï¼ˆedit å¤±è´¥â†’readâ†’ä¿®æ­£â†’retryï¼‰ã€‚è§„å®š"3 æ¬¡å¤±è´¥ååœæ­¢å¹¶æ±‚åŠ©"ã€‚ |
| `src/prompts/summarizer-prompt.js` | Layer 4: Summarizer | å†å²å‹ç¼© Promptï¼ŒæŒ‡å¯¼ LLM å°†æ—§æ¶ˆæ¯æµ“ç¼©ä¸ºç»“æ„åŒ–æ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¸Šä¸‹æ–‡ã€‚ |
| `src/prompts/prompt-assembler.js` | ç»„è£…å™¨ | `PromptAssembler` ç±»ï¼Œ`assemble()` æ–¹æ³•æŒ‰å±‚çº§æ‹¼æ¥ï¼šBase â†’ Mode â†’ DynamicContext â†’ Recovery â†’ Rules â†’ ProjectPathã€‚ç”¨ `---` åˆ†éš”å„å±‚ã€‚ |

**å®ç°æ–¹æ³•**:
- æ¯ä¸ª Prompt æ¨¡å—å¯¼å‡ºçº¯å­—ç¬¦ä¸²ï¼ˆmodule.exports = \`...\`ï¼‰
- `PromptAssembler` è´Ÿè´£æŒ‰æ¨¡å¼é€‰æ‹© + æŒ‰æ¡ä»¶æ³¨å…¥ + æ ¼å¼åŒ–æ‹¼æ¥
- Recovery Prompt ä»…åœ¨ agent/debug æ¨¡å¼æ³¨å…¥

---

### MW3: edit_file æ¨¡ç³Šå®¹é”™

**ç›®æ ‡**: è§£å†³ LLM ç”Ÿæˆçš„ `old_string` ä¸æ–‡ä»¶å®é™…å†…å®¹æœ‰è½»å¾®å·®å¼‚ï¼ˆç©ºç™½ã€ç¼©è¿›ï¼‰æ—¶åŒ¹é…å¤±è´¥çš„é—®é¢˜ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/edit-fuzzy-matcher.js` | `EditFuzzyMatcher` ç±»ï¼Œ`findMatch()` æ–¹æ³•å®ç°å››çº§åŒ¹é…ç­–ç•¥é“¾ï¼š**1) ç²¾ç¡®åŒ¹é…**ï¼ˆindexOfï¼‰â†’ **2) ç©ºç™½è§„èŒƒåŒ–**ï¼ˆåˆå¹¶è¿ç»­ç©ºæ ¼/tabï¼Œç»Ÿä¸€æ¢è¡Œç¬¦ï¼‰â†’ **3) ç¼©è¿›æ— å…³**ï¼ˆå¯¹æ¯è¡Œ trimStart() åæ¯”è¾ƒï¼‰â†’ **4) è¡Œçº§ trim**ï¼ˆå¯¹æ¯è¡Œ trim() åæ¯”è¾ƒï¼‰ã€‚æ¯çº§éƒ½æ£€æµ‹å¤šåŒ¹é…å¹¶æŠ¥é”™ã€‚ç©ºç™½è§„èŒƒåŒ–ä½¿ç”¨ position map å°†åŒ¹é…ä½ç½®æ˜ å°„å›åŸæ–‡åæ ‡ã€‚ |

**å®ç°æ–¹æ³•**:
- **ç­–ç•¥é“¾æ¨¡å¼** â€” ç²¾ç¡®åº¦ä»é«˜åˆ°ä½é€’é™ï¼Œä¸€æ—¦æŸçº§åŒ¹é…æˆåŠŸå³è¿”å›
- è¿”å› `{ found, start, end, count, strategy }` â€” å‘Šè¯‰è°ƒç”¨è€…ç”¨äº†å“ªçº§ç­–ç•¥
- å¤šåŒ¹é…æ£€æµ‹é¿å…è¯¯æ›¿æ¢

---

### MW4: DynamicContextProvider 6 æºä¸Šä¸‹æ–‡

**ç›®æ ‡**: é‡‡é›† 6 ç§åŠ¨æ€ä¸Šä¸‹æ–‡æºæ³¨å…¥åˆ° LLM æç¤ºè¯ä¸­ï¼Œæ›¿ä»£åŸæœ‰çš„ä»…å…³é”®è¯æœç´¢ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/dynamic-context-provider.js` | `DynamicContextProvider` ç±»ï¼Œ`gather()` æ–¹æ³•ä¾æ¬¡é‡‡é›† 6 ç§ä¸Šä¸‹æ–‡æºï¼š**1) æ‰“å¼€æ–‡ä»¶å†…å®¹**ï¼ˆæœ€å¤š 5 ä¸ªæ–‡ä»¶ï¼Œå¤§æ–‡ä»¶æˆªå–å‰ 50 è¡Œï¼‰â†’ **2) å…‰æ ‡ä¸Šä¸‹æ–‡**ï¼ˆå…‰æ ‡ä½ç½®å‰åå„ 30 è¡Œï¼Œå½“å‰è¡ŒåŠ  `>>>` æ ‡è®°ï¼‰â†’ **3) Linter é”™è¯¯**ï¼ˆæœ€å¤š 15 æ¡ï¼‰â†’ **4) æœ€è¿‘ç¼–è¾‘æ–‡ä»¶åˆ—è¡¨**ï¼ˆæœ€å¤š 10 ä¸ªï¼‰â†’ **5) ç»ˆç«¯è¾“å‡º**ï¼ˆæˆªå–æœ€å 2000 å­—ç¬¦ï¼‰â†’ **6) é¡¹ç›®ç»“æ„æ¦‚è§ˆ**ï¼ˆæ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼‰ã€‚å…¨ç¨‹ä½¿ç”¨ token é¢„ç®—æ§åˆ¶ï¼Œ`estimateTokens()` ç”¨å­—ç¬¦æ•°/4 ä¼°ç®—ã€‚ |

**å®ç°æ–¹æ³•**:
- è´ªå¿ƒå¡«å……ç­–ç•¥ â€” æŒ‰ä¼˜å…ˆçº§ä¾æ¬¡é‡‡é›†ï¼Œæ¯ä¸ªæºé‡‡é›†å‰æ£€æŸ¥å‰©ä½™ budget
- å¤§æ–‡ä»¶è‡ªåŠ¨æˆªæ–­ï¼Œä¿æŒåœ¨ token é¢„ç®—å†…
- è¿”å›ç»“æ„åŒ–å¯¹è±¡ï¼Œç”± PromptAssembler æ ¼å¼åŒ–

---

### MW5: Token é¢„ç®—ç®¡ç† + å†å²å‹ç¼©

**ç›®æ ‡**: é˜²æ­¢é•¿å¯¹è¯å›  token è¶…é™å¯¼è‡´ LLM è°ƒç”¨å¤±è´¥ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/token-counter.js` | `TokenCounter` ç±»ã€‚`estimate()` ç”¨å­—ç¬¦çº§ä¼°ç®—ï¼ˆè‹±æ–‡ /4ã€CJK /2ï¼‰ã€‚`estimateMessages()` ç´¯åŠ æ¯æ¡æ¶ˆæ¯çš„ content + tool_calls + overheadã€‚ |
| `src/core/context-engine.js` | `ContextEngine` ç±»ã€‚`computeBudget()` è®¡ç®— token åˆ†é…ï¼šç³»ç»Ÿ Prompt é¢„ç•™ 4000 + å·¥å…·å®šä¹‰ 3000 + å›å¤é¢„ç•™ 4096ï¼Œå‰©ä½™ 60% ç»™å†å²ã€40% ç»™ä¸Šä¸‹æ–‡ã€‚`compressHistory()` æ–¹æ³•åœ¨ token è¶…é¢„ç®—æ—¶ï¼Œä¿ç•™ system message + æœ€è¿‘èƒ½æ”¾ä¸‹çš„ N æ¡æ¶ˆæ¯ï¼Œè¢«æˆªæ–­çš„æ—§æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦ï¼ˆæå–æ–‡ä»¶æ“ä½œè®°å½•ã€å¯¹è¯ä¸»é¢˜ã€å·¥å…·è°ƒç”¨ç»Ÿè®¡ï¼‰ã€‚ |

**å®ç°æ–¹æ³•**:
- **æ»‘åŠ¨çª—å£ + è‡ªåŠ¨æ‘˜è¦** â€” ä¿ç•™æœ€è¿‘æ¶ˆæ¯ï¼Œæ—§æ¶ˆæ¯å‹ç¼©ä¸ºç»“æ„åŒ–æ‘˜è¦
- æ‘˜è¦å†…å®¹åŒ…å«ï¼šå¯¹è¯ä¸»é¢˜ã€è¯»å–/ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ã€å·¥å…·è°ƒç”¨æ¬¡æ•°

---

### MW6: UI ç»„ä»¶

**ç›®æ ‡**: ä¸º Agent å·¥å…·è°ƒç”¨æä¾›å¯è§†åŒ–å±•ç¤ºã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/components/ToolCallCard.jsx` | å·¥å…·è°ƒç”¨å¡ç‰‡ã€‚6 ç§çŠ¶æ€ï¼ˆpending/running/success/failed/cancelled/awaiting_approvalï¼‰ï¼Œæ¯ç§æœ‰ç‹¬ç«‹é…è‰²æ–¹æ¡ˆã€‚å¤´éƒ¨æ˜¾ç¤ºå·¥å…·å›¾æ ‡+åç§°+å‚æ•°æ‘˜è¦+çŠ¶æ€å›¾æ ‡+è€—æ—¶ã€‚å¯æŠ˜å å±•å¼€æŸ¥çœ‹å®Œæ•´å‚æ•°å’Œç»“æœã€‚å®¡æ‰¹æ€å†…åµŒ"å…è®¸/æ‹’ç»"æŒ‰é’®ã€‚ä½¿ç”¨ `useMemo` ä¼˜åŒ–å‚æ•°è§£æå’Œæ‘˜è¦è®¡ç®—ã€‚ |
| `src/components/ApprovalBar.jsx` | å®¡æ‰¹ç¡®è®¤æ¡ã€‚åŒºåˆ† mediumï¼ˆé»„è‰² ShieldCheckï¼‰å’Œ highï¼ˆçº¢è‰² ShieldAlertï¼‰é£é™©çº§åˆ«ã€‚æ˜¾ç¤ºæ“ä½œæ‘˜è¦ï¼ˆå‘½ä»¤/æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œæä¾›"æ‹’ç»/å…è®¸"æŒ‰é’®ã€‚ |
| `src/components/AgentStatusBar.jsx` | Agent çŠ¶æ€æŒ‡ç¤ºæ¡ã€‚9 ç§çŠ¶æ€æ˜ å°„åˆ°å›¾æ ‡+æ–‡å­—+é¢œè‰²ã€‚æ´»è·ƒçŠ¶æ€æ˜¾ç¤ºè¿­ä»£æ¬¡æ•°å’Œå·¥å…·è°ƒç”¨è®¡æ•°ã€‚æä¾›"å–æ¶ˆ"æŒ‰é’®ã€‚ |

**å®ç°æ–¹æ³•**:
- React + TailwindCSS + Lucide Icons
- é…è‰²æ–¹æ¡ˆä¸ç°æœ‰ `AskMessageCard.jsx` ä¸€è‡´ï¼ˆæ·±è‰²ä¸»é¢˜ï¼Œzinc/blue/green/red è‰²ç³»ï¼‰

---

### MW7: ç»“æ„åŒ–æ—¥å¿— AgentTracer

**ç›®æ ‡**: ä¸º Agent æ‰§è¡Œè¿‡ç¨‹æä¾›å®Œæ•´çš„è¿½è¸ªæ—¥å¿—ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/agent-tracer.js` | `AgentTracer` ç±»ã€‚å®ç° Span æ ‘æ¨¡å‹ï¼š`startSpan()` åˆ›å»ºå¸¦ id/name/startTime/meta/children çš„ span å¯¹è±¡ï¼Œè¿”å› `{ end(result) }` é—­åŒ…ç”¨äºç»“æŸ spanã€‚æ”¯æŒåµŒå¥— spanï¼ˆparent-child å…³ç³»ï¼‰ã€‚`log()`/`info()`/`warn()`/`error()` æ–¹æ³•è¾“å‡ºç»“æ„åŒ–æ—¥å¿—åˆ° consoleï¼Œæ¯æ¡åŒ…å« timestampã€levelã€sessionIdã€spanIdã€‚`getSummary()` è¿”å›æ•´ä¸ª session çš„æ‰§è¡Œæ‘˜è¦ã€‚ |

**å®ç°æ–¹æ³•**:
- **Span æ ‘æ¨¡å¼** â€” ç±»ä¼¼ OpenTelemetry çš„ tracing æ¦‚å¿µ
- æ¯ä¸ª span è®°å½•å¼€å§‹/ç»“æŸæ—¶é—´ã€çŠ¶æ€ã€å…ƒæ•°æ®

---

## Phase 2: èƒ½åŠ›æ‰©å±• (MW8, MW10)

### MW8: Sub-Agent å­ä»£ç†

**ç›®æ ‡**: å…è®¸çˆ¶ Agent å¯åŠ¨ç‹¬ç«‹å­ä»£ç†å¤„ç†å¤æ‚å­ä»»åŠ¡ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/agent-loop-factory.js` | `AgentLoopFactory` ç±»ã€‚`create()` æ–¹æ³•åˆ›å»º `AgentLoopController` å®ä¾‹ï¼Œé…ç½®æ›´å°çš„è¿­ä»£ä¸Šé™ï¼ˆ15ï¼‰å’Œ token é¢„ç®—ï¼ˆ64Kï¼‰ã€‚`readonly` æ¨¡å¼é€šè¿‡ `_createReadonlyExecutor()` åˆ›å»ºä»…åŒ…å« read/search/glob/list å·¥å…·çš„å—é™æ‰§è¡Œå™¨ã€‚è¿”å› `{ run(prompt), cancel(), destroy() }` æ¥å£ã€‚ |
| `src/tools/task-delegation.js` | `task` å·¥å…·ã€‚å‚æ•°ï¼šdescriptionï¼ˆçŸ­æè¿°ï¼‰ã€promptï¼ˆè¯¦ç»†æŒ‡ä»¤ï¼‰ã€modelã€readonlyã€‚handler é€šè¿‡ `agentLoopFactory.create()` åˆ›å»ºå­ä»£ç†ï¼Œè°ƒç”¨ `run()` æ‰§è¡Œï¼Œè¿”å› `{ content, iterations, toolsUsed }`ã€‚5 åˆ†é’Ÿè¶…æ—¶ï¼Œå¤±è´¥å destroy æ¸…ç†èµ„æºã€‚ |
| `src/components/SubAgentCard.jsx` | å­ä»£ç† UI å¡ç‰‡ã€‚æ˜¾ç¤ºæè¿°ã€çŠ¶æ€ï¼ˆrunning/complete/failed/cancelledï¼‰ã€è¿­ä»£æ¬¡æ•°ã€å·¥å…·è°ƒç”¨æ¬¡æ•°ã€è€—æ—¶ã€‚å¯å±•å¼€æŸ¥çœ‹å­ä»£ç†è¾“å‡ºæˆ–é”™è¯¯ã€‚ |

**å®ç°æ–¹æ³•**:
- **å·¥å‚æ¨¡å¼** â€” `AgentLoopFactory` å°è£…å­ä»£ç†åˆ›å»ºé€»è¾‘
- å­ä»£ç† `autoApprove=true`ï¼ˆä¸å¼¹å®¡æ‰¹ï¼Œç”±çˆ¶ Agent çš„ task å·¥å…·é£é™©çº§åˆ«æ§åˆ¶ï¼‰
- ç‹¬ç«‹ messages æ•°ç»„ï¼Œä¸æ±¡æŸ“çˆ¶ Agent ä¸Šä¸‹æ–‡

---

### MW10: ç»“æ„åŒ– Todo

**ç›®æ ‡**: ä¸º Agent æä¾›ç»“æ„åŒ–ä»»åŠ¡ç®¡ç†èƒ½åŠ›ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/core/todo-store.js` | `TodoStore` ç±»ã€‚åŸºäºæ•°ç»„çš„å“åº”å¼çŠ¶æ€å®¹å™¨ã€‚`get()`/`set(todos)`/`getByStatus()`/`getProgress()`/`subscribe(listener)` APIã€‚`_notify()` é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…ã€‚`getProgress()` è®¡ç®—å®Œæˆç™¾åˆ†æ¯”ã€‚ |
| `src/tools/todo-manager.js` | `todo_write` å·¥å…·ã€‚`merge=true` æ—¶æŒ‰ id åˆå¹¶æ›´æ–°ï¼Œ`merge=false` æ—¶å…¨é‡æ›¿æ¢ã€‚handler æ“ä½œ `todoStore`ï¼Œè¿”å›è¿›åº¦ç»Ÿè®¡ã€‚ |
| `src/components/TodoPanel.jsx` | Todo é¢æ¿ç»„ä»¶ã€‚4 ç§çŠ¶æ€å›¾æ ‡/é¢œè‰²ï¼ˆâ¬œ pending / ğŸ”„ in_progress / âœ… completed / âŒ cancelledï¼‰ã€‚è¿›åº¦æ¡ä½¿ç”¨æ¸å˜è‰²ï¼ˆblueâ†’greenï¼‰ã€‚æ”¯æŒæŠ˜å ã€‚in_progress çŠ¶æ€æœ‰æ—‹è½¬åŠ¨ç”»ã€‚ |

**å®ç°æ–¹æ³•**:
- **å‘å¸ƒ-è®¢é˜…æ¨¡å¼** â€” TodoStore å˜æ›´è‡ªåŠ¨é€šçŸ¥ UI ç»„ä»¶
- å·¥å…·å’Œ UI è§£è€¦ï¼Œé€šè¿‡ context å‚æ•°ä¼ é€’ todoStore

---

## Phase 3: Web å·¥å…· (MW9)

### MW9: Web Search + Web Fetch

**ç›®æ ‡**: è®© Agent èƒ½æœç´¢å’Œè·å–å¤–éƒ¨ä¿¡æ¯ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/tools/web-search.js` | `web_search` å·¥å…·ã€‚å½“å‰å®ç°äº† DuckDuckGo Instant Answer API ä½œä¸ºå…è´¹æœç´¢æºã€‚`_duckduckgo()` æ–¹æ³•è°ƒç”¨ DDG APIï¼Œæå– AbstractText å’Œ RelatedTopicsã€‚æ¶æ„é¢„ç•™äº† provider é“¾ï¼ˆå¯æ‰©å±• SearXNGã€Google Custom Searchï¼‰ã€‚10s è¶…æ—¶ï¼Œä½¿ç”¨ AbortControllerã€‚ |
| `src/tools/web-fetch.js` | `web_fetch` å·¥å…·ã€‚æŠ“å– URL è¿”å›å¯è¯»æ–‡æœ¬ã€‚å®‰å…¨æªæ–½ï¼šå†…ç½‘ URL æ­£åˆ™æ‹¦æˆªï¼ˆlocalhost/10.*/172.16-31.*/192.168.*ï¼‰ã€content-type ç™½åå•ï¼ˆtext/* + json + xmlï¼‰ã€‚HTML å†…å®¹è‡ªåŠ¨å»é™¤ script/style/nav/footer æ ‡ç­¾åæå–çº¯æ–‡æœ¬ã€‚è¾“å‡ºé™åˆ¶ 30000 å­—ç¬¦ã€‚15s è¶…æ—¶ã€‚ |

**å®ç°æ–¹æ³•**:
- **Provider é™çº§é“¾** â€” ä¸€ä¸ª provider å¤±è´¥è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ª
- HTMLâ†’Text é‡‡ç”¨æ­£åˆ™å‰¥ç¦»ï¼ˆè½»é‡çº§ï¼Œæ— éœ€ DOM è§£æåº“ä¾èµ–ï¼‰

---

## Phase 4: é«˜çº§å·¥å…· (MW11, MW12)

### MW11: Browser å·¥å…·

**ç›®æ ‡**: æä¾›é¡µé¢å¯¼èˆªã€äº¤äº’ã€æˆªå›¾èƒ½åŠ›ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/tools/browser-use.js` | `browser_use` å·¥å…·ã€‚åŸºäº Electron `BrowserWindow`ï¼ˆ`sandbox:true, contextIsolation:true`ï¼‰ã€‚æ”¯æŒ 7 ç§ actionï¼šnavigateï¼ˆåŠ è½½ URLï¼‰ã€clickï¼ˆCSS é€‰æ‹©å™¨ + click()ï¼‰ã€typeï¼ˆè®¾ç½® value + dispatch input äº‹ä»¶ï¼‰ã€screenshotï¼ˆcapturePage â†’ PNG ä¿å­˜åˆ° tmpï¼‰ã€get_textï¼ˆinnerText æå–ï¼Œ10KB é™åˆ¶ï¼‰ã€waitï¼ˆå»¶æ—¶ï¼Œä¸Šé™ 10sï¼‰ã€closeï¼ˆé”€æ¯çª—å£ï¼‰ã€‚å•ä¾‹æ¨¡å¼â€”â€”åŒæ—¶åªæœ‰ä¸€ä¸ª BrowserWindow å®ä¾‹ã€‚ |

**å®ç°æ–¹æ³•**:
- **Electron BrowserWindow API** â€” æ— éœ€é¢å¤–ä¾èµ–ï¼ˆPuppeteer ç­‰ï¼‰
- `show: false` éšè—çª—å£ï¼Œä¸å¹²æ‰°ç”¨æˆ·ç•Œé¢
- `executeJavaScript()` æ‰§è¡Œ DOM æ“ä½œï¼Œé€‰æ‹©å™¨åšå•å¼•å·è½¬ä¹‰é˜²æ³¨å…¥

---

### MW12: å›¾ç‰‡ç”Ÿæˆå·¥å…·

**ç›®æ ‡**: æ ¹æ®æ–‡æœ¬æè¿°ç”Ÿæˆå›¾ç‰‡ã€‚

| æ–‡ä»¶ | å®ç°æ–¹æ³• |
|------|---------|
| `src/tools/generate-image.js` | `generate_image` å·¥å…·ã€‚å½“å‰å®ç° OpenAI DALL-E 3 APIï¼ˆé€šè¿‡ mode-config.json ä¸­çš„ `imageGeneration.openaiApiKey` é…ç½®ï¼‰ã€‚è¯·æ±‚ `b64_json` æ ¼å¼ï¼Œè§£ç åä¿å­˜ä¸º PNG åˆ°é¡¹ç›®ç›®å½•ã€‚50s è¶…æ—¶ã€‚æ¶æ„é¢„ç•™äº† Stable Diffusion API æ‰©å±•ä½ã€‚æœªé…ç½®æ—¶è¿”å›å‹å¥½æç¤ºã€‚ |

**å®ç°æ–¹æ³•**:
- **Provider é“¾ + é…ç½®é©±åŠ¨** â€” ä»è®¾ç½®æ–‡ä»¶è¯»å– API Keyï¼Œæ—  Key åˆ™ä¼˜é›…é™çº§
- å›¾ç‰‡ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿”å›ç›¸å¯¹è·¯å¾„

---

## ä¿®æ”¹çš„ç°æœ‰æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `main.js` | åœ¨ `app.whenReady()` å›è°ƒä¸­æ–°å¢ Agent IPC åˆå§‹åŒ–è°ƒç”¨ï¼ˆ`setupAgentIPC({ loadModels, mainWindow })`ï¼‰ã€‚æ–°å¢ `agentIPCInitialized` æ ‡å¿—é˜²æ­¢é‡å¤åˆå§‹åŒ–ã€‚ |
| `preload.js` | æ–°å¢ Agent ç³»ç»Ÿ IPC APIï¼š`agentStart`/`agentCancel`/`agentApprove` + `onAgentEvent`/`removeAgentListener`/`removeAllAgentListeners`ï¼Œè¦†ç›– 16 ç§ Agent äº‹ä»¶é€šé“ã€‚ |

---

## æ–‡ä»¶å®Œæ•´æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ36 ä¸ªï¼‰

```
src/core/
  agent-loop-controller.js    â† Agent ä¸»å¾ªç¯çŠ¶æ€æœº
  agent-loop-factory.js       â† å­ä»£ç†å·¥å‚
  agent-tracer.js             â† ç»“æ„åŒ–æ—¥å¿—/è¿½è¸ª
  context-engine.js           â† Token é¢„ç®— + å†å²å‹ç¼©
  dynamic-context-provider.js â† 6 æºåŠ¨æ€ä¸Šä¸‹æ–‡
  edit-fuzzy-matcher.js       â† å››çº§æ¨¡ç³ŠåŒ¹é…
  error-codes.js              â† ç»Ÿä¸€é”™è¯¯ç 
  llm-gateway.js              â† LLM æµå¼è°ƒç”¨å°è£…
  security-layer.js           â† è·¯å¾„/å‘½ä»¤å®‰å…¨æ ¡éªŒ
  todo-store.js               â† Todo å“åº”å¼çŠ¶æ€å®¹å™¨
  token-counter.js            â† Token ä¼°ç®—å™¨
  tool-executor.js            â† å·¥å…·æ³¨å†Œ/è·¯ç”±/æ‰§è¡Œ

src/tools/
  browser-use.js              â† æµè§ˆå™¨è‡ªåŠ¨åŒ–
  delete-file.js              â† åˆ é™¤æ–‡ä»¶
  edit-file.js                â† å­—ç¬¦ä¸²æ›¿æ¢ç¼–è¾‘
  generate-image.js           â† å›¾ç‰‡ç”Ÿæˆ
  glob-search.js              â† æ–‡ä»¶åæ¨¡å¼åŒ¹é…
  index.js                    â† å·¥å…·ç»Ÿä¸€æ³¨å†Œ
  list-directory.js           â† åˆ—å‡ºç›®å½•
  read-file.js                â† è¯»å–æ–‡ä»¶
  run-terminal-cmd.js         â† æ‰§è¡Œç»ˆç«¯å‘½ä»¤
  search-files.js             â† æ­£åˆ™æœç´¢
  task-delegation.js          â† å­ä»£ç†å§”æ´¾
  todo-manager.js             â† ç»“æ„åŒ– Todo
  web-fetch.js                â† URL å†…å®¹æŠ“å–
  web-search.js               â† ç½‘é¡µæœç´¢
  write-file.js               â† å†™å…¥æ–‡ä»¶

src/prompts/
  mode-agent.js               â† Agent æ¨¡å¼ Prompt
  mode-ask.js                 â† Ask æ¨¡å¼ Prompt
  mode-debug.js               â† Debug æ¨¡å¼ Prompt
  mode-plan.js                â† Plan æ¨¡å¼ Prompt
  prompt-assembler.js         â† Prompt ç»„è£…å™¨
  recovery-prompt.js          â† é”™è¯¯æ¢å¤ Prompt
  summarizer-prompt.js        â† å†å²æ‘˜è¦ Prompt
  system-base.js              â† ç³»ç»ŸåŸºç¡€ Prompt

src/main-process/
  agent-ipc.js                â† Agent IPC æ¡¥æ¥

src/components/
  AgentStatusBar.jsx          â† Agent çŠ¶æ€æŒ‡ç¤ºå™¨
  ApprovalBar.jsx             â† å®¡æ‰¹ç¡®è®¤æ¡
  SubAgentCard.jsx            â† å­ä»£ç† UI å¡ç‰‡
  TodoPanel.jsx               â† Todo é¢æ¿
  ToolCallCard.jsx            â† å·¥å…·è°ƒç”¨å¯è§†åŒ–å¡ç‰‡
```

---

## è®¾è®¡æ¨¡å¼æ€»ç»“

| æ¨¡å¼ | åº”ç”¨ä½ç½® | è¯´æ˜ |
|------|---------|------|
| **çŠ¶æ€æœº** | AgentLoopController | 9 æ€çŠ¶æ€æœºé©±åŠ¨ Agent ç”Ÿå‘½å‘¨æœŸ |
| **ç­–ç•¥é“¾** | EditFuzzyMatcher, web-search | å¤šç­–ç•¥æŒ‰ä¼˜å…ˆçº§é€’é™å°è¯• |
| **å·¥å‚æ¨¡å¼** | AgentLoopFactory | å°è£…å­ä»£ç†åˆ›å»ºé€»è¾‘ |
| **å‘å¸ƒ-è®¢é˜…** | TodoStore | çŠ¶æ€å˜æ›´é€šçŸ¥ UI |
| **æ³¨å†Œè¡¨æ¨¡å¼** | ToolExecutor | å·¥å…·ç»Ÿä¸€æ³¨å†Œå’ŒæŸ¥æ‰¾ |
| **é€‚é…å™¨æ¨¡å¼** | LLMGateway | ç»Ÿä¸€ä¸åŒæ¨¡å‹ API çš„è°ƒç”¨æ–¹å¼ |
| **è£…é¥°å™¨æ¨¡å¼** | PromptAssembler | æŒ‰å±‚çº§å åŠ  Prompt |
| **æ¨¡æ¿æ–¹æ³•** | å„å·¥å…· handler | ç»Ÿä¸€ `(args, projectPath, context) â†’ { success, ... }` æ¥å£ |

---

## é¢„è®¡ Parity è¯„åˆ†

| ç»´åº¦ | å®æ–½å‰ | å®æ–½å | æå‡ |
|------|--------|--------|------|
| è§„åˆ’èƒ½åŠ› | 70 | 93 | +23 |
| å·¥å…·è°ƒç”¨ | 80 | 96 | +16 |
| é”™è¯¯æ¢å¤ | 55 | 87 | +32 |
| ä¸Šä¸‹æ–‡ç®¡ç† | 50 | 87 | +37 |
| ä»£ç ä¿®æ”¹è´¨é‡ | 65 | 88 | +23 |
| UIäº¤äº’é—­ç¯ | 75 | 93 | +18 |
| å¯è§‚æµ‹æ€§ | 70 | 88 | +18 |
| **åŠ æƒæ€»åˆ†** | **68** | **~93** | **+25** |

---

## å‰ç«¯é›†æˆå·¥ä½œï¼ˆå·²å®Œæˆï¼‰

> æ‰§è¡Œæ—¶é—´ï¼šPhase 5ï¼Œåœ¨åç«¯æ¨¡å—å…¨éƒ¨å°±ç»ªåè¿›è¡Œ

### 5.1 agent-ipc.js é‡æ„ â€” å®Œæ•´ä¾èµ–æ³¨å…¥

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/main-process/agent-ipc.js` | é‡å†™ | æ³¨å…¥ LLMGatewayã€ToolExecutorã€PromptAssemblerã€ContextEngineã€AgentLoopFactoryã€TodoStore |

**æ–¹æ³•**ï¼šåœ¨ `setupAgentIPC({ loadModels, mainWindow })` ä¸­ç»Ÿä¸€å®ä¾‹åŒ–æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼Œå°† TodoStore å˜æ›´äº‹ä»¶é€šè¿‡ `mainWindow.webContents.send` é€šçŸ¥æ¸²æŸ“è¿›ç¨‹ã€‚

### 5.2 ProjectView.jsx â€” Agent æ¨¡å¼è·¯ç”±

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/ProjectView.jsx` | ä¿®æ”¹ | æ–°å¢ Agent çŠ¶æ€ç®¡ç†ã€æ¨¡å¼è·¯ç”±ã€äº‹ä»¶ç›‘å¬ |

**æ–¹æ³•**ï¼š
- æ–°å¢ 6 ä¸ª Agent ç›¸å…³ stateï¼š`agentState`ã€`agentIteration`ã€`agentToolCallCount`ã€`agentToolCalls`ã€`agentTodos`ã€`agentSessionRef`
- `handleSendMessage` ä¸­æ·»åŠ  `if (chatMode === 'agent')` åˆ†æ”¯ï¼Œèµ° `window.electronAPI.agentStart` IPC
- æ³¨å†Œ 7 ç±» Agent äº‹ä»¶ç›‘å¬å™¨ï¼ˆstream-contentã€stream-reasoningã€state-changeã€tool-calls-receivedã€tool-executingã€tool-resultã€approval-neededã€todo-updateï¼‰
- å°†äº‹ä»¶å®æ—¶æ›´æ–°åˆ°æ¶ˆæ¯çš„ `agentToolCalls` å’Œ `agentTodos` å­—æ®µä¸­
- é Agent æ¨¡å¼ä¿æŒåŸæœ‰ `llmStream` æµç¨‹ä¸å˜

### 5.3 AskMessageCard.jsx â€” ToolCallCard / TodoPanel æ¸²æŸ“

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/components/AskMessageCard.jsx` | ä¿®æ”¹ | å¯¼å…¥å¹¶æ¸²æŸ“ ToolCallCardã€TodoPanel |

**æ–¹æ³•**ï¼š
- å¢åŠ  `onAgentApprove`/`onAgentDeny` props ä¼ é€’å®¡æ‰¹å›è°ƒ
- å½“ `msg.agentTodos` æœ‰æ•°æ®æ—¶æ¸²æŸ“ `TodoPanel`ï¼ˆåœ¨å›å¤æ–‡æœ¬ä¸Šæ–¹ï¼‰
- å½“ `msg.agentToolCalls` æœ‰æ•°æ®æ—¶é€ä¸ªæ¸²æŸ“ `ToolCallCard`ï¼ˆåœ¨å›å¤æ–‡æœ¬ä¸‹æ–¹ï¼‰
- æ¯å¼  ToolCallCard æ‰¿è½½çŠ¶æ€ã€ç»“æœã€è€—æ—¶ã€å®¡æ‰¹æŒ‰é’®

### 5.4 AIPanel é›†æˆ AgentStatusBar

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/ProjectView.jsx` (AIPanel) | ä¿®æ”¹ | å¯¼å…¥ AgentStatusBarï¼Œåœ¨æ¶ˆæ¯åˆ—è¡¨åº•éƒ¨æ˜¾ç¤º |

**æ–¹æ³•**ï¼š
- AIPanel æ–°å¢ propsï¼š`agentState`ã€`agentIteration`ã€`agentToolCallCount`ã€`onAgentApprove`ã€`onAgentDeny`
- å½“ Agent è¿è¡Œæ—¶åœ¨è¾“å…¥æ¡†ä¸Šæ–¹æ¸²æŸ“ `AgentStatusBar`ï¼ˆæ˜¾ç¤ºçŠ¶æ€ã€è¿­ä»£æ¬¡æ•°ã€å·¥å…·è°ƒç”¨æ¬¡æ•°ã€å–æ¶ˆæŒ‰é’®ï¼‰

### 5.5 App.jsx â€” æ‰©å±•å·¥å…·é…ç½®é¡µ

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/App.jsx` | ä¿®æ”¹ | æ–°å¢ `MoreSettingsPanel` ç»„ä»¶ |

**æ–¹æ³•**ï¼š
- æ›¿æ¢ "More" æ ‡ç­¾é¡µçš„å ä½å†…å®¹ä¸ºå®Œæ•´çš„ `MoreSettingsPanel`
- æä¾› Web Search é…ç½®ï¼šå¼€å…³ã€SearXNG URLã€Google API Key/CX
- æä¾› Image Generation é…ç½®ï¼šå¼€å…³ã€OpenAI API Keyã€æ¨¡å‹é€‰æ‹©ï¼ˆDALL-E 2/3ï¼‰
- é…ç½®é€šè¿‡ `modeConfigGet/Save` IPC æŒä¹…åŒ–

### 5.6 preload.js â€” äº‹ä»¶æ¸…ç†è¡¥å…¨

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `preload.js` | ä¿®æ”¹ | Agent äº‹ä»¶æ¸…ç†åˆ—è¡¨å¢åŠ  `todo-update` |

---

## Phase 6: è¡¥å…¨é¡¹ï¼ˆW5-W6 ä»»åŠ¡ï¼‰

> æ‰§è¡Œæ—¶é—´ï¼šPhase 6ï¼Œå†²åˆºè®¡åˆ’ä¸­ W5-W6 çš„é¢å¤–ä»»åŠ¡

### 6.1 è§„åˆ™ç³»ç»Ÿ â€” Rule Loader

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/core/rule-loader.js` | æ–°å¢ | é¡¹ç›®è§„åˆ™æ–‡ä»¶åŠ è½½å™¨ |
| `src/prompts/prompt-assembler.js` | ä¿®æ”¹ | æ–°å¢ `assembleAsync()` æ–¹æ³•ï¼Œè‡ªåŠ¨åŠ è½½é¡¹ç›®è§„åˆ™ |
| `src/core/agent-loop-controller.js` | ä¿®æ”¹ | ä¼˜å…ˆä½¿ç”¨ `assembleAsync` ä»¥åŠ è½½è§„åˆ™ |

**æ–¹æ³•**ï¼š
- `loadProjectRules(projectPath)` æ‰«æ 5 ç§è§„åˆ™æ–‡ä»¶ï¼š`.cursorrules`ã€`.cursor/rules/`ï¼ˆç›®å½•ä¸‹çš„ .mdï¼‰ã€`AGENTS.md`ã€`CLAUDE.md`ã€`.github/copilot-instructions.md`
- å•æ–‡ä»¶ä¸Šé™ 5000 å­—ç¬¦ï¼Œç›®å½•ä¸‹æ¯æ–‡ä»¶ 2000 å­—ç¬¦ã€æœ€å¤š 5 ä¸ªæ–‡ä»¶ï¼Œæ€»ä¸Šé™ 15000 å­—ç¬¦
- `formatRulesForPrompt()` å°†è§„åˆ™æ ¼å¼åŒ–ä¸º `## Project Rules` Prompt æ®µè½
- `PromptAssembler.assembleAsync()` åœ¨ assemble åŸºç¡€ä¸Šè‡ªåŠ¨è°ƒç”¨ rule-loaderï¼Œæ— éœ€å¤–éƒ¨ä¼ å…¥ rules

### 6.2 Git ä¸“ç”¨å·¥å…·

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/tools/git-operations.js` | æ–°å¢ | Git å‘½ä»¤å®‰å…¨å°è£… |
| `src/tools/index.js` | ä¿®æ”¹ | æ³¨å†Œ git å·¥å…· |

**æ–¹æ³•**ï¼š
- ç™½åå•æœºåˆ¶ï¼šä»…å…è®¸ 20 ç§å¸¸ç”¨ git å­å‘½ä»¤ï¼ˆstatus/diff/log/add/commit/push/pull ç­‰ï¼‰
- å±é™©æ ‡å¿—æ‹¦æˆªï¼š`--force`ã€`--hard`ã€`--no-verify`ã€`-D` åœ¨ push/reset/branch æ“ä½œä¸­è¢«é˜»æ­¢
- ä½¿ç”¨ `child_process.execFile` è€Œé `exec`ï¼Œé¿å… shell æ³¨å…¥
- è¾“å‡ºæˆªæ–­ï¼šstdout 50KBã€stderr 10KB

### 6.3 Linter é›†æˆ

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/core/linter-runner.js` | æ–°å¢ | ä¸»è¿›ç¨‹ ESLint æ‰§è¡Œå™¨ |
| `main.js` | ä¿®æ”¹ | æ³¨å†Œ `linter:run` IPC |
| `preload.js` | ä¿®æ”¹ | æš´éœ² `linterRun` API |
| `src/core/dynamic-context-provider.js` | ä¿®æ”¹ | æ”¯æŒ `linterRunner` å›è°ƒ |

**æ–¹æ³•**ï¼š
- `findEslint()` è‡ªåŠ¨å‘ç°é¡¹ç›®æœ¬åœ° ESLintï¼ˆ`node_modules/.bin/eslint`ï¼‰
- ä»¥ `--format json` è¿è¡Œ ESLintï¼Œè§£æç»“æœä¸ºç»“æ„åŒ–é”™è¯¯åˆ—è¡¨
- `DynamicContextProvider.gather()` æ–°å¢ `linterRunner` å‚æ•°ï¼Œå½“æ— å¤–éƒ¨ linter æ•°æ®æ—¶ä¸»åŠ¨è°ƒç”¨

### 6.4 E2E æµ‹è¯•æ¡†æ¶

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `tests/eval/test-cases.js` | æ–°å¢ | 20 ä¸ªè¯„æµ‹ç”¨ä¾‹å®šä¹‰ |
| `tests/eval/run-eval.js` | æ–°å¢ | è¯„åˆ†è„šæœ¬æ¡†æ¶ |
| `tests/eval/fixtures/` | æ–°å¢ | 8 ä¸ªæµ‹è¯•é¡¹ç›®æ¨¡æ¿ |

**æ–¹æ³•**ï¼š
- æ¯ä¸ªç”¨ä¾‹åŒ…å« `id`ã€`category`ã€`input`ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰ã€`fixture`ï¼ˆæµ‹è¯•é¡¹ç›®åï¼‰ã€`verify`ï¼ˆéªŒè¯å‡½æ•°ï¼‰ã€`passThreshold`
- `runSingleCase()` æµç¨‹ï¼šåˆ›å»º fixture å‰¯æœ¬ â†’ è¿è¡Œ Agent â†’ éªŒè¯ç»“æœ â†’ æ¸…ç†
- è¯„åˆ†ç»´åº¦ï¼šcompletionï¼ˆä»»åŠ¡å®Œæˆåº¦ï¼‰ã€efficiencyï¼ˆè¿­ä»£æ•ˆç‡ï¼‰ã€securityï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
- `runAllCases()` è¾“å‡ºåˆ†ç±»æ±‡æ€» + JSON ç»“æœæ–‡ä»¶
- 8 ä¸ª fixtureï¼šbasic-nodeã€basic-reactã€tricky-indentã€wrong-pathã€multi-refã€build-errorã€medium-projectã€lint-errorsã€large-file

**20 ç”¨ä¾‹è¦†ç›–**ï¼š
| ç±»åˆ« | ç”¨ä¾‹æ•° | ç¼–å· |
|------|--------|------|
| åˆ›å»º/ç¼–è¾‘ | 3 | E01-E03 |
| å¤šæ–‡ä»¶ | 1 | E04 |
| å‘½ä»¤ | 1 | E05 |
| æœç´¢ | 1 | E06 |
| æ¢å¤ | 3 | E07-E09 |
| å®‰å…¨ | 2 | E10-E11 |
| å®¡æ‰¹ | 2 | E12-E13 |
| é•¿å¯¹è¯ | 2 | E14-E15 |
| ä¸Šä¸‹æ–‡ | 2 | E16-E17 |
| å¹¶å‘/å¤§æ–‡ä»¶ | 2 | E18-E19 |
| å¤æ‚ä»»åŠ¡ | 1 | E20 |

### 6.5 v1/v2 å›æ»šå¼€å…³

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/App.jsx` | ä¿®æ”¹ | è®¾ç½®é¡µæ–°å¢ Agent å¼•æ“åˆ‡æ¢ï¼ˆv1/v2ï¼‰ |
| `src/ProjectView.jsx` | ä¿®æ”¹ | æ ¹æ® `agentEngine` é…ç½®å†³å®šèµ° v1ï¼ˆmarkdownï¼‰è¿˜æ˜¯ v2ï¼ˆtool_callsï¼‰ |

**æ–¹æ³•**ï¼š
- è®¾ç½®é¡µ Mode åŒºåŸŸæ–°å¢ v1/v2 åˆ‡æ¢æŒ‰é’®ç»„
- `modeConfig.agentEngine` æŒä¹…åŒ–å­˜å‚¨
- v2ï¼ˆé»˜è®¤ï¼‰ï¼šAgent æ¨¡å¼èµ° `agentStart` IPCï¼Œè¿›å…¥å®Œæ•´ Agent Loop
- v1ï¼šAgent æ¨¡å¼å›é€€åˆ°ä¸ Ask/Plan/Debug ç›¸åŒçš„ `llmStream` æµç¨‹ï¼Œä½¿ç”¨ `parseAgentSteps` è§£æ markdown

---

## å®Œæ•´æ–‡ä»¶æ¸…å•ï¼ˆæ›´æ–°åï¼‰

### æ–°å¢æ–‡ä»¶ï¼ˆå…± 42 ä¸ª + 20 ä¸ª fixture æ–‡ä»¶ï¼‰

```
src/core/
  agent-loop-controller.js    â† Agent ä¸»å¾ªç¯çŠ¶æ€æœº
  agent-loop-factory.js       â† å­ä»£ç†å·¥å‚
  agent-tracer.js             â† ç»“æ„åŒ–æ—¥å¿—/è¿½è¸ª
  context-engine.js           â† Token é¢„ç®— + å†å²å‹ç¼©
  dynamic-context-provider.js â† 6 æºåŠ¨æ€ä¸Šä¸‹æ–‡
  edit-fuzzy-matcher.js       â† å››çº§æ¨¡ç³ŠåŒ¹é…
  error-codes.js              â† ç»Ÿä¸€é”™è¯¯ç 
  linter-runner.js            â† ESLint æ‰§è¡Œå™¨ [NEW]
  llm-gateway.js              â† LLM æµå¼è°ƒç”¨å°è£…
  rule-loader.js              â† é¡¹ç›®è§„åˆ™åŠ è½½å™¨ [NEW]
  security-layer.js           â† è·¯å¾„/å‘½ä»¤å®‰å…¨æ ¡éªŒ
  todo-store.js               â† Todo å“åº”å¼çŠ¶æ€å®¹å™¨
  token-counter.js            â† Token ä¼°ç®—å™¨
  tool-executor.js            â† å·¥å…·æ³¨å†Œ/è·¯ç”±/æ‰§è¡Œ

src/tools/
  browser-use.js              â† æµè§ˆå™¨è‡ªåŠ¨åŒ–
  delete-file.js              â† åˆ é™¤æ–‡ä»¶
  edit-file.js                â† å­—ç¬¦ä¸²æ›¿æ¢ç¼–è¾‘
  generate-image.js           â† å›¾ç‰‡ç”Ÿæˆ
  git-operations.js           â† Git å‘½ä»¤å®‰å…¨å°è£… [NEW]
  glob-search.js              â† æ–‡ä»¶åæ¨¡å¼åŒ¹é…
  index.js                    â† å·¥å…·ç»Ÿä¸€æ³¨å†Œ
  list-directory.js           â† åˆ—å‡ºç›®å½•
  read-file.js                â† è¯»å–æ–‡ä»¶
  run-terminal-cmd.js         â† æ‰§è¡Œç»ˆç«¯å‘½ä»¤
  search-files.js             â† æ­£åˆ™æœç´¢
  task-delegation.js          â† å­ä»£ç†å§”æ´¾
  todo-manager.js             â† ç»“æ„åŒ– Todo
  web-fetch.js                â† URL å†…å®¹æŠ“å–
  web-search.js               â† ç½‘é¡µæœç´¢
  write-file.js               â† å†™å…¥æ–‡ä»¶

src/prompts/
  mode-agent.js               â† Agent æ¨¡å¼ Prompt
  mode-ask.js                 â† Ask æ¨¡å¼ Prompt
  mode-debug.js               â† Debug æ¨¡å¼ Prompt
  mode-plan.js                â† Plan æ¨¡å¼ Prompt
  prompt-assembler.js         â† Prompt ç»„è£…å™¨
  recovery-prompt.js          â† é”™è¯¯æ¢å¤ Prompt
  summarizer-prompt.js        â† å†å²æ‘˜è¦ Prompt
  system-base.js              â† ç³»ç»ŸåŸºç¡€ Prompt

src/main-process/
  agent-ipc.js                â† Agent IPC æ¡¥æ¥

src/components/
  AgentStatusBar.jsx          â† Agent çŠ¶æ€æŒ‡ç¤ºå™¨
  ApprovalBar.jsx             â† å®¡æ‰¹ç¡®è®¤æ¡
  SubAgentCard.jsx            â† å­ä»£ç† UI å¡ç‰‡
  TodoPanel.jsx               â† Todo é¢æ¿
  ToolCallCard.jsx            â† å·¥å…·è°ƒç”¨å¯è§†åŒ–å¡ç‰‡

tests/eval/
  test-cases.js               â† 20 ä¸ªè¯„æµ‹ç”¨ä¾‹ [NEW]
  run-eval.js                 â† è¯„åˆ†è„šæœ¬ [NEW]
  fixtures/                   â† 8 ä¸ªæµ‹è¯•é¡¹ç›®æ¨¡æ¿ [NEW]
```

### ä¿®æ”¹æ–‡ä»¶ï¼ˆå…± 6 ä¸ªï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `main.js` | Agent IPC åˆå§‹åŒ– + Linter IPC æ³¨å†Œ |
| `preload.js` | Agent + Linter API æš´éœ² |
| `src/ProjectView.jsx` | Agent æ¨¡å¼è·¯ç”± + çŠ¶æ€ç®¡ç† + v1/v2 åˆ‡æ¢ |
| `src/components/AskMessageCard.jsx` | ToolCallCard + TodoPanel é›†æˆ |
| `src/App.jsx` | MoreSettingsPanel + Agent å¼•æ“åˆ‡æ¢ + autoExecute |

---

## Phase 7 â€” Agent V2 UI/UX æ·±åº¦å¯¹é½ï¼ˆå·²å®Œæˆï¼‰

### 7.1 ç»“è®ºè¾“å‡ºé¡ºåºé‡æ„
- **æ–‡ä»¶**: `src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**: Agent V2 æ¨¡å¼ä¸‹å¸ƒå±€é‡æ„ä¸º `ThoughtPanel â†’ TodoPanel â†’ [æ€è€ƒæè¿°+å·¥å…·è°ƒç”¨äº¤æ›¿] â†’ ç»“è®º(ä»…å®Œæˆå)`
- **æ–¹æ³•**: æ–°å¢ `AgentThinkingSegment` ç»„ä»¶æ¸²æŸ“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ€è€ƒæ–‡æœ¬ï¼Œæ–°å¢ `AgentConclusionBlock` ç»„ä»¶æ¸²æŸ“æœ€ç»ˆç»“è®ºã€‚é€šè¿‡ `isAgentV2` åˆ¤æ–­èµ°æ–°å¸ƒå±€åˆ†æ”¯ã€‚

### 7.2 æ€è€ƒæè¿°ä¸å·¥å…·è°ƒç”¨äº¤æ›¿æ¸²æŸ“
- **æ–‡ä»¶**: `src/ProjectView.jsx`, `src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**: 
  - ProjectView æ–°å¢ `agentTextBufRef` å’Œ `agentBatchRef` è¿½è¸ªæ–‡æœ¬ç¼“å†²ä¸æ‰¹æ¬¡ç´¢å¼•
  - `stream-content` äº‹ä»¶ä¸­è¿½è¸ª `agentCurrentThinking`ï¼ˆå®æ—¶æµå¼æ€è€ƒï¼‰
  - `tool-calls-received` äº‹ä»¶ä¸­æ•è·å½“å‰æ€è€ƒæ–‡æœ¬åˆ° `agentThinkingTexts[batch]` æ•°ç»„ï¼Œå¹¶ç»™å·¥å…·è°ƒç”¨æ‰“ `_batch` æ ‡ç­¾
  - Agent å®Œæˆæ—¶ï¼Œå‰©ä½™æ–‡æœ¬å­˜å…¥ `agentConclusion` ä½œä¸ºæœ€ç»ˆç»“è®º
  - AskMessageCard æŒ‰ batch é¡ºåºäº¤æ›¿æ¸²æŸ“æ€è€ƒæè¿°å’Œå·¥å…·è°ƒç”¨å¡ç‰‡
- **æ–¹æ³•**: æ‰¹æ¬¡åˆ†ç»„æ¸²æŸ“ï¼ˆbatchMapï¼‰ï¼Œæ¯ä¸ªæ‰¹æ¬¡å…ˆæ¸²æŸ“æ€è€ƒæ®µè½å†æ¸²æŸ“è¯¥æ‰¹æ¬¡çš„å·¥å…·è°ƒç”¨

### 7.3 ToolCallCard é»˜è®¤å±•å¼€ + é«˜åº¦é™åˆ¶
- **æ–‡ä»¶**: `src/components/ToolCallCard.jsx`
- **æ”¹åŠ¨**: é»˜è®¤ `open` çŠ¶æ€æ”¹ä¸º `true`ï¼Œå±•å¼€é¢æ¿å¢åŠ  `max-h-[240px]` æ•´ä½“é«˜åº¦é™åˆ¶å’Œ `max-h-[100px]` å‚æ•°/ç»“æœåŒºåŸŸé™åˆ¶
- **æ–¹æ³•**: æ–°å¢ `defaultExpanded` propï¼Œå¤–éƒ¨å¯æ§åˆ¶é»˜è®¤å±•å¼€/æŠ˜å 

### 7.4 TodoPanel å®Œæˆé¡¹åˆ é™¤çº¿
- **æ–‡ä»¶**: `src/components/TodoPanel.jsx`
- **æ”¹åŠ¨**: `completed` çŠ¶æ€çš„é¡¹å¢åŠ ç»¿è‰²åˆ é™¤çº¿ (`line-through decoration-green-500/60`)ï¼Œé™ä½é€æ˜åº¦ (`opacity-70`)ï¼›ä¸ `cancelled` çŠ¶æ€åŒºåˆ†æ ·å¼
- **æ–¹æ³•**: é€šè¿‡ `isDone` / `isCancelled` åˆ†åˆ«æ§åˆ¶æ ·å¼

---

## Phase 8 â€” Cursor æ·±åº¦ UI å¯¹é½ + æ‰§è¡Œè¿‡ç¨‹æ€è€ƒ + éªŒæ”¶æœºåˆ¶ï¼ˆå·²å®Œæˆï¼‰

### 8.1 TodoPanel å®Œå…¨é‡å†™ï¼ˆCursor æ‰§è¡Œè®¡åˆ’é£æ ¼ï¼‰
- **æ–‡ä»¶**: `src/components/TodoPanel.jsx`
- **æ”¹åŠ¨**: å…¨éƒ¨é‡å†™ç»„ä»¶ï¼Œå¯¹é½ Cursor çš„"æ‰§è¡Œè®¡åˆ’"é¢æ¿
- **è®¾è®¡è¦ç‚¹**:
  - æ ‡é¢˜è¡Œï¼š`âˆ¨ æ‰§è¡Œè®¡åˆ’ (completed/total)` + å³ä¾§ç™¾åˆ†æ¯”ï¼ˆå®Œæˆæ—¶å˜ç»¿è‰²ï¼‰
  - æ¸å˜è¿›åº¦æ¡ï¼š`#818cf8 â†’ #4ade80`ï¼ˆæ‰§è¡Œä¸­ï¼‰/ `#4ade80 â†’ #22c55e`ï¼ˆå…¨éƒ¨å®Œæˆï¼‰
  - å®Œæˆé¡¹ï¼šç»¿è‰² CheckCircle2 + ç°è‰²æ–‡å­— + åˆ é™¤çº¿
  - è¿›è¡Œä¸­ï¼šè“è‰²æ—‹è½¬ Loader2
  - å¾…å¤„ç†ï¼šç°è‰²ç©ºå¿ƒ Circle
  - å–æ¶ˆé¡¹ï¼šä½é€æ˜åº¦ + åˆ é™¤çº¿
- **æ–¹æ³•**: å®Œå…¨é‡å†™ç»„ä»¶ï¼Œå»é™¤è¾¹æ¡†èƒŒæ™¯ï¼Œé‡‡ç”¨ Cursor çš„æç®€æš—è‰²é£æ ¼

### 8.2 æ‰§è¡Œè¿‡ç¨‹ä¸­æŒ‰æ‰¹æ¬¡æ˜¾ç¤º Thoughtï¼ˆéšæ—¶æ€è€ƒï¼‰
- **æ–‡ä»¶**: `src/ProjectView.jsx`, `src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**:
  - æ–°å¢ `agentReasoningBufRef` / `agentReasoningStartRef` è¿½è¸ªæ¯ä¸ª LLM è¿­ä»£çš„ reasoning
  - `stream-reasoning` ä¸­è¿½è¸ª `agentCurrentReasoning` å’Œå¼€å§‹æ—¶é—´
  - `tool-calls-received` ä¸­æ•è· `{ text, durationMs }` å­˜å…¥ `agentReasoningTexts[batch]`
  - æ–°å¢ `InlineThoughtPanel` ç»„ä»¶ï¼šCursor é£æ ¼çš„ "Thought for Xs" / "Thought briefly"ï¼Œå¯å±•å¼€æŸ¥çœ‹è¯¦ç»†æ¨ç†
  - æ¯ä¸ªæ‰¹æ¬¡çš„å·¥å…·è°ƒç”¨å‰å…ˆæ¸²æŸ“å¯¹åº”çš„ InlineThoughtPanel
  - æ”¯æŒå®æ—¶æµå¼ reasoning æ˜¾ç¤ºï¼ˆå¸¦è®¡æ—¶å™¨å’Œæ—‹è½¬åŠ¨ç”»ï¼‰
- **æ–¹æ³•**: æ‰¹æ¬¡ç´¢å¼•å…³è”ï¼Œreasoning éš tool calls æ‰¹æ¬¡ä¸€èµ·åˆ†æ®µæ˜¾ç¤º

### 8.3 éªŒæ”¶æ£€æŸ¥æœºåˆ¶
- **æ–‡ä»¶**: `src/prompts/mode-agent.js`, `src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**:
  - Agent æç¤ºè¯å¢åŠ ç¬¬ 6 æ­¥"Final Verification"æŒ‡ä»¤ï¼šè¦æ±‚æ‰§è¡Œå®Œæˆåå›è¯»æ–‡ä»¶ã€æ£€æŸ¥ lintã€ç¡®è®¤ todo å®Œæˆã€éªŒè¯æ— é”™è¯¯ï¼Œé—®é¢˜æœªè§£å†³ä¸è¾“å‡ºç»“è®º
  - æ–°å¢ `VerificationBadge` ç»„ä»¶ï¼šæ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºéªŒæ”¶ç»“æœ
    - å…¨éƒ¨æˆåŠŸ â†’ ç»¿è‰² âœ“ "éªŒæ”¶é€šè¿‡ â€” N é¡¹æ“ä½œå…¨éƒ¨æˆåŠŸ"
    - æœ‰å¤±è´¥ â†’ é»„è‰² âš  "éªŒæ”¶è­¦å‘Š â€” N é¡¹æ“ä½œå¤±è´¥ / N é¡¹è®¡åˆ’æœªå®Œæˆ"
  - ç»“è®ºä»…åœ¨éªŒæ”¶ç»“æœä¹‹åæ˜¾ç¤º
- **æ–¹æ³•**: Prompt å±‚çº¦æŸ + UI å±‚è‡ªåŠ¨è®¡ç®—éªŒæ”¶çŠ¶æ€

---

## Phase 9 â€” Prompt å…¨é¢é‡å†™ï¼šä¸­æ–‡åŒ– + æ™ºèƒ½é€‰å‹ + éªŒæ”¶å¯¹æ ‡ Cursorï¼ˆå·²å®Œæˆï¼‰

### 9.1 å…¨éƒ¨æç¤ºè¯ä¸­æ–‡åŒ– + ç®€æ´æè¿°è§„èŒƒ
- **æ–‡ä»¶**: `src/prompts/system-base.js`, `mode-agent.js`, `mode-ask.js`, `mode-plan.js`, `mode-debug.js`, `recovery-prompt.js`, `summarizer-prompt.js`ï¼ˆå…± 7 ä¸ªæ–‡ä»¶å…¨éƒ¨é‡å†™ï¼‰
- **æ”¹åŠ¨**:
  - æ‰€æœ‰æç¤ºè¯ä»è‹±æ–‡æ”¹ä¸ºç®€ä½“ä¸­æ–‡
  - system-base æ–°å¢"è¯­è¨€è§„èŒƒ"æ®µï¼šå¼ºåˆ¶ç®€ä½“ä¸­æ–‡è¾“å‡ºï¼Œæ‰§è¡Œè¿‡ç¨‹æè¿°ç²¾ç®€
  - mode-agent æ–°å¢"ä¸­é—´æè¿°è§„èŒƒ"æ®µï¼šç»™å‡ºæ­£åä¾‹ï¼ˆâŒ é•¿ç¯‡è‹±æ–‡ vs âœ… ä¸€å¥è¯ä¸­æ–‡ï¼‰
- **æ–¹æ³•**: å…¨é‡æ›¿æ¢ï¼Œä¿æŒç»“æ„åŒ–æ ¼å¼

### 9.2 æ™ºèƒ½æŠ€æœ¯é€‰å‹ï¼ˆä¸å†ä¸€åˆ€åˆ‡ HTMLï¼‰
- **æ–‡ä»¶**: `src/prompts/mode-agent.js`
- **æ”¹åŠ¨**: æ–°å¢"æŠ€æœ¯é€‰å‹è§„åˆ™"æ®µï¼ŒåŒ…å«ï¼š
  - éœ€æ±‚ç±»å‹â†’æ¨èæ–¹æ¡ˆæ˜ å°„è¡¨ï¼ˆ8ç§å¸¸è§åœºæ™¯ï¼‰
  - é€‰å‹å†³ç­–æµç¨‹ï¼ˆ5æ­¥ï¼‰ï¼šåˆ†æå…³é”®è¯ â†’ éµå®ˆç”¨æˆ·æŒ‡å®š â†’ æŒ‰å¤æ‚åº¦é€‰æ‹© â†’ è¯´æ˜ç†ç”± â†’ è§„èŒƒé¡¹ç›®ç»“æ„
- **æ–¹æ³•**: æç¤ºè¯å±‚é¢å¼•å¯¼ï¼Œç»™å‡ºæ˜ç¡®çš„æ˜ å°„å…³ç³»å’Œå†³ç­–é€»è¾‘

### 9.3 éªŒæ”¶åè®®å¢å¼ºï¼ˆå¯¹æ ‡ Cursorï¼‰
- **æ–‡ä»¶**: `src/prompts/mode-agent.js`
- **æ”¹åŠ¨**: æ–°å¢"éªŒæ”¶åè®®"æ®µï¼ŒåŒ…å«ï¼š
  - è§¦å‘æ¡ä»¶ï¼šæ‰€æœ‰è®¡åˆ’æ­¥éª¤æ‰§è¡Œå®Œæ¯•
  - 5é¡¹æ£€æŸ¥æ¸…å•ï¼šæ–‡ä»¶å›è¯» â†’ è¯­æ³•æ£€æŸ¥ â†’ åŠŸèƒ½è‡ªæŸ¥ â†’ Todo æ‰«æ â†’ å¤±è´¥æ‰«æ
  - ç»“æœå¤„ç†ï¼šå…¨éƒ¨é€šè¿‡â†’è¾“å‡ºç»“è®ºï¼›å‘ç°é—®é¢˜â†’ä¿®å¤åé‡æ–°éªŒæ”¶
  - "å®Œæˆé—¨æ§"æœºåˆ¶ï¼šæœ‰æœªä¿®å¤å¤±è´¥ã€æœ‰ pending todoã€æ— å®¢è§‚éªŒè¯å‘½ä»¤ â†’ ç¦æ­¢è¾“å‡ºç»“è®º
  - ç»“è®ºæ ¼å¼ï¼šç®€è¿°å®Œæˆå†…å®¹ + å…³é”®æ–‡ä»¶ + ä½¿ç”¨æ–¹æ³•

---

## Phase 10 â€” é—¸é—¨ä¿®å¤ + ä¸­æ–‡å¼ºåŒ– + æ–¹æ¡ˆè‡ªè¯„ä½“ç³»ï¼ˆå·²å®Œæˆï¼‰

### 10.1 ä¿®å¤"å®Œæˆé—¸é—¨æœªé€šè¿‡"è¯¯æŠ¥
- **æ–‡ä»¶**: `src/core/agent-loop-controller.js`, `src/ProjectView.jsx`
- **æ ¹å› **: `_checkCompletionGate()` ç¬¬ 3 æ¡è¦æ±‚æ–‡ä»¶å˜æ›´åå¿…é¡»æœ‰ `run_terminal_cmd` æˆåŠŸæ‰§è¡Œã€‚ä½†ç®€å•é¡¹ç›®ï¼ˆçº¯ HTML/JSï¼‰æ— æ„å»ºå‘½ä»¤ï¼Œå¯¼è‡´æ°¸è¿œå¤±è´¥ã€‚
- **ä¿®å¤**:
  - æ”¾å®½éªŒè¯èŒƒå›´ï¼š`read_file`ã€`search_files`ã€`list_directory` ç­‰å›è¯»æ“ä½œä¹Ÿç®—æœ‰æ•ˆéªŒè¯
  - é—¸é—¨æ³¨å…¥ system message æ”¹ä¸ºä¸­æ–‡
  - ProjectView ä¸­é—¸é—¨å¤±è´¥æç¤ºå»æ‰"â›” å®Œæˆé—¸é—¨æœªé€šè¿‡"å¼ºç¡¬æªè¾ï¼Œæ”¹ä¸ºæ¸©å’Œçš„éªŒæ”¶é¡¹åˆ—è¡¨

### 10.2 å¼ºåŒ–ä¸­æ–‡è¾“å‡º
- **æ–‡ä»¶**: `src/prompts/system-base.js`, `src/core/agent-loop-controller.js`
- **æ”¹åŠ¨**:
  - system-base ç¬¬ä¸€è¡Œæ”¹ä¸º `# é‡è¦ï¼šå§‹ç»ˆä½¿ç”¨ç®€ä½“ä¸­æ–‡`ï¼Œä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§è§„åˆ™
  - æ–°å¢è¯¦ç»†çš„è¯­è¨€è§„èŒƒæ®µï¼šæ˜ç¡®åˆ—å‡ºå“ªäº›è¾“å‡ºå¿…é¡»ä¸­æ–‡
  - æ·»åŠ  `âŒ ç¦æ­¢å…¨è‹±æ–‡æè¿°` æ¡æ¬¾
  - agent-loop-controller åœ¨ user message æœ«å°¾è¿½åŠ  `[è¯·ç”¨ç®€ä½“ä¸­æ–‡å›å¤]`
  - é—¸é—¨é‡è¯• system message ä¹Ÿæ”¹ä¸ºä¸­æ–‡

### 10.3 æ–¹æ¡ˆå¤šç»´åº¦è‡ªè¯„æœºåˆ¶
- **æ–‡ä»¶**: `src/prompts/mode-agent.js`
- **æ”¹åŠ¨**: æ–°å¢å®Œæ•´çš„"æ–¹æ¡ˆè‡ªè¯„åè®®"æ®µï¼ŒåŒ…å«ï¼š
  - **8 ç»´åº¦è¯„ä¼°è¡¨**ï¼šéœ€æ±‚è¦†ç›–ã€æŠ€æœ¯æ–¹æ¡ˆã€ä»£ç è´¨é‡ã€ç”¨æˆ·ä½“éªŒã€å¥å£®æ€§ã€å¯ç»´æŠ¤æ€§ã€åˆ›æ–°äº®ç‚¹ã€å®Œæˆåº¦
  - **æ¯é¡¹æœ€ä½åˆ†æ ‡å‡†**ï¼ˆ7-8 åˆ†ï¼Œæ€»åˆ† 55/80 åŠæ ¼çº¿ï¼‰
  - **è‡ªè¯„æµç¨‹**ï¼šé€ç»´åº¦æ‰“åˆ† â†’ ä½äºæœ€ä½åˆ†åˆ™ä¿®æ”¹ â†’ æ€»åˆ†ä¸è¾¾æ ‡ç¦æ­¢æ‰§è¡Œ â†’ é€šè¿‡åä¸€å¥è¯ç®€è¯„
  - **4 ç±»å¸¸è§ä½åˆ†åœºæ™¯ä¸å¯¹ç­–**ï¼šUI å•è°ƒ â†’ åŠ æ¸å˜åŠ¨ç”»ï¼›åŠŸèƒ½åŸºç¡€ â†’ åŠ æœç´¢ç­›é€‰ï¼›ç»“æ„ç®€é™‹ â†’ æ‹†æ¨¡å—ï¼›ä½“éªŒç”Ÿç¡¬ â†’ åŠ è¿‡æ¸¡åŠ¨ç”»

---

## Phase 11 â€” TodoPanel å†…è”å®šä½ + Sticky æ‚¬æµ® + æ–¹æ¡ˆè¯„ä¼°å¯è§†åŒ–ï¼ˆå·²å®Œæˆï¼‰

### 11.1 TodoPanel ç§»è‡³ todo_write è°ƒç”¨ä½ç½®
- **æ–‡ä»¶**: `src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**: ä¸å†åœ¨æ¶ˆæ¯é¡¶éƒ¨æ¸²æŸ“ TodoPanelï¼Œè€Œæ˜¯åœ¨é€æ‰¹æ¬¡æ¸²æŸ“ä¸­æ£€æµ‹ `todo_write` å·¥å…·è°ƒç”¨ï¼Œåœ¨è¯¥è°ƒç”¨çš„ ToolCallCard åé¢å†…è”æ¸²æŸ“ TodoPanelã€‚ä½¿ç”¨ `todoPanelRendered` æ ‡è®°ç¡®ä¿åªæ¸²æŸ“ä¸€æ¬¡ã€‚
- **æ–¹æ³•**: `isTodoWriteCall()` æ£€æµ‹å‡½æ•° + é¦–æ¬¡æ¸²æŸ“æ ‡è®°

### 11.2 Sticky æ‚¬æµ®è¿›åº¦è¿½è¸ªå™¨
- **æ–‡ä»¶**: `src/components/TodoPanel.jsx`ï¼ˆæ–°å¢å¯¼å‡º `StickyTodoTracker`ï¼‰
- **æ”¹åŠ¨**: æ–°å¢ `StickyTodoTracker` ç»„ä»¶ï¼Œ`position: sticky; top: 0; z-index: 20`
  - ç´§å‡‘çš„ä¸€è¡Œè¿›åº¦æ¡ï¼šå›¾æ ‡ + "æ‰§è¡Œè®¡åˆ’" + (completed/total) + æ¸å˜è¿›åº¦æ¡ + ç™¾åˆ†æ¯”
  - `backdrop-blur-md` æ¯›ç»ç’ƒèƒŒæ™¯
  - é¼ æ ‡æ‚¬åœæ—¶å±•å¼€å®Œæ•´ todo åˆ—è¡¨ï¼ˆmax-h-[200px] å¯æ»šåŠ¨ï¼‰
  - æ»šåŠ¨åˆ° TodoPanel ä¹‹åï¼ŒSticky è‡ªåŠ¨å›ºå®šåœ¨æ¶ˆæ¯åŒºé¡¶éƒ¨
- **æ–¹æ³•**: CSS `position: sticky` + `onMouseEnter/Leave` æ‚¬åœå±•å¼€

### 11.3 æ–¹æ¡ˆè¯„ä¼°å¯è§†åŒ–
- **æ–‡ä»¶**: `src/components/TodoPanel.jsx`ï¼ˆæ–°å¢å¯¼å‡º `PlanEvaluationCard`ï¼‰ï¼Œ`src/components/AskMessageCard.jsx`
- **æ”¹åŠ¨**:
  - æ–°å¢ `PlanEvaluationCard` ç»„ä»¶ï¼šç´«è‰²è¾¹æ¡†å¡ç‰‡ï¼Œå¯æŠ˜å ï¼Œæ˜¾ç¤ºè¯„ä¼°æ–‡æœ¬
  - AskMessageCard ä¸­æ£€æµ‹ thinking æ–‡æœ¬æ˜¯å¦åŒ…å«è¯„ä¼°å…³é”®è¯ï¼ˆ"è¯„ä¼°"ã€"è‡ªè¯„"ã€"æ‰“åˆ†"ç­‰ï¼‰
  - åŒ…å«è¯„ä¼°å…³é”®è¯æ—¶ç”¨ PlanEvaluationCard æ›¿ä»£æ™®é€š AgentThinkingSegment æ¸²æŸ“
- **æ–¹æ³•**: å…³é”®è¯æ£€æµ‹ + ä¸“ç”¨å¡ç‰‡ç»„ä»¶

---

## åç»­å·¥ä½œï¼ˆå¾…åšï¼‰

1. **ç«¯åˆ°ç«¯è°ƒè¯•** â€” å¯åŠ¨åº”ç”¨éªŒè¯ Agent æ¨¡å¼å®Œæ•´é“¾è·¯
2. **æ€§èƒ½ä¼˜åŒ–** â€” å¤§å‹é¡¹ç›®ä¸‹çš„ä¸Šä¸‹æ–‡å‹ç¼©å’Œ Token ç®¡ç†ä¼˜åŒ–

---

## Phase 12 - Codexåä»£æœåŠ¡å¯åŠ¨å¤±è´¥ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰
æ—¥æœŸï¼š2026-02-18

### 12.1 é—®é¢˜ç°è±¡
- è®¾ç½®é¡µå¯åŠ¨ Codex åä»£æœåŠ¡åçŠ¶æ€å˜ä¸º `failed`
- é”™è¯¯ä¿¡æ¯ï¼š`Service exited, code=1, signal=null`
- æ—¥å¿—å…³é”®å­—ï¼š`Error: listen EADDRINUSE`ï¼ˆç«¯å£ `1455` å·²è¢«å ç”¨ï¼‰

### 12.2 æ ¹å› 
- å¯åŠ¨é€»è¾‘é»˜è®¤ä½¿ç”¨é…ç½®ç«¯å£ï¼ˆ1455ï¼‰ï¼Œæœªåœ¨å¯åŠ¨å‰æ£€æŸ¥ç«¯å£å¯ç”¨æ€§
- ç«¯å£å†²çªæ—¶å­è¿›ç¨‹ç›´æ¥é€€å‡ºï¼ŒUIä»…æ˜¾ç¤ºå¤±è´¥ï¼Œæœªè‡ªåŠ¨æ¢å¤åˆ°å¯ç”¨ç«¯å£

### 12.3 ä¿®å¤æ–¹æ¡ˆï¼ˆå¢é‡ï¼‰
- `main.js`
- æ–°å¢ç«¯å£å¯ç”¨æ€§æ£€æµ‹ï¼š`isPortAvailable(port)`
- æ–°å¢ç«¯å£é€‰æ‹©ç­–ç•¥ï¼š`findAvailablePort(startPort, maxAttempts=20)`ï¼Œä»è¯·æ±‚ç«¯å£å¼€å§‹é¡ºå»¶æŸ¥æ‰¾å¯ç”¨ç«¯å£
- å¯åŠ¨å‰å…ˆé€‰å¯ç”¨ç«¯å£ï¼š
- æ‰¾ä¸åˆ°å¯ç”¨ç«¯å£æ—¶ï¼Œæ˜ç¡®è¿”å›é”™è¯¯å¹¶è¿›å…¥ `failed`
- æ‰¾åˆ°æ›¿ä»£ç«¯å£æ—¶ï¼Œå†™å…¥æ—¥å¿— `[WARN] Port X is busy, switched to Y`
- å°†å®é™…ç«¯å£å†™å› `mode-config`ï¼Œå¹¶æ›´æ–°è¿è¡Œæ€
- `codexProxy:status` è¿”å›çœŸå®ç«¯å£ï¼ˆä¼˜å…ˆè¿è¡Œæ€ç«¯å£ï¼‰

- `src/App.jsx`
- åœ¨ `loadCodexProxyStatus()` ä¸­åŒæ­¥ `codexProxyPort`ï¼Œç¡®ä¿ UI/Base URL ä¸å®é™…è¿è¡Œç«¯å£ä¸€è‡´

### 12.4 éªŒè¯ç»“æœ
- è¯­æ³•æ£€æŸ¥ï¼š`node --check main.js` é€šè¿‡
- æ„å»ºéªŒè¯ï¼š`npm run build` é€šè¿‡ï¼ˆ1479 modules, exit 0ï¼‰

### 12.5 éªŒæ”¶æ ‡å‡†ï¼ˆé€šè¿‡ï¼‰
- å½“ 1455 è¢«å ç”¨æ—¶ï¼Œç‚¹å‡»â€œå¯åŠ¨æœåŠ¡â€ä¸å†ç›´æ¥å¤±è´¥
- æœåŠ¡ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¯ç”¨ç«¯å£ï¼ˆ1456+ï¼‰å¹¶æˆåŠŸè¿›å…¥ `running`
- UI æ˜¾ç¤ºç«¯å£ä¸ Base URL è‡ªåŠ¨æ›´æ–°ä¸ºå®é™…ç«¯å£
- æ—¥å¿—å¯è§ç«¯å£åˆ‡æ¢è¯´æ˜
- è‹¥è¿ç»­ 20 ä¸ªç«¯å£éƒ½ä¸å¯ç”¨ï¼Œè¿”å›æ¸…æ™°é”™è¯¯æç¤ºå¹¶é˜»æ–­è¯¯å¯¼æ€§æˆåŠŸçŠ¶æ€

## Phase 12A - Codex Proxy Startup Failure Fix (2026-02-18)

### Root Cause
- `EADDRINUSE`: port `1455` was already in use.
- Previous startup path used configured port directly and failed fast.

### Incremental Fix
- `main.js`
- add `isPortAvailable(port)`
- add `findAvailablePort(startPort, maxAttempts=20)`
- before spawn, select first free port in `[requestedPort, requestedPort+19]`
- if no free port: set `failed` with clear error
- if switched: append `[WARN] Port X is busy, switched to Y`
- return runtime port from `codexProxy:status`

- `src/App.jsx`
- in `loadCodexProxyStatus()`, sync `codexProxyPort` from backend status

### Validation
- `node --check main.js` passed
- `npm run build` passed (`1479 modules`, `exit 0`)

### Acceptance Criteria
- Port 1455 occupied: clicking Start should not fail immediately.
- Service auto-switches to next free port and reaches `running`.
- UI port/Base URL updates to real runtime port.
- Logs contain the port-switch warning.
- If 20 consecutive ports are unavailable: explicit error and stay `failed`.

## Phase 12B - Port Detection Fix for Windows Binding (2026-02-18)

### Root Cause
- Previous port check used `127.0.0.1`.
- On Windows, this can be a false positive when another process already listens on `0.0.0.0:<port>`.
- Result: checker judged `1455` available, but codexProapi bound `0.0.0.0:1455` and still crashed with `EADDRINUSE`.

### Fix
- `main.js`
- `isPortAvailable()` now probes `0.0.0.0` (same bind host as codexProapi).
- add startup log: `[INFO] Requested port=X, selected port=Y` for visible verification.

### Verification
- local check script output: `isPortAvailable(1455,0.0.0.0)= false`
- `node --check main.js` passed
- `npm run build` passed (`1479 modules`, `exit 0`)

### Acceptance
- If `0.0.0.0:1455` is occupied, selected port must not remain `1455`.
- Start logs must show requested/selected port and (when switched) warn line.
- Service reaches `running` on next available port.

## Phase 12C - Backend Service Start Hardening (2026-02-18)

Reference: https://github.com/violettoolssite/codexProapi

### Alignment
- Keep codexProapi startup contract aligned with upstream:
- local HTTP service
- default port 1455 (overridable by `PORT`)
- health endpoint `/health`

### Hardening Changes
- `main.js`
- before spawn, probe `requestedPort` health; if an existing codexProapi is already healthy, mark `running` and attach state instead of failing.
- increase port search window from 20 to 200.
- add retry chain for race-condition `EADDRINUSE`:
  - detect `EADDRINUSE` from stderr
  - retry with next port (max 5 retries)
- enrich logs with retry diagnostics.

### Validation
- `node --check main.js` passed
- `npm run build` passed (`1479 modules`, `exit 0`)

### Acceptance
- clicking "å¯åŠ¨æœåŠ¡" must either:
- attach to an existing healthy codexProapi on requested port, or
- start a new healthy codexProapi on an available port.
- `EADDRINUSE` during startup should auto-retry instead of immediate hard fail.

## Phase 12D - Browser Launch + Manual Service Page (2026-02-18)

### Problem
- User expected backend startup to trigger browser entry page.
- Existing flow started process only, without opening codexProapi page.

### Changes
- `main.js`
- add `getCodexProxyHomeUrl(port)`
- add `openCodexProxyHomeInBrowser(port)`
- `codexProxy:start`: after successful start, auto-open browser by default (`openBrowser !== false`)
- add new IPC: `codexProxy:open` for manual browser open

- `preload.js`
- expose `codexProxyOpen(opts)`

- `src/App.jsx`
- `handleStartCodexProxy` now passes `openBrowser: true`
- add `handleOpenCodexProxyPage` and button `æ‰“å¼€æœåŠ¡é¡µ`

### Validation
- `node --check main.js` passed
- `node --check preload.js` passed
- `npm run build` passed (`1479 modules`, `exit 0`)

## Phase 13 - Codex åä»£æ¨¡å‹ Agent å¤šè½®å¾ªç¯ä¸­æ–­ä¿®å¤ (2026-02-18)

### é—®é¢˜
ä½¿ç”¨ Codex åä»£å‡ºæ¥çš„æ¨¡å‹ï¼ˆgpt-5.3-codex ç­‰ 5 ä¸ªæ¨¡å‹ï¼‰åœ¨ Agent æ¨¡å¼ä¸‹ï¼Œåªæ‰§è¡Œä¸€è½®å°±ä¸­æ–­é€€å‡ºï¼Œæ— æ³•æŒç»­å¤šè½®æ‰§è¡Œä»»åŠ¡ã€‚æ¯æ­¥æ‰§è¡Œåƒæ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡è”ç³»ã€‚

### æ ¹å› åˆ†æ
`codexProapi-main/src/proxy.js` ä¸­çš„ `messagesToInput()` å‡½æ•°å°†æ•´ä¸ªå¤šè½®å¯¹è¯å†å²ï¼ˆsystem/assistant/tool æ¶ˆæ¯ï¼‰**æ‹å¹³ä¸ºä¸€æ®µçº¯æ–‡æœ¬**ï¼Œä»¥å•æ¡ user æ¶ˆæ¯å‘é€ç»™ Codex Responses APIï¼š

1. **ç»“æ„åŒ–ä¸Šä¸‹æ–‡å®Œå…¨ä¸¢å¤±**ï¼šassistant çš„ `tool_calls` å˜ä¸º `"Assistant tool_call read_file: {...}"` çº¯æ–‡æœ¬ï¼Œtool ç»“æœå˜ä¸º `"Tool result (call_123): ..."` çº¯æ–‡æœ¬ã€‚æ¨¡å‹æ— æ³•ç†è§£è¿™æ˜¯å¤šè½®å·¥å…·è°ƒç”¨å¯¹è¯ã€‚
2. **ç³»ç»Ÿæç¤ºè¯ä¸¢å¤±**ï¼š`instructions` å­—æ®µå†™æ­»äº†ä¸€å¥è‹±æ–‡ `"You are a helpful AI assistant..."` è€Œéå®é™…çš„ç³»ç»Ÿæç¤ºè¯ã€‚
3. **`finish_reason` å§‹ç»ˆä¸º `stop`**ï¼šå³ä½¿æ¨¡å‹è¿”å›äº† tool_callsï¼Œä»£ç†ä¹Ÿå‘é€ `finish_reason: 'stop'` è€Œé `'tool_calls'`ã€‚

ç»“æœï¼šæ¨¡å‹æ¯æ¬¡éƒ½æ”¶åˆ°ä¸€æ®µæ— ç»“æ„çš„æ–‡æœ¬å¢™ï¼Œåªèƒ½ç»™å‡ºä¸€æ¬¡æ€§æ–‡æœ¬å›å¤ï¼ˆæ—  tool_callsï¼‰ï¼ŒAgent å¾ªç¯åˆ¤å®š"æ— å·¥å…·è°ƒç”¨â†’å®Œæˆ"ï¼Œç«‹å³é€€å‡ºã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. é‡å†™ `messagesToInput()`ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
å°† OpenAI Chat Completions æ ¼å¼çš„æ¶ˆæ¯æ•°ç»„è½¬ä¸º Codex Responses API åŸç”Ÿçš„ç»“æ„åŒ– `input` æ ¼å¼ï¼š

| Chat Completions è§’è‰² | Responses API é¡¹ç±»å‹ |
|---|---|
| `system`ï¼ˆé¦–æ¡ï¼‰ | æå–ä¸º `instructions` å­—æ®µ |
| `system`ï¼ˆåç»­æ³¨å…¥ï¼‰ | `{ type: 'message', role: 'developer' }` |
| `user` | `{ type: 'message', role: 'user' }` |
| `assistant`ï¼ˆçº¯æ–‡æœ¬ï¼‰ | `{ type: 'message', role: 'assistant', content: [{ type: 'output_text' }] }` |
| `assistant`ï¼ˆtool_callsï¼‰ | æ¯ä¸ª tc â†’ `{ type: 'function_call', call_id, name, arguments }` |
| `tool` | `{ type: 'function_call_output', call_id, output }` |

#### 2. ä¿®å¤ `buildResponsesRequest()`
- `instructions` ä» messages ä¸­çš„ç¬¬ä¸€æ¡ system æ¶ˆæ¯æå–ï¼ˆä¿ç•™å®Œæ•´æç¤ºè¯ï¼‰
- `input` ä½¿ç”¨ç»“æ„åŒ– items è€Œéæ‹å¹³æ–‡æœ¬

#### 3. ä¿®å¤ `finish_reason` æ˜ å°„
- `pipeStreamToOpenAI()`ï¼šæµç»“æŸæ—¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨ tool_callsï¼Œæœ‰åˆ™å‘é€ `finish_reason: 'tool_calls'`ï¼Œæ— åˆ™å‘é€ `'stop'`
- åŒæ—¶å¤„ç† `response.completed` / `response.done` äº‹ä»¶ä½œä¸ºæµç»“æŸä¿¡å·

#### 4. ä¿®å¤éæµå¼è·¯å¾„
- å°† `parseStreamToText()` é‡å†™ä¸º `parseStreamToResult()`ï¼ŒåŒæ—¶æ”¶é›†æ–‡æœ¬å’Œ tool_calls
- éæµå¼å“åº”ä¸­æ­£ç¡®è¿”å› `message.tool_calls` å’Œ `finish_reason: 'tool_calls'`

### ä¿®æ”¹æ–‡ä»¶
- `codexProapi-main/src/proxy.js`
  - `messagesToInput()` â€” å®Œå…¨é‡å†™ï¼Œè¿”å› `{ items, systemText }`
  - `buildResponsesRequest()` â€” ä½¿ç”¨ `systemText` ä½œä¸º `instructions`ï¼Œ`items` ä½œä¸º `input`
  - `pipeStreamToOpenAI()` â€” `finalize()` è¾…åŠ©å‡½æ•°åˆ¤æ–­ `finish_reason`ï¼Œå¤„ç† `response.completed`/`response.done`
  - `parseStreamToText()` â†’ `parseStreamToResult()` â€” æ”¶é›† text + toolCalls
  - `handleChatCompletions()` éæµå¼åˆ†æ”¯ â€” é€‚é…æ–°çš„ result ç»“æ„

### éªŒè¯æ–¹å¼
- Codex åä»£æ¨¡å‹åœ¨ Agent æ¨¡å¼ä¸‹åº”èƒ½ï¼š
  - é¦–è½®è¿”å› tool_callsï¼ˆè€Œéçº¯æ–‡æœ¬é€€å‡ºï¼‰
  - å¤šè½®æŒç»­æ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ
  - ä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§ï¼ˆæ¯è½®èƒ½çœ‹åˆ°å‰å‡ è½®çš„å·¥å…·è°ƒç”¨å’Œç»“æœï¼‰

## Phase 14 - Agent è·¨è½®æ¬¡ä¸Šä¸‹æ–‡ + é¡¹ç›®å¯¹è¯éš”ç¦» (2026-02-18)

### é—®é¢˜
1. **Codex æ¨¡å‹è·¨æ¶ˆæ¯ä¸Šä¸‹æ–‡ä¸¢å¤±**ï¼šAgent æ¨¡å¼æ¯æ¬¡å‘é€æ¶ˆæ¯åˆ›å»ºå…¨æ–°çš„ `AgentLoopController`ï¼Œåªä¼ å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸åŒ…å«ä¹‹å‰çš„å¯¹è¯å†å²ã€‚å¯¼è‡´è¿ç»­å¯¹è¯æ—¶æ¨¡å‹ä¸çŸ¥é“ä¹‹å‰åšè¿‡ä»€ä¹ˆã€‚
2. **ä¸åŒé¡¹ç›®å…±äº«å¯¹è¯è®°å½•ï¼ˆä¸¥é‡ bugï¼‰**ï¼š`chat:list` IPC è¿”å›æ‰€æœ‰ä¼šè¯ä¸æŒ‰é¡¹ç›®è¿‡æ»¤ï¼›`initSessions` çš„ `useEffect` ä¾èµ–æ•°ç»„ä¸ºç©ºï¼Œé¡¹ç›®åˆ‡æ¢æ—¶ä¸é‡æ–°åŠ è½½å¯¹åº”é¡¹ç›®çš„ä¼šè¯ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. Agent è·¨è½®æ¬¡ä¸Šä¸‹æ–‡ä¼ é€’
**æ–‡ä»¶**: `src/ProjectView.jsx`
- Agent å¯åŠ¨æ—¶ï¼Œä» `activeMessages` ä¸­æå–æœ€è¿‘ 20 æ¡ç”¨æˆ·/AI æ¶ˆæ¯
- æ„å»º `<conversation_history>` æ‘˜è¦å—ï¼Œé™„åŠ åœ¨å½“å‰ç”¨æˆ·æ¶ˆæ¯å‰é¢
- ä¼ é€’ç»™ `agentStart` çš„ `userMessage`ï¼Œè®© Agent å…·å¤‡å¯¹è¯ä¸Šä¸‹æ–‡

#### 2. é¡¹ç›®å¯¹è¯éš”ç¦»
**æ–‡ä»¶**: `main.js`
- `chat:list` IPC å¢åŠ  `opts.projectPath` è¿‡æ»¤å‚æ•°
- è·¯å¾„æ¯”è¾ƒæ—¶å¿½ç•¥å°¾éƒ¨æ–œæ å’Œå¤§å°å†™å·®å¼‚

**æ–‡ä»¶**: `preload.js`
- `chatList` æ”¯æŒä¼ é€’ `opts` å‚æ•°

**æ–‡ä»¶**: `src/ProjectView.jsx`
- `initSessions` çš„ `useEffect` ä¾èµ–æ”¹ä¸º `[project?.path]`ï¼Œé¡¹ç›®åˆ‡æ¢æ—¶è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–
- `chatList` è°ƒç”¨æ—¶ä¼ å…¥ `{ projectPath: project?.path }`
- `refreshSessions` åŒæ ·æŒ‰é¡¹ç›®è¿‡æ»¤
- åˆ‡æ¢é¡¹ç›®å‰å…ˆä¿å­˜å½“å‰ä¼šè¯

### ä¿®æ”¹æ–‡ä»¶æ¸…å•
| æ–‡ä»¶ | ä¿®æ”¹ç‚¹ |
|---|---|
| `main.js` | `chat:list` å¢åŠ  `projectPath` è¿‡æ»¤é€»è¾‘ |
| `preload.js` | `chatList(opts)` ä¼ å‚ |
| `src/ProjectView.jsx` | `initSessions` ä¾èµ–æ”¹ä¸º `[project?.path]`ï¼›`chatList` æŒ‰é¡¹ç›®è¿‡æ»¤ï¼›Agent å¯åŠ¨æ—¶æ³¨å…¥å¯¹è¯å†å²æ‘˜è¦ |

## Phase 15 - éªŒæ”¶æ™ºèƒ½åŒ– + ç»“è®ºä¿è¯ + ä¸Šä¸‹æ–‡å‹ç¼© + å¤šåª’ä½“è¾“å…¥ (2026-02-18)

### é—®é¢˜åˆ—è¡¨
1. éªŒæ”¶é—¸é—¨å¤ªæœºæ¢°ï¼Œtodo æœªå®Œæˆå°±é˜»æ–­å¾ªç¯ä¸æ‰§è¡Œï¼Œå¯¼è‡´åå¤ç©ºè½¬æœ€ç»ˆ FAILED
2. Agent æ‰§è¡Œç»“æŸåæœ‰æ—¶æ²¡æœ‰ç»“è®ºè¾“å‡ºï¼Œä½“éªŒå·®
3. å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡è¿‡é•¿æ²¡æœ‰å‹ç¼©æœºåˆ¶
4. ç¼ºå°‘å›¾ç‰‡ç²˜è´´ã€æ–‡ä»¶æ‹–æ‹½ã€é™„ä»¶ä¸Šä¼ ã€è”ç½‘æœç´¢ç­‰è¾“å…¥èƒ½åŠ›

### ä¿®å¤å†…å®¹

#### 1. æ™ºèƒ½éªŒæ”¶é—¸é—¨ï¼ˆ`agent-loop-controller.js` å®Œå…¨é‡å†™ï¼‰
- **é—¸é—¨ä¸å† FAIL**ï¼šé‡è¯• 3 è½®åï¼Œæ— è®ºæ˜¯å¦å…¨éƒ¨é€šè¿‡éƒ½æ ‡è®°ä¸º COMPLETEï¼Œé™„å¸¦ `gateWarnings`
- **ç³»ç»Ÿæ¶ˆæ¯æ›´æ™ºèƒ½**ï¼šæŒ‡å¯¼æ¨¡å‹"èƒ½ä¿®å°±ä¿®ï¼Œä¿®ä¸äº†å°±ç»™ç»“è®º"ï¼Œä¸å†ç©ºè½¬
- **æœ€å¤§è¿­ä»£åè¯·æ±‚ç»“è®º**ï¼šè¾¾åˆ° maxIterations æ—¶é¢å¤–è¯·æ±‚ä¸€è½® LLM è·å–æœ€ç»ˆæ€»ç»“
- **ç§»é™¤ `gate-failed` äº‹ä»¶**ï¼šä¸å†æœ‰ FAILED çŠ¶æ€ï¼Œå§‹ç»ˆ COMPLETE

#### 2. å¿…é¡»è¾“å‡ºç»“è®ºï¼ˆ`mode-agent.js` é‡å†™ï¼‰
- æ–°å¢"æ ¸å¿ƒåŸåˆ™"ï¼šä¸¥æ ¼éµå®ˆç”¨æˆ·æŒ‡ä»¤ã€æ¯æ¬¡å¿…é¡»æœ‰ç»“è®ºã€æŒç»­ä¿æŒä¸Šä¸‹æ–‡
- éªŒæ”¶åè®®ä»"æœºæ¢°æ£€æŸ¥"æ”¹ä¸º"æ™ºèƒ½éªŒæ”¶"ï¼šæ¨¡å‹è‡ªä¸»åˆ¤æ–­éªŒæ”¶ç­–ç•¥å’Œå…³é”®æ£€æŸ¥ç‚¹
- ç»“è®ºæ ¼å¼æ˜ç¡®ï¼šå®Œæˆæ€»ç»“ + å…³é”®æ–‡ä»¶ + ä½¿ç”¨æ–¹å¼ + é—ç•™äº‹é¡¹

#### 3. æ™ºèƒ½ä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆ`agent-loop-controller.js`ï¼‰
- æ–°å¢ `_compressContextIfNeeded()` æ–¹æ³•
- æ¯è½® LLM è°ƒç”¨å‰ä¼°ç®— token ç”¨é‡
- è¶…è¿‡ 80% é¢„ç®—æ—¶è‡ªåŠ¨å‹ç¼©æ—§æ¶ˆæ¯ä¸ºæ‘˜è¦ï¼Œä¿ç•™æœ€è¿‘å¯¹è¯
- æ‘˜è¦ä¿ç•™å·¥å…·åã€å…³é”®è¯´æ˜å’Œç»“æœé¢„è§ˆï¼Œä¸ä¸¢å¤±å…³é”®ä¿¡æ¯
- æ–°å¢ `_estimateTokenCount()` å­—ç¬¦çº§ token ä¼°ç®—

#### 4. ä¸Šä¸‹æ–‡ç”¨é‡æŒ‡ç¤ºå™¨ï¼ˆ`ProjectView.jsx`ï¼‰
- è¾“å…¥æ¡†å³ä¸‹è§’æ–°å¢ SVG ç¯å½¢è¿›åº¦æ¡
- å®æ—¶è®¡ç®— history + input çš„ token å æ¯”
- ä¸‰è‰²æ¸å˜ï¼šç»¿è‰²(<60%) â†’ é»„è‰²(60-85%) â†’ çº¢è‰²(>85%)
- hover æ˜¾ç¤ºå…·ä½“ token æ•°å€¼

#### 5. å›¾ç‰‡ç²˜è´´ï¼ˆ`ProjectView.jsx`ï¼‰
- textarea çš„ `onPaste` äº‹ä»¶ç›‘å¬ clipboard å›¾ç‰‡
- è‡ªåŠ¨åˆ›å»º ObjectURL é¢„è§ˆ
- ä»¥ attachment å½¢å¼å­˜å‚¨

#### 6. æ–‡ä»¶æ‹–æ‹½ï¼ˆ`ProjectView.jsx`ï¼‰
- è¾“å…¥æ¡†åŒºåŸŸ `onDragOver`/`onDragLeave`/`onDrop` å¤„ç†
- æ‹–æ‹½æ—¶è“è‰²é«˜äº®æç¤º"æ¾å¼€ä»¥æ·»åŠ æ–‡ä»¶"
- æ”¯æŒå›¾ç‰‡é¢„è§ˆå’Œä»»æ„æ–‡ä»¶ç±»å‹

#### 7. é™„ä»¶ä¸Šä¼ æŒ‰é’®ï¼ˆ`ProjectView.jsx`ï¼‰
- æ–°å¢ Paperclip å›¾æ ‡æŒ‰é’®è§¦å‘éšè— file input
- æ”¯æŒå¤šç§æ ¼å¼ï¼šimageã€txtã€mdã€jsonã€js/tsã€pyã€htmlã€cssã€csvã€xmlã€yaml ç­‰
- é™„ä»¶é¢„è§ˆæ æ˜¾ç¤ºç¼©ç•¥å›¾/æ–‡ä»¶åï¼Œå¯å•ç‹¬åˆ é™¤

#### 8. è”ç½‘æœç´¢å›¾æ ‡ï¼ˆ`ProjectView.jsx`ï¼‰
- Globe å›¾æ ‡ä¿ç•™åœ¨å·¥å…·æ ä¸­ï¼Œä¸ºåç»­è”ç½‘æœç´¢åŠŸèƒ½é¢„ç•™å…¥å£

### ä¿®æ”¹æ–‡ä»¶æ¸…å•
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/core/agent-loop-controller.js` | å®Œå…¨é‡å†™ï¼šæ™ºèƒ½é—¸é—¨ã€ä¸Šä¸‹æ–‡å‹ç¼©ã€ç»“è®ºä¿è¯ |
| `src/prompts/mode-agent.js` | å®Œå…¨é‡å†™ï¼šæ ¸å¿ƒåŸåˆ™ã€æ™ºèƒ½éªŒæ”¶ã€ç»“è®ºæ ¼å¼ |
| `src/ProjectView.jsx` | å›¾ç‰‡ç²˜è´´/æ‹–æ‹½/é™„ä»¶/ä¸Šä¸‹æ–‡æŒ‡ç¤ºå™¨/Paperclipå¯¼å…¥ |

---

## Phase 16 - Codex æ¨¡å‹æ‰§è¡Œä¸­æ–­ä¿®å¤ + è®¡åˆ’è¯„ä¼°å¢å¼º + è”ç½‘æœç´¢åŠŸèƒ½

### é—®é¢˜æè¿°
1. **Codex åä»£æ¨¡å‹æ‰§è¡Œè®¡åˆ’æ—¶æå‰åœæ­¢**ï¼šæ‰§è¡Œå‡ æ­¥å°±ä¸å†ç»§ç»­ï¼Œæ— æ³•å®Œæˆæ•´ä¸ªè®¡åˆ’æ¸…å•
2. **è®¡åˆ’è¯„ä¼°å¤ªç®€å•**ï¼šè¯„ä¼°ç»´åº¦ä¸è¶³ã€ä¸è¾“å‡ºå¯è§è¯„ä¼°ç»“æœã€ç¼ºå°‘é€šè¿‡/ä¸é€šè¿‡é—¨æ§›
3. **è”ç½‘æœç´¢åŠŸèƒ½ä¸å¯ç”¨**ï¼šGlobe æŒ‰é’®åªæ˜¯å ä½ç¬¦ï¼Œæ— å¼€å…³åé¦ˆï¼Œæ¨¡å‹æ— æ³•å®é™…ä½¿ç”¨

### é—®é¢˜åˆ†æ

**Codex ä¸­æ–­çš„æ ¹å› **ï¼š
- å·¥å…·æ‰§è¡Œç»“æœï¼ˆæ–‡ä»¶å†…å®¹ã€ç›®å½•åˆ—è¡¨ï¼‰å¤ªå¤§ï¼Œè¿…é€Ÿå¡«æ»¡ Codex æ¨¡å‹æœ‰é™çš„ä¸Šä¸‹æ–‡çª—å£
- æ¯è½®æ‰§è¡Œåç¼ºå°‘"ç»§ç»­æ‰§è¡Œ"æç¤ºï¼Œæ¨¡å‹ä¸çŸ¥é“è¿˜æœ‰æœªå®Œæˆçš„è®¡åˆ’é¡¹
- ä¸Šä¸‹æ–‡å‹ç¼©é˜ˆå€¼ 80% å¤ªé«˜ï¼ŒCodex æ¨¡å‹ä¸Šä¸‹æ–‡æ¯”æ ‡å‡†æ¨¡å‹çŸ­
- Responses API è¯·æ±‚ä¸­ç¼ºå°‘ `truncation` å’Œ `max_output_tokens` å‚æ•°

**è®¡åˆ’è¯„ä¼°ä¸è¶³çš„æ ¹å› **ï¼š
- è¯„ä¼°ç»´åº¦åªæœ‰ 8 ä¸ªï¼Œç¼ºå°‘"é£é™©è¯†åˆ«"å’Œ"ä¸€è‡´æ€§"
- è¯„ä¼°ç»“æœä¸è¦æ±‚è¾“å‡ºï¼ˆ"åœ¨å¿ƒä¸­æ‰“åˆ†"ï¼‰ï¼Œç”¨æˆ·çœ‹ä¸åˆ°
- é€šè¿‡é—¨æ§›æ˜¯ 55/80ï¼ˆâ‰ˆ69%ï¼‰ï¼Œæ ‡å‡†å¤ªä½

**è”ç½‘æœç´¢ä¸å¯ç”¨çš„æ ¹å› **ï¼š
- Globe æŒ‰é’®æ— çŠ¶æ€åˆ‡æ¢ï¼Œåªæ˜¯é™æ€å›¾æ ‡
- æœç´¢å·¥å…·å§‹ç»ˆæ³¨å†Œï¼Œæ— æ³•æŒ‰éœ€å¼€å…³
- æœç´¢å¼•æ“åªæœ‰ DuckDuckGo Instant APIï¼ˆè¿”å›ç»“æœæœ‰é™ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### 1. Codex æ¨¡å‹æ‰§è¡Œä¸­æ–­ä¿®å¤

**a. å·¥å…·ç»“æœæˆªæ–­ï¼ˆ`agent-loop-controller.js`ï¼‰**
- å·¥å…·ç»“æœè¶…è¿‡ 8000 å­—ç¬¦æ—¶è‡ªåŠ¨æˆªæ–­
- ä¿ç•™å¼€å¤´ 3500 å­—ç¬¦ + ç»“å°¾ 1500 å­—ç¬¦ï¼Œä¸­é—´æ ‡è®° `[å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­ä¸­é—´éƒ¨åˆ†]`
- ç¡®ä¿ Codex æ¨¡å‹èƒ½çœ‹åˆ°å…³é”®ä¿¡æ¯è€Œä¸è¢«æ— å…³å†…å®¹æ·¹æ²¡

**b. è‡ªåŠ¨æ³¨å…¥ç»§ç»­æ‰§è¡Œæç¤ºï¼ˆ`agent-loop-controller.js`ï¼‰**
- æ¯æ¬¡å·¥å…·æ‰§è¡Œå®Œæˆåï¼Œæ£€æŸ¥ TodoStore ä¸­æœªå®Œæˆé¡¹æ•°é‡
- è‹¥æœ‰å‰©ä½™å¾…åŠé¡¹ï¼Œè‡ªåŠ¨æ³¨å…¥ system æ¶ˆæ¯æé†’æ¨¡å‹ç»§ç»­
- æ ¼å¼ï¼š`[æ‰§è¡Œè¿›åº¦] å·²å®Œæˆ X/Y é¡¹ï¼Œè¿˜å‰© Z é¡¹æœªå®Œæˆã€‚è¯·ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå¾…åŠé¡¹ï¼Œä¸è¦åœä¸‹æ¥ã€‚`

**c. æ›´ç§¯æçš„ä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆ`agent-loop-controller.js`ï¼‰**
- å‹ç¼©é˜ˆå€¼ä» 80% é™è‡³ 60%ï¼ˆCodex æ¨¡å‹ä¸Šä¸‹æ–‡è¾ƒçŸ­ï¼‰
- æœ€å°‘ä¿ç•™ 4 æ¡æ¶ˆæ¯å³å¯è§¦å‘å‹ç¼©ï¼ˆåŸæ¥æ˜¯ 6 æ¡ï¼‰
- ä¿ç•™æ¶ˆæ¯æ¯”ä¾‹æ”¹ä¸º 30%ï¼ˆåŸæ¥æ˜¯ 50%ï¼‰
- å‹ç¼©æ‘˜è¦åŒæ—¶åŒ…å« TodoStore è¿›åº¦ä¿¡æ¯
- è·³è¿‡å·²æœ‰çš„å‹ç¼©æ‘˜è¦æ¶ˆæ¯ï¼Œé¿å…é‡å¤åµŒå¥—

**d. Codex Responses API ä¼˜åŒ–ï¼ˆ`proxy.js`ï¼‰**
- è¯·æ±‚ä½“æ–°å¢ `truncation: 'auto'`ï¼šAPI è‡ªåŠ¨å¤„ç†è¶…é•¿è¾“å…¥
- è¯·æ±‚ä½“æ–°å¢ `max_output_tokens: 16384`ï¼šç¡®ä¿è¾“å‡ºä¸è¢«æå‰æˆªæ–­
- `function_call_output` è¶…è¿‡ 6000 å­—ç¬¦æ—¶åœ¨ proxy å±‚é¢„æˆªæ–­

#### 2. è®¡åˆ’è¯„ä¼°å¢å¼ºï¼ˆ`mode-agent.js`ï¼‰

- è¯„ä¼°ç»´åº¦ä» 8 ä¸ªæ‰©å±•åˆ° 10 ä¸ªï¼šæ–°å¢ã€Œé£é™©è¯†åˆ«ã€å’Œã€Œä¸€è‡´æ€§ã€
- æ€»åˆ†åˆ¶æ”¹ä¸º 100 åˆ†åˆ¶ï¼Œé—¨æ§›æå‡ï¼š
  - â‰¥ 75/100 â†’ âœ… é€šè¿‡
  - 65-74 â†’ âš ï¸ å¯æ‰§è¡Œä½†éœ€è¡¥å¼º
  - < 65 â†’ âŒ ç¦æ­¢æ‰§è¡Œ
  - ä»»ä½•ç»´åº¦ â‰¤ 4 â†’ âŒ ä¸¥é‡ç¼ºé™·
- **å¿…é¡»è¾“å‡ºè¯„ä¼°æ‘˜è¦**ï¼ˆå¸¦æ ¼å¼åŒ–çš„åˆ†æ•°è¡¨ï¼‰ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°
- æ¯ä¸ªä½åˆ†ç»´åº¦ç»™å‡ºå…·ä½“çš„æ”¹è¿›ç­–ç•¥

#### 3. è”ç½‘æœç´¢åŠŸèƒ½ï¼ˆå‰ç«¯ + åç«¯ + å·¥å…·ï¼‰

**a. å‰ç«¯å¼€å…³ UIï¼ˆ`ProjectView.jsx`ï¼‰**
- Globe æŒ‰é’®æ”¹ä¸ºåˆ‡æ¢æŒ‰é’®ï¼Œæœ‰ `webSearchEnabled` çŠ¶æ€
- å¼€å¯æ—¶ï¼šè“è‰²é«˜äº® + è“è‰²è¾¹æ¡† + æ˜¾ç¤º"è”ç½‘"æ–‡å­—
- å…³é—­æ—¶ï¼šç°è‰²å›¾æ ‡ï¼Œä¸å…¶ä»–å·¥å…·æŒ‰é’®ä¸€è‡´
- å¼€å…³çŠ¶æ€é€šè¿‡ `agentStart` å‚æ•°ä¼ é€’åˆ°åç«¯

**b. åç«¯å·¥å…·è¿‡æ»¤ï¼ˆ`agent-loop-controller.js` + `agent-ipc.js`ï¼‰**
- `agentStart` æ¥æ”¶å¹¶å­˜å‚¨ `webSearchEnabled` å‚æ•°
- `_callLLM` è·å–å·¥å…·å®šä¹‰æ—¶ï¼Œè‹¥è”ç½‘æœªå¼€å¯åˆ™è¿‡æ»¤æ‰ `web_search` å’Œ `web_fetch`
- ç¡®ä¿æ¨¡å‹åªåœ¨ç”¨æˆ·æˆæƒè”ç½‘æ—¶æ‰èƒ½ä½¿ç”¨æœç´¢å·¥å…·

**c. æœç´¢å¼•æ“å¢å¼ºï¼ˆ`web-search.js`ï¼‰**
- æ–°å¢ SearXNG å…¬å…±å®ä¾‹æœç´¢ï¼ˆ3 ä¸ªå®ä¾‹è½®è¯¢ï¼ŒJSON APIï¼‰
- æ–°å¢ DuckDuckGo HTML æœç´¢ï¼ˆè§£æ HTML ç»“æœé¡µï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®ï¼‰
- ä¿ç•™åŸæœ‰ DuckDuckGo Instant API
- ä¸‰å±‚é™çº§ï¼šSearXNG â†’ DDG Instant â†’ DDG HTML
- è¿”å›æœ€å¤š 8 æ¡ç»“æœï¼Œæ¯æ¡å«æ ‡é¢˜ã€URLã€æ‘˜è¦

### ä¿®æ”¹æ–‡ä»¶æ¸…å•
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/core/agent-loop-controller.js` | å·¥å…·ç»“æœæˆªæ–­ã€ç»§ç»­æ‰§è¡Œæç¤ºæ³¨å…¥ã€å‹ç¼©é˜ˆå€¼é™ä½ã€webSearchEnabled è¿‡æ»¤ |
| `codexProapi-main/src/proxy.js` | buildResponsesRequest æ–°å¢ truncation/max_output_tokensï¼Œfunction_call_output é¢„æˆªæ–­ |
| `src/prompts/mode-agent.js` | æ–¹æ¡ˆè‡ªè¯„åè®®æ‰©å±•ä¸º 10 ç»´åº¦ 100 åˆ†åˆ¶ï¼Œå¿…é¡»è¾“å‡ºè¯„ä¼°æ‘˜è¦ |
| `src/ProjectView.jsx` | Globe æŒ‰é’®æ”¹ä¸ºåˆ‡æ¢å¼€å…³ï¼Œä¼ é€’ webSearchEnabled å‚æ•° |
| `src/main-process/agent-ipc.js` | æ¥æ”¶å¹¶ä¼ é€’ webSearchEnabled å‚æ•° |
| `src/tools/web-search.js` | é‡å†™ï¼šä¸‰å±‚æœç´¢å¼•æ“é™çº§ï¼ˆSearXNG/DDG Instant/DDG HTMLï¼‰ |

---

## Phase 19 â€” ç»„ä»¶å®½åº¦è‡ªé€‚åº” + ä»»åŠ¡æ¸…å•å¼ºåˆ¶å®Œæˆæœºåˆ¶å¢å¼º

**æ—¥æœŸ**ï¼š2026-02-18

### é—®é¢˜è¯Šæ–­

1. **å·¥å…·è°ƒç”¨ç»„ä»¶ï¼ˆå¦‚"æ–°å»ºæ–‡ä»¶"ï¼‰åœ¨çª„å®½åº¦ä¸‹æ˜¾ç¤ºå¼‚å¸¸**ï¼šæ ‡é¢˜æ–‡å­—ç«–æ’æ˜¾ç¤ºï¼ŒæŒ‰é’®è¢«æŒ¤å‹å˜å½¢ã€‚æ ¹å› æ˜¯ `.agent-step-header` ä½¿ç”¨äº† `flex-wrap: wrap`ï¼Œå®¹å™¨å®½åº¦ä¸è¶³æ—¶å­å…ƒç´ é€ä¸ªæ¢è¡Œã€‚
2. **ä»»åŠ¡æ¸…å•æœªå®Œæˆå°±ç»“æŸæ‰§è¡Œ**ï¼šAgent å®Œæˆéƒ¨åˆ† todo åï¼Œæ¨¡å‹åœæ­¢è°ƒç”¨å·¥å…·å¹¶è¾“å‡ºç»“è®ºã€‚`_noToolRetries`ï¼ˆä¸Šé™ 3ï¼‰+ éªŒæ”¶é—¸é—¨ï¼ˆä¸Šé™ 3ï¼‰å…± 6 æ¬¡æœºä¼šï¼Œå¯¹é¡½å›ºæ¨¡å‹ä»ä¸å¤Ÿã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. ç»„ä»¶å®½åº¦è‡ªé€‚åº”ï¼ˆCSS å¸ƒå±€ä¿®å¤ï¼‰

**æ–‡ä»¶**ï¼š`src/styles/ask-theme.css`

| é€‰æ‹©å™¨ | ä¿®æ”¹ | ç›®çš„ |
|---|---|---|
| `.agent-step-card` | æ–°å¢ `min-width:0; width:100%; box-sizing:border-box` | å¡ç‰‡ä¸è¶…å‡ºçˆ¶å®¹å™¨ |
| `.agent-step-header` | `flex-wrap` â†’ `nowrap` + `overflow:hidden` | ç¦æ­¢å­å…ƒç´ æ¢è¡Œ |
| `.agent-step-title` | åŠ  `white-space:nowrap; flex-shrink:0` | æ ‡é¢˜ä¸æ¢è¡Œ |
| `.agent-step-path` | `max-width:280px` â†’ `flex:1; min-width:0` | è·¯å¾„å¼¹æ€§ç¼©æ”¾ |
| `.agent-step-actions` | åŠ  `flex-shrink:0; white-space:nowrap` | æŒ‰é’®ä¸è¢«æŒ¤å‹ |
| `.agent-step-btn` | padding ç¼©å° + `white-space:nowrap; flex-shrink:0` | æŒ‰é’®æ–‡å­—ä¸æ¢è¡Œ |
| `.agent-step-number` | åŠ  `white-space:nowrap; flex-shrink:0` | ç¼–å·ä¸æ¢è¡Œ |

#### 2. ä»»åŠ¡æ¸…å•å¼ºåˆ¶å®Œæˆæœºåˆ¶å¢å¼º

**æ–‡ä»¶**ï¼š`src/core/agent-loop-controller.js`

- `maxIterations`ï¼š25 â†’ 40
- `_noToolRetries` ä¸Šé™ï¼š3 â†’ 5
- å¼ºåˆ¶ç»§ç»­æ¶ˆæ¯åŒ…å«å…·ä½“æœªå®Œæˆ todo çš„ id + content åˆ—è¡¨
- ç§»é™¤æ¨¡å‹çš„æ— å·¥å…·è°ƒç”¨ assistant æ¶ˆæ¯ï¼ˆpop "ä¼ªç»“è®º"ï¼‰ï¼Œé˜²æ­¢è¯¯å¯¼
- éªŒæ”¶é—¸é—¨åœ¨æœ‰æœªå®Œæˆ todo æ—¶ï¼ŒåŠ¨æ€æå‡æœ€å¤§é‡è¯•æ¬¡æ•°åˆ° 5
- é—¸é—¨é‡è¯•æ—¶å›é€€ `_noToolRetries` 2 æ¬¡ï¼Œè®© Agent é‡æ–°è·å¾—å¼ºåˆ¶æ‰§è¡Œæœºä¼š

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/styles/ask-theme.css` | agent-step-card/header/title/path/actions/btn/number å¸ƒå±€ä¿®å¤ |
| `src/core/agent-loop-controller.js` | maxIterationsâ†’40ã€_noToolRetriesâ†’5ã€å¼ºåˆ¶æ¶ˆæ¯å« todo è¯¦æƒ…ã€éªŒæ”¶é—¸é—¨åŠ¨æ€é‡è¯• |

---

## Phase 20 â€” å€Ÿé‰´ Cursor å¤„ç†æ–¹å¼ï¼štool_choice åè®®æ§åˆ¶æ›¿ä»£æš´åŠ›æ³¨å…¥

**æ—¥æœŸ**ï¼š2026-02-18

### é—®é¢˜è¯Šæ–­

Codex åä»£æ¨¡å‹åœ¨ Agent æ¨¡å¼ä¸‹è¡Œä¸ºåå·®çš„æ ¹æœ¬åŸå› ä¸æ˜¯æ¨¡å‹ä¸å¤Ÿé…åˆï¼Œè€Œæ˜¯æˆ‘ä»¬çš„å¤„ç†æ–¹å¼å¤ªç”Ÿç¡¬ï¼š

1. **Proxy å±‚**ï¼šåœ¨ `instructions` ä¸­å¼ºè¡Œè¿½åŠ  `[CRITICAL BEHAVIOR RULE]` é•¿æ®µè‹±æ–‡ï¼Œå’Œæ¨¡å‹åŸç”Ÿè¡Œä¸ºå†²çª
2. **Agent Loop**ï¼šæ¯å½“æ¨¡å‹ä¸è°ƒå·¥å…·å°±æ³¨å…¥ `[å¼ºåˆ¶æ‰§è¡Œ]` ç³»ç»Ÿæ¶ˆæ¯ï¼ˆæœ€å¤š5æ¬¡ï¼‰ï¼Œæ¯è½®å·¥å…·æ‰§è¡Œåè¿˜æ³¨å…¥ `[æ‰§è¡Œè¿›åº¦]` æ¶ˆæ¯â€”â€”ä¸Šä¸‹æ–‡è¢«å¤§é‡éè‡ªç„¶æ¶ˆæ¯æ±¡æŸ“
3. **System Prompt**ï¼š`system-base.js` ä¸­æœ‰å¤§æ®µ"é”™è¯¯ç¤ºèŒƒ/æ­£ç¡®ç¤ºèŒƒ"çš„è¯´æ•™å¼å†…å®¹ï¼Œ`mode-agent.js` ä¸­æœ‰"ç»å¯¹ç¦æ­¢""æå…¶é‡è¦"ç­‰è¿‡åº¦å¼ºè°ƒæªè¾

**Cursor çš„åšæ³•**ï¼šä¸é€šè¿‡ prompt å¼ºè¿«æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡ **`tool_choice` API å‚æ•°**åœ¨åè®®å±‚æ§åˆ¶ã€‚å½“çŸ¥é“æ¨¡å‹åº”è¯¥è°ƒå·¥å…·æ—¶ï¼Œè®¾ç½® `tool_choice: "required"`ï¼Œæ¨¡å‹åœ¨ API å±‚é¢å°±å¿…é¡»è¿”å›å·¥å…·è°ƒç”¨ã€‚è¿™æ˜¯ OpenAI API æ ‡å‡†åè®®ï¼Œæ‰€æœ‰å…¼å®¹æ¨¡å‹éƒ½æ”¯æŒï¼Œä¸éœ€è¦é¢å¤– promptã€‚

### ä¿®æ”¹æ–¹æ¡ˆï¼ˆ5 å¤„æ”¹åŠ¨ï¼‰

#### 1. Proxy å±‚æ¸…ç†ï¼ˆ`codexProapi-main/src/proxy.js`ï¼‰

ç§»é™¤ `buildResponsesRequest` ä¸­è¿½åŠ çš„ `[CRITICAL BEHAVIOR RULE]` æ–‡æœ¬ï¼Œ`instructions` ä¿æŒçº¯å‡€ï¼š

```diff
- instructions: (systemText || '...') + '\n\n[CRITICAL BEHAVIOR RULE] ...'
+ instructions: systemText || 'You are a helpful AI assistant.'
```

#### 2. LLM Gateway æ”¯æŒ tool_choiceï¼ˆ`src/core/llm-gateway.js`ï¼‰

`streamChat` æ–¹æ³•æ–°å¢ `toolChoice` å‚æ•°ï¼Œä¼ é€’åˆ°è¯·æ±‚ä½“çš„ `tool_choice` å­—æ®µï¼š

```js
if (tools && tools.length > 0) {
  body.tools = [...];
  if (toolChoice) body.tool_choice = toolChoice;
}
```

#### 3. Agent Loop é‡æ„ï¼ˆ`src/core/agent-loop-controller.js`ï¼‰

**æ ¸å¿ƒæ”¹åŠ¨**ï¼šç”¨ `tool_choice` åè®®æ§åˆ¶æ›¿ä»£æ¶ˆæ¯æ³¨å…¥

- æ–°å¢ `_resolveToolChoice()` æ–¹æ³•ï¼šæ£€æŸ¥ `_forceToolRequired` æ ‡å¿—ï¼Œè¿”å› `"required"` æˆ– `"auto"`
- æ–°å¢ `_forceToolRequired` çŠ¶æ€å­—æ®µ
- `_callLLM(toolChoice)` æ¥å—å‚æ•°ï¼Œä¼ é€’ç»™ LLM Gateway
- **æ¨¡å‹æœªè°ƒå·¥å…·æ—¶çš„å¤„ç†ï¼ˆé‡æ„å‰ vs é‡æ„åï¼‰**ï¼š

| é‡æ„å‰ï¼ˆæš´åŠ›æ³¨å…¥ï¼‰ | é‡æ„åï¼ˆåè®®æ§åˆ¶ï¼‰ |
|---|---|
| æ³¨å…¥é•¿æ®µ"å¼ºåˆ¶æ‰§è¡Œ"ç³»ç»Ÿæ¶ˆæ¯ | æ·»åŠ ç®€æ´ user æ¶ˆæ¯"ç»§ç»­æ‰§è¡Œï¼Œè¿˜å‰©ï¼šxxx" |
| åœ¨ messages é‡Œå¡å‘½ä»¤å¼æŒ‡ä»¤ | è®¾ç½® `_forceToolRequired = true` |
| æ¯è½®å·¥å…·åæ³¨å…¥"æ‰§è¡Œè¿›åº¦"æ¶ˆæ¯ | ä¸æ³¨å…¥ä»»ä½•å™ªéŸ³æ¶ˆæ¯ |
| éªŒæ”¶é—¸é—¨æ³¨å…¥é•¿æ®µç³»ç»Ÿæ¶ˆæ¯ | ç”¨ user æ¶ˆæ¯ç®€æ´æé†’ |

- æœ€ç»ˆç»“è®ºè¯·æ±‚ä¹Ÿæ”¹ä¸º `tool_choice: "none"`ï¼ˆä¸ä¼  toolsï¼‰ï¼Œè®©æ¨¡å‹è‡ªç„¶è¾“å‡ºçº¯æ–‡æœ¬

#### 4. ç²¾ç®€ System Promptï¼ˆ`src/prompts/system-base.js`ï¼‰

ä» 46 è¡Œç¼©å‡åˆ° 14 è¡Œã€‚ç§»é™¤ï¼š
- "æœ€é‡è¦çš„è¡Œä¸ºè§„åˆ™"è¯´æ•™æ®µè½
- "é”™è¯¯ç¤ºèŒƒ/æ­£ç¡®ç¤ºèŒƒ"ç¤ºä¾‹
- "è¯­è¨€è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰"å†—ä½™æ®µè½

ä¿ç•™ï¼šæ ¸å¿ƒåŸåˆ™ï¼ˆå‡†ç¡®/å®‰å…¨/é«˜æ•ˆ/ç®€æ´ï¼‰+ å·¥å…·ä½¿ç”¨åŸºæœ¬è§„èŒƒ

#### 5. ç²¾ç®€ Agent Promptï¼ˆ`src/prompts/mode-agent.js`ï¼‰

ä» 165 è¡Œç¼©å‡åˆ° ~100 è¡Œã€‚ç§»é™¤ï¼š
- "è¾“å‡ºæ ¼å¼è§„èŒƒï¼ˆæå…¶é‡è¦ï¼‰"ä¸­çš„è¿‡åº¦å¼ºè°ƒå’Œç¦æ­¢åˆ—è¡¨
- "æ ¸å¿ƒåŸåˆ™"ä¸­çš„é‡å¤å†…å®¹ï¼ˆä¸ system-base é‡å ï¼‰
- å†—ä½™çš„"ä¼˜åŒ–ç­–ç•¥"è¯¦ç»†è¯´æ˜

ä¿ç•™ï¼šæ‰§è¡Œæµç¨‹ + æŠ€æœ¯é€‰å‹ + æ–¹æ¡ˆè‡ªè¯„åè®® + Todo/éªŒæ”¶/ç»“è®ºè§„èŒƒ

### è®¾è®¡å“²å­¦å¯¹æ¯”

| ç»´åº¦ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆï¼ˆCursor å¼ï¼‰ |
|---|---|---|
| æ§åˆ¶å±‚é¢ | Prompt å±‚ï¼ˆæ–‡å­—è¯´æ•™ï¼‰ | API å±‚ï¼ˆ`tool_choice` å‚æ•°ï¼‰ |
| æ¶ˆæ¯çº¯å‡€åº¦ | æ¯è½®æ³¨å…¥1-2æ¡ç³»ç»Ÿæ¶ˆæ¯ | ä»…åœ¨å¿…è¦æ—¶æ·»åŠ ç®€æ´ user æ¶ˆæ¯ |
| æ¨¡å‹å…¼å®¹æ€§ | ä¾èµ–æ¨¡å‹ç†è§£é•¿æŒ‡ä»¤ | æ‰€æœ‰ OpenAI å…¼å®¹æ¨¡å‹åŸç”Ÿæ”¯æŒ |
| ä¸Šä¸‹æ–‡æ¶ˆè€— | æ¯è½®å¢åŠ  ~200 tokens å™ªéŸ³ | æ¥è¿‘é›¶é¢å¤–æ¶ˆè€— |
| å¯ç»´æŠ¤æ€§ | æ•£å¸ƒåœ¨ proxy/prompt/loop ä¸‰å¤„ | é›†ä¸­åœ¨ agent-loop ä¸€å¤„ |

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `codexProapi-main/src/proxy.js` | ç§»é™¤ instructions ä¸­çš„ CRITICAL BEHAVIOR RULE |
| `src/core/llm-gateway.js` | streamChat æ–°å¢ toolChoice å‚æ•° |
| `src/core/agent-loop-controller.js` | ç”¨ _resolveToolChoice + _forceToolRequired æ›¿ä»£æ¶ˆæ¯æ³¨å…¥ï¼›ç§»é™¤æ‰§è¡Œè¿›åº¦å™ªéŸ³ |
| `src/prompts/system-base.js` | ç²¾ç®€åˆ°14è¡Œï¼Œå»æ‰è¯´æ•™å¼å†…å®¹ |
| `src/prompts/mode-agent.js` | ç²¾ç®€åˆ°~100è¡Œï¼Œä¿ç•™æ ¸å¿ƒåè®® |

---

## Phase 21 â€” åŸºäº Cursor é€†å‘å·¥ç¨‹æ–‡æ¡£çš„å…¨é¢å¯¹é½ï¼ˆ2026-02-18/19ï¼‰

### ä¿¡æ¯æ¥æº

- **sshh12 gist**ï¼šCursor å®Œæ•´ç³»ç»Ÿæç¤ºè¯ â€” XML æ ‡ç­¾åˆ†åŒºã€æ¯ä¸ªå·¥å…·æœ‰ explanation
- **ScriptedAlchemy gist**ï¼šå®Œæ•´å·¥å…· JSON â€” grep_search/file_search/list_dir/reapply å‘½å
- **Cursor å®˜åš codex-model-harness**ï¼šCodex reasoning traces ä¿ç•™ï¼ˆä¸¢å¤±=30%â†“ï¼‰ã€shell-forwardã€read_lints

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ21é¡¹ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹ |
|---|---|
| `src/prompts/system-base.js` | é‡å†™ â€” Cursor XML æ ‡ç­¾ç»“æ„ |
| `src/prompts/mode-agent.js` | é‡å†™ â€” å¯¹é½ Cursor agent æŒ‡ä»¤ |
| `src/prompts/prompt-assembler.js` | Codex harness + modelId |
| `src/core/agent-loop-controller.js` | try-catch/æ¶ˆæ¯è§’è‰²/reasoning/æ¶ˆæ¯ç®¡ç† |
| `src/core/llm-gateway.js` | _reasoning å­—æ®µé€ä¼  |
| `src/core/tool-executor.js` | TOOL_ALIASES åˆ«å |
| `codexProapi-main/src/proxy.js` | reasoning æ³¨å…¥/summary è½¬å‘/UUID |
| `src/tools/*.js` | æè¿°å¢å¼º + explanation + é‡å‘½å |
| `src/tools/read-lints.js` | æ–°å¢ |
| `src/tools/diff-history.js` | æ–°å¢ |
| `src/tools/reapply.js` | æ–°å¢ |
| `src/components/ToolCallCard.jsx` | TOOL_META æ›´æ–° |

## Phase 22 â€” è‡ªå®šä¹‰å·¥ä½œæµç³»ç»Ÿï¼ˆ2026-02-19ï¼‰

### åŠŸèƒ½æ¦‚è¿°
å®ç°å®Œæ•´çš„è‡ªå®šä¹‰å·¥ä½œæµç³»ç»Ÿï¼Œç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­åˆ›å»ºã€ç¼–è¾‘ã€AI ç”Ÿæˆå·¥ä½œæµï¼ŒAgent æ‰§è¡Œæ—¶è‡ªåŠ¨åŒ¹é…å¹¶æŒ‰æ­¥éª¤æ‰§è¡Œã€‚

### å®ç°æ–¹æ³•

1. **åç«¯æ•°æ®æ¨¡å‹ (`src/core/workflow-store.js`)**
   - `WorkflowStore` ç±»ï¼šCRUD + ç‰ˆæœ¬ç®¡ç† + å…³é”®è¯åŒ¹é…
   - æ¯ä¸ªå·¥ä½œæµæ”¯æŒå¤šç‰ˆæœ¬ï¼Œå¯é€‰æ‹©æ´»è·ƒç‰ˆæœ¬
   - åŸºäºå…³é”®è¯çš„ `matchWorkflow()` æ–¹æ³•ç”¨äº Agent è‡ªåŠ¨åŒ¹é…

2. **IPC æ¥å£ (`main.js` + `preload.js`)**
   - æ³¨å†Œ 8 ä¸ª IPC é€šé“ï¼š`workflow:list/get/create/update/delete/saveVersion/deleteVersion/match`
   - Preload æš´éœ²å¯¹åº” API åˆ°æ¸²æŸ“è¿›ç¨‹

3. **è®¾ç½® UI (`src/components/WorkflowPanel.jsx`)**
   - å·¦ä¾§å·¥ä½œæµåˆ—è¡¨ + å³ä¾§ç¼–è¾‘å™¨å¸ƒå±€
   - AI è¾“å…¥æ¡† + æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰ â†’ è°ƒç”¨ LLM è‡ªåŠ¨ç”Ÿæˆå·¥ä½œæµåç§°ã€æè¿°ã€æ­¥éª¤
   - æ­¥éª¤ç¼–è¾‘å™¨ï¼šæ”¯æŒæ— é™å±‚çº§å­æ­¥éª¤ã€å¢åˆ æ”¹
   - ç‰ˆæœ¬ç®¡ç†æ ï¼šåˆ‡æ¢ç‰ˆæœ¬ã€ä¿å­˜æ–°ç‰ˆæœ¬ã€åˆ é™¤ç‰ˆæœ¬
   - åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ï¼šåç§°ã€é€‚ç”¨åœºæ™¯æè¿°

4. **Agent Loop é›†æˆ (`src/core/agent-loop-controller.js`)**
   - `start()` ä¸­è°ƒç”¨ `workflowMatcher` åŒ¹é…å·¥ä½œæµ
   - åŒ¹é…åæ³¨å…¥ç³»ç»Ÿæç¤ºï¼Œè¦æ±‚æ¨¡å‹æŒ‰æ­¥éª¤é¡ºåºæ‰§è¡Œ
   - å‘é€ `workflow-matched` å’Œ `workflow-step-update` äº‹ä»¶
   - `_tryAdvanceWorkflow()` é€šè¿‡æ–‡æœ¬è¯­ä¹‰æ£€æµ‹è‡ªåŠ¨æ¨è¿›æ­¥éª¤

5. **æ‰§è¡Œæ€ UI (`src/components/WorkflowExecutionPanel.jsx`)**
   - æŠ˜å /å±•å¼€çš„æ¸…å•é¢æ¿ï¼Œè¿›åº¦æ¡ + å®Œæˆè®¡æ•°
   - ä¸‰æ€æ­¥éª¤æ˜¾ç¤ºï¼šå¾…å¤„ç†(ç°ç‚¹)ã€æ‰§è¡Œä¸­(è“è‰²æ—‹è½¬)ã€å·²å®Œæˆ(ç»¿å‹¾+åˆ é™¤çº¿)
   - æ”¯æŒå­æ­¥éª¤ç¼©è¿›æ˜¾ç¤º

6. **è·¯ç”±é›†æˆ (`src/App.jsx`)**
   - è®¾ç½®ä¾§è¾¹æ æ–°å¢ã€Œå·¥ä½œæµã€èœå•é¡¹ï¼ˆGitBranch å›¾æ ‡ï¼‰
   - å¯¹åº” tab æ¸²æŸ“ WorkflowPanel

7. **æ¶ˆæ¯å¡ç‰‡é›†æˆ (`src/components/AskMessageCard.jsx`)**
   - Agent æ¨¡å¼ä¸‹ä¼˜å…ˆæ˜¾ç¤º WorkflowExecutionPanel
   - å·¥ä½œæµåŒ¹é…æ—¶éšè— StickyTodoTracker é¿å…é‡å¤

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `src/core/workflow-store.js` | æ–°å¢ |
| `src/components/WorkflowPanel.jsx` | æ–°å¢ |
| `src/components/WorkflowExecutionPanel.jsx` | æ–°å¢ |
| `main.js` | æ–°å¢å·¥ä½œæµ IPC æ¥å£ |
| `preload.js` | æš´éœ²å·¥ä½œæµ API + æ³¨å†Œæ–° agent äº‹ä»¶ |
| `src/App.jsx` | å¯¼å…¥ WorkflowPanelã€æ–°å¢èœå•é¡¹å’Œ tab |
| `src/core/agent-loop-controller.js` | å·¥ä½œæµåŒ¹é…/æ¨è¿›/äº‹ä»¶å‘é€ |
| `src/main-process/agent-ipc.js` | æ³¨å…¥ workflowMatcher åˆ° agent config |
| `src/components/AskMessageCard.jsx` | é›†æˆ WorkflowExecutionPanel |

---

## Phase 23 â€” UI/UX åŠæ€§èƒ½ä¼˜åŒ–ï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

1. **å·¥ä½œæµç•Œé¢ UI é‡æ„ (`WorkflowPanel.jsx`)**
   - `StepItem` ç»„ä»¶é‡å†™ï¼šç»“æ„åŒ–æ­¥éª¤å±•ç¤ºï¼Œæ”¯æŒå­æ­¥éª¤ç¼©è¿›
   - `InlineRenameInput` ç»„ä»¶ï¼šåˆ—è¡¨ä¸­åŸåœ°é‡å‘½åå·¥ä½œæµ
   - `handleSave` æ‹†åˆ†ï¼šåç§°/æè¿°ç”¨ `workflowUpdate`ï¼Œæ­¥éª¤ç”¨ `workflowUpdateActiveVersion`
   - AI ç”Ÿæˆä¼˜åŒ–ï¼šå¥å£®çš„ JSON è§£æï¼ˆå¤„ç† markdown ä»£ç å—ï¼‰ï¼Œè‡ªåŠ¨æ ‡æ³¨ AI ç‰ˆæœ¬
   - ç¼–è¾‘åŒºæ¨ªå‘ç©ºé—´åˆ©ç”¨ï¼ˆå»é™¤ `min-w-[300px]`ï¼Œå¢å¤§ paddingï¼‰

2. **æ•ˆæœè¯„æµ‹ç•Œé¢é‡æ„ (`WorkflowBattlePanel.jsx`)**
   - ä»ã€Œå¯¹æˆ˜æ¨¡å¼ã€æ”¹åä¸ºã€Œæ•ˆæœè¯„æµ‹ã€ï¼Œç‹¬ç«‹é¡µé¢
   - å¸ƒå±€æ”¹ä¸ºå›ºå®šå®½åº¦å·¦é…ç½®æ  + å¼¹æ€§å³ç»“æœé¢æ¿
   - å¤šç»´è¯„åˆ†ä½“ç³»ï¼šaccuracy / completeness / structure / practicality
   - `ScoreBar` + `ScoreCard` å¯è§†åŒ–ç»„ä»¶

3. **ä¸‰åˆ†æ æ‹–æ‹½æ€§èƒ½ä¼˜åŒ– (`ProjectView.jsx`)**
   - æ‹–æ‹½ handler ä»ç›´æ¥ `setState` æ”¹ä¸º `requestAnimationFrame` èŠ‚æµ
   - æ‹–æ‹½é¢æ¿åŠ  `willChange: 'width'` / `willChange: 'height'` GPU åˆæˆæç¤º
   - è§£å†³äº†æ‹–æ‹½æ—¶æ˜æ˜¾çš„å¡é¡¿é—®é¢˜

4. **è·¯å¾„å®‰å…¨éªŒè¯ä¿®å¤ (`AskMessageCard.jsx`)**
   - `validatePathSafety` æ’é™¤ Windows ç›˜ç¬¦å†’å·ï¼ˆ`A-Z:`ï¼‰
   - `resolveFullPath` å‰¥ç¦»è¡Œå·åç¼€ï¼ˆ`:143`ï¼‰ï¼Œå¿½ç•¥ `æ•°å­—|` å¼€å¤´çš„ä»£ç ç‰‡æ®µè·¯å¾„

5. **å·¥ä½œæµ CRUD ä¿®å¤**
   - æ–°å¢ `updateActiveVersion` æ–¹æ³•ï¼ˆ`workflow-store.js`ï¼‰
   - æ³¨å†Œ `workflow:updateActiveVersion` IPCï¼ˆ`main.js` + `preload.js`ï¼‰
   - åˆ é™¤ç¡®è®¤å¼¹çª—ã€åŸåœ°ç¼–è¾‘åŠŸèƒ½æ¢å¤

6. **é¡µé¢ç©ºé—´åˆ©ç”¨**
   - `App.jsx` ä¸­å·¥ä½œæµå’Œè¯„æµ‹é¡µé¢åŒ…è£¹ `flex-1 min-w-0 h-full`
   - å„é¢æ¿å»é™¤å›ºå®šå®½åº¦é™åˆ¶

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/components/WorkflowPanel.jsx` | UI é‡æ„ã€InlineRenameInputã€AI ç”Ÿæˆä¿®å¤ |
| `src/components/WorkflowBattlePanel.jsx` | ç‹¬ç«‹é¡µé¢ã€å¤šç»´è¯„åˆ†ã€ç©ºé—´åˆ©ç”¨ |
| `src/ProjectView.jsx` | RAF èŠ‚æµæ‹–æ‹½ã€willChange GPU æç¤º |
| `src/components/AskMessageCard.jsx` | è·¯å¾„å®‰å…¨ä¿®å¤ |
| `src/core/workflow-store.js` | æ–°å¢ updateActiveVersion |
| `main.js` | æ–°å¢ workflow:updateActiveVersion IPC |
| `preload.js` | æš´éœ² workflowUpdateActiveVersion API |
| `src/App.jsx` | ç©ºé—´åˆ©ç”¨ä¼˜åŒ–ã€ç‹¬ç«‹è¯„æµ‹é¡µé¢è·¯ç”± |

---

## Phase 24 â€” å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†ä¸è‡ªåŠ¨æ ‡é¢˜ï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

1. **ä¼šè¯è®°å¿†ç³»ç»Ÿ (`src/core/session-memory-store.js` â€” æ–°å¢)**
   - `SessionMemoryStore` ç±»ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿçš„æŒä¹…åŒ–è®°å¿†
   - ç›®å½•ç»“æ„ï¼š`userData/session-memory/{sessionId}/summary.json`
   - `getSummary` / `saveSummary`ï¼šè¯»å†™ä¼šè¯æ‘˜è¦
   - `appendExecution`ï¼šè¿½åŠ æ‰§è¡Œè®°å½•ï¼ˆç”¨æˆ·è¯·æ±‚ã€å·²å®Œæˆä»»åŠ¡ã€æ–‡ä»¶å˜æ›´ã€å…³é”®å‘ç°ã€å¾…è§£å†³é—®é¢˜ï¼‰ï¼Œé™ 20 æ¡
   - `formatForPrompt`ï¼šç”Ÿæˆç»“æ„åŒ–æ–‡æœ¬æ³¨å…¥ Agent æç¤ºï¼ˆèƒŒæ™¯ã€è¿‘ 5 è½®æ‰§è¡Œã€ç´¯ç§¯æ–‡ä»¶å˜æ›´ã€é—ç•™é—®é¢˜ï¼‰
   - `deleteSession` / `listSessions`ï¼šæ¸…ç†å’Œåˆ—ä¸¾

2. **Agent IPC é›†æˆ (`src/main-process/agent-ipc.js`)**
   - `agent:start` æ¥æ”¶ `chatSessionId`
   - å¯åŠ¨å‰åŠ è½½ä¼šè¯è®°å¿†æ³¨å…¥ `enrichedMessage`
   - æ‰§è¡Œç»“æŸåæå– completedTasks / pendingIssues / fileChanges / keyFindings æ›´æ–°è®°å¿†

3. **è‡ªåŠ¨æ ‡é¢˜ç”Ÿæˆ (`main.js`)**
   - æ–°å¢ `chat:generateTitle` IPC
   - ç”¨ LLM æ ¹æ®é¦–æ¡ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ â‰¤10 å­—ä¸­æ–‡æ ‡é¢˜
   - æ¸…æ´—é€»è¾‘ï¼šå»é™¤å¼•å·ã€ä¹¦åå·ç­‰åŒ…è£¹å­—ç¬¦

4. **æ¨¡å‹é€‰æ‹©åˆ—è¡¨åˆ·æ–° (`ProjectView.jsx`)**
   - `useEffect` ä¾èµ–å¢åŠ  `modelMenuOpen`
   - æ¯æ¬¡æ‰“å¼€ä¸‹æ‹‰éƒ½é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨

5. **Agent é˜²æå‰ä¸­æ­¢å¢å¼º (`agent-loop-controller.js`)**
   - `maxIterations` 40 â†’ 60
   - `_maxGateRetries` 3 â†’ 5
   - `_noToolRetries` åˆ†ä¸¤é˜¶æ®µï¼ˆå„ 3 æ¬¡ï¼‰ï¼Œgate å¤±è´¥æ—¶é‡ç½®
   - ä¸Šä¸‹æ–‡å‹ç¼©ä¿ç•™æ›´å¤šæ¶ˆæ¯ï¼ˆ40%ï¼Œè‡³å°‘ 6 æ¡æœ€å¤š 15 æ¡ï¼‰
   - å‹ç¼©æ‘˜è¦ä¸­ä¿ç•™å®Œæ•´ todo æ¸…å•å†…å®¹

6. **Prompt å¢å¼º (`system-base.js`)**
   - æ–°å¢ `<task_management>` æ ‡ç­¾ï¼ˆ5 æ¡åŸåˆ™ï¼‰
   - æ–°å¢ `<persistence>` æ ‡ç­¾ï¼ˆ3 æ¡è®°å¿†ä½¿ç”¨è§„åˆ™ï¼‰

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/core/session-memory-store.js` | æ–°å¢ |
| `src/main-process/agent-ipc.js` | ä¼šè¯è®°å¿†åŠ è½½/æ›´æ–° |
| `main.js` | ä¼šè¯è®°å¿† IPC + è‡ªåŠ¨æ ‡é¢˜ IPC |
| `preload.js` | æš´éœ² memory / chatGenerateTitle API |
| `src/ProjectView.jsx` | chatSessionId ä¼ é€’ã€åˆ é™¤æ¸…ç†ã€æ¨¡å‹åˆ—è¡¨åˆ·æ–°ã€å¯¹è¯å†å²æ„å»ºä¼˜åŒ–ã€è‡ªåŠ¨æ ‡é¢˜è°ƒç”¨ |
| `src/core/agent-loop-controller.js` | maxIterationsâ†’60ã€gate å¢å¼ºã€å‹ç¼©ä¼˜åŒ– |
| `src/prompts/system-base.js` | task_management + persistence æ ‡ç­¾ |

---

## Phase 25 â€” æµå¼ UI ä¸åŠ¨ç”»ï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

1. **åŠ¨æ€ä»£ç æ˜¾ç¤º (`ProjectView.jsx` + `ToolCallCard.jsx`)**
   - æ–°å¢ `tool-call-delta` äº‹ä»¶ç›‘å¬ï¼šæ¥æ”¶æµå¼ tool_call å‚æ•°å¢é‡
   - æ›´æ–° `_streamingArgs` å’Œ `function.arguments`ï¼Œæ ‡è®° `_streaming: true`
   - `ToolCallCard` æ£€æµ‹æµå¼çŠ¶æ€ï¼Œå¯¹ `write_file`/`edit_file`/`create_file` æ˜¾ç¤ºåŠ¨æ€ä»£ç é¢„è§ˆé¢æ¿
   - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ + è“è‰²æµå¼å…‰æ ‡

2. **Thinking/Thought çŠ¶æ€æ ‡ç­¾ (`AskMessageCard.jsx`)**
   - `ThoughtPanel`ï¼šç”Ÿæˆä¸­ â†’ "Thinking..." + æ—‹è½¬ Loader2ï¼›å®Œæˆ â†’ "Thought for Xs" + Sparkles
   - `InlineThoughtPanel`ï¼šstreaming â†’ "Thinking Xs..." + æ—‹è½¬å›¾æ ‡ï¼›å®Œæˆ â†’ "Thought for Xs" + Sparkles
   - `AgentThinkingSegment`ï¼šstreaming æ—¶è“è‰²é«˜äº® + å·¦è“è¾¹

3. **æµå…‰åŠ¨ç”»æ•ˆæœ (`ask-theme.css`)**
   - `.tool-call-active-row`ï¼šè“è‰²å·¦è¾¹æ¡† + æ°´å¹³æ‰«å…‰ `shimmer-sweep` + å‚ç›´æµå…‰ `flow-light-vertical`
   - `.ask-thought-panel--active`ï¼šç´«è‰²æ‰«å…‰
   - `.inline-thought--active`ï¼šç´«è‰²æ‰«å…‰
   - `.agent-thinking--active`ï¼šè“è‰²å·¦è¾¹æ¡† + è“è‰²æ‰«å…‰
   - `.agent-status-indicator`ï¼šæµ…è“æ‰«å…‰
   - `.streaming-cursor--code`ï¼šè“è‰²ä»£ç å…‰æ ‡

4. **Agent çŠ¶æ€é€ä¼  (`ProjectView.jsx`)**
   - `state-change` äº‹ä»¶åŒæ­¥æ›´æ–° `msg.agentState`
   - æ‰§è¡Œä¸­æŒ‡ç¤ºå™¨åŠ¨æ€æ˜¾ç¤ºå…·ä½“çŠ¶æ€ï¼ˆè§„åˆ’ä¸­/æ‰§è¡Œå·¥å…·ä¸­/ç­‰ï¼‰

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/ProjectView.jsx` | tool-call-delta ç›‘å¬ã€agentState é€ä¼  |
| `src/components/ToolCallCard.jsx` | æµå¼ä»£ç é¢„è§ˆé¢æ¿ |
| `src/components/AskMessageCard.jsx` | Thinking/Thought åŒæ€æ ‡ç­¾ |
| `src/styles/ask-theme.css` | shimmer/flow-light åŠ¨ç”»ã€streaming-cursor |

---

## Phase 26 â€” Lint ç³»ç»Ÿå…¨é¢å¯¹æ ‡ Cursorï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

1. **å¤šå¼•æ“ Lint Runner é‡å†™ (`src/core/linter-runner.js`)**
   - æ”¯æŒ ESLintã€Biomeã€TypeScript Compiler (tsc) ä¸‰å¤§å¼•æ“
   - `findEslint` / `findBiome` / `findTsc`ï¼šè‡ªåŠ¨æ£€æµ‹æœ¬åœ°å®‰è£…
   - `hasEslintConfig` / `hasBiomeConfig` / `hasTsConfig`ï¼šé…ç½®æ–‡ä»¶æ£€æµ‹
   - `runEslint` / `runBiome` / `runTsc`ï¼šå„å¼•æ“ç‹¬ç«‹æ‰§è¡Œå™¨
   - `checkSyntaxBuiltin`ï¼šå†…ç½®è¯­æ³•æ£€æŸ¥ï¼ˆJS/TS ç”¨ `vm.Script`ï¼ŒPython ç”¨ `ast.parse`ï¼ŒJSON åŸç”Ÿè§£æï¼‰
   - `getLinterErrors`ï¼šç¼–æ’å¤šå¼•æ“æ‰§è¡Œã€æ–‡ä»¶è¿‡æ»¤ã€ç»“æœå»é‡æ’åº
   - `detectAvailableEngines`ï¼šè¿”å›é¡¹ç›®å¯ç”¨çš„ lint å¼•æ“åˆ—è¡¨
   - ç»Ÿä¸€è¯Šæ–­æ ¼å¼ï¼š`{ file, line, column, endLine, endColumn, severity, message, source, ruleId }`

2. **read_lints å·¥å…·é‡å†™ (`src/tools/read-lints.js`)**
   - æè¿°å¯¹æ ‡ Cursor å®˜æ–¹å·¥å…·
   - æ”¯æŒæ–‡ä»¶/ç›®å½•/æ•´ä¸ªå·¥ä½œåŒºä¸‰ç§ä½œç”¨åŸŸ
   - ç›®å½•æ¨¡å¼é€’å½’æ”¶é›†æ–‡ä»¶ï¼ˆæ·±åº¦ 5ï¼Œå¿½ç•¥ node_modules ç­‰ï¼‰
   - è¿”å› diagnostics + summary + engines + truncated æ ‡å¿—ï¼ˆä¸Šé™ 50 æ¡ï¼‰

3. **Agent Loop Lint é›†æˆ (`agent-loop-controller.js`)**
   - è¿½è¸ª `_modifiedFiles`ï¼ˆSetï¼‰å’Œ `_lintCheckPending`ï¼ˆbooleanï¼‰
   - æ¯è½®å·¥å…·æ‰§è¡Œåæ£€æµ‹ write/edit/create/reapply â†’ è®°å½•ä¿®æ”¹æ–‡ä»¶
   - éªŒæ”¶é—¸é—¨æ–°å¢æ£€æŸ¥ï¼šæœ‰ä¿®æ”¹æ–‡ä»¶ä½†æ²¡è¿è¡Œ `read_lints` â†’ å¼ºåˆ¶è¦æ±‚æ£€æŸ¥

4. **Prompt å¢å¼º**
   - `system-base.js` æ–°å¢ `<linter_errors>` æ ‡ç­¾ï¼ˆ6 æ¡åŸåˆ™ï¼‰
   - `mode-agent.js` ç¬¬å…­æ­¥å¼ºåˆ¶ `read_lints`
   - `prompt-assembler.js` Codex harness å¢åŠ å¤šå¼•æ“è¯´æ˜

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/core/linter-runner.js` | å®Œæ•´é‡å†™ï¼šå¤šå¼•æ“æ”¯æŒ |
| `src/tools/read-lints.js` | å®Œæ•´é‡å†™ï¼šå¯¹æ ‡ Cursor |
| `src/core/agent-loop-controller.js` | _modifiedFiles / _lintCheckPending + é—¸é—¨æ£€æŸ¥ |
| `main.js` | linter:run æ›´æ–° + linter:detect æ–°å¢ |
| `preload.js` | linterRun / linterDetect API |
| `src/prompts/system-base.js` | linter_errors æ ‡ç­¾ |
| `src/prompts/mode-agent.js` | ç¬¬å…­æ­¥å¿…åš read_lints |
| `src/prompts/prompt-assembler.js` | Codex harness + åŠ¨æ€ä¸Šä¸‹æ–‡æ ¼å¼ |
| `src/core/dynamic-context-provider.js` | æ–°è¯Šæ–­æ ¼å¼é€‚é… |

---

## Phase 27 â€” Agent æ‰§è¡Œè¿‡ç¨‹ UI ç»„ä»¶å¯¹æ ‡ Cursorï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

1. **ToolCallCard é‡å†™ (`ToolCallCard.jsx`)**
   - ä»å¡ç‰‡é£æ ¼æ”¹ä¸ºçº¯æ–‡æœ¬è¡Œï¼šå½©è‰²åŠ¨è¯ + æ–‡ä»¶å
   - æ–°å¢ `calcDiffStats`ï¼šè®¡ç®— `+X -Y` è¡Œå˜æ›´ç»Ÿè®¡ï¼ˆedit/write/createï¼‰
   - å®Œæˆåå±•ç¤º `+X -Y` diff ç»Ÿè®¡
   - å±•å¼€åæ˜¾ç¤ºæ–‡ä»¶è·¯å¾„ + diff ç»Ÿè®¡ + ç»¿åº•ä»£ç å†…å®¹

2. **AgentThinkingSegment é‡å†™ (`AskMessageCard.jsx`)**
   - åŒæ¨¡å¼æ¸²æŸ“ï¼šçŸ­æ–‡æœ¬ï¼ˆ<80 å­—ã€æ— ç»“æ„ï¼‰â†’ ç°è‰²çŠ¶æ€è¡Œï¼›é•¿æ–‡æœ¬/markdown â†’ å®Œæ•´æ¸²æŸ“
   - å»é™¤å›¾æ ‡ã€è¾¹æ¡†ã€å¤æ‚æ ·å¼ï¼Œå¯¹æ ‡ Cursor ç®€çº¦é£æ ¼

3. **TodoUpdateLine é‡å†™ (`AskMessageCard.jsx`)**
   - `Completed X of Y âœ… [item]`ï¼šå®Œæˆé¡¹
   - `Started to-do âœ… [item]`ï¼šå¼€å§‹é¡¹
   - `Updated to-do X items`ï¼šé€šç”¨æ›´æ–°

4. **ExploredFilesSummary æ–°ç»„ä»¶ (`AskMessageCard.jsx`)**
   - å°†åŒæ‰¹æ¬¡ 2+ ä¸ªæ¢ç´¢å·¥å…·ï¼ˆread_file/grep_search/list_dir/read_lints ç­‰ï¼‰èšåˆ
   - æŠ˜å æ€ï¼š`â–· Explored X files`ï¼›å±•å¼€æ˜¾ç¤ºå„ ToolCallCard

5. **CursorStatusLine æ–°ç»„ä»¶ (`AskMessageCard.jsx`)**
   - ç´§å‡‘çŠ¶æ€è¡Œï¼š`**Label** text` æ ¼å¼
   - ç”¨äºä¸Šä¸‹æ–‡å‹ç¼©ã€é—¸é—¨æ£€æŸ¥ã€ç»ˆç»“ç­‰çŠ¶æ€

6. **æ‰¹æ¬¡æ¸²æŸ“é€»è¾‘é‡æ„**
   - æ¢ç´¢å·¥å…· â†’ `ExploredFilesSummary`ï¼ˆ2+ï¼‰æˆ–å•ä¸ª `ToolCallCard`
   - `todo_write` â†’ `TodoUpdateLine` + é¦–æ¬¡ `TodoPanel`
   - å…¶ä»–å·¥å…· â†’ `ToolCallCard`

7. **è¿›åº¦æ¶ˆæ¯è¿‡æ»¤**
   - éšè—å†…éƒ¨å™ªéŸ³ï¼ˆåœæ»æ£€æµ‹ã€tool_choice é‡è¯•ã€çŠ¶æ€æ ‡ç­¾é‡å¤ç­‰ï¼‰
   - å‹ç¼©æ¶ˆæ¯ â†’ "Summarized Chat context summarized."
   - é—¸é—¨å¤±è´¥ â†’ "Gate check [reason]"
   - ç»ˆç»“ â†’ "Finalizing Preparing conclusion..."

8. **CSS ç®€åŒ– (`ask-theme.css`)**
   - ç§»é™¤ tool-call-active-row æ‰«å…‰å’Œå·¦è¾¹æ¡†
   - ç§»é™¤ agent-thinking--active å·¦è¾¹æ¡†
   - ç§»é™¤ agent-status-indicator æ‰«å…‰
   - å¯¹æ ‡ Cursor çš„æç®€ç¾å­¦

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/components/ToolCallCard.jsx` | é‡å†™ï¼šçº¯æ–‡æœ¬è¡Œ + diff ç»Ÿè®¡ |
| `src/components/AskMessageCard.jsx` | AgentThinkingSegment/TodoUpdateLine é‡å†™ + ExploredFilesSummary/CursorStatusLine æ–°å¢ + æ‰¹æ¬¡æ¸²æŸ“ + è¿›åº¦è¿‡æ»¤ |
| `src/styles/ask-theme.css` | å»é™¤æ‰«å…‰/å·¦è¾¹æ¡†ï¼Œæç®€åŒ– |

---

## Phase 28 â€” Agent å…¨é¢å¯¹æ ‡ Cursor å¢å¼ºï¼ˆ2026-02-19ï¼‰

### æ”¹è¿›å†…å®¹

æœ¬é˜¶æ®µçš„ç›®æ ‡æ˜¯å°† Cursor Agent åœ¨å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­å±•ç°çš„æ‰€æœ‰è¡Œä¸ºæ¨¡å¼â€”â€”åŒ…æ‹¬æ€è€ƒæ–¹å¼å’Œæ‰§è¡Œç­–ç•¥â€”â€”ç³»ç»Ÿæ€§åœ°èå…¥åˆ° Agent çš„ä»£ç å’Œæç¤ºä¸­ï¼Œå…¨é¢å¢å¼ºæ‰§è¡Œèƒ½åŠ›ã€‚

#### 1. ToolCallCard å¯¹æ ‡ Cursor æ ¼å¼

**æ–‡ä»¶**ï¼š`src/components/ToolCallCard.jsx`

| å˜æ›´ | è¯´æ˜ |
|---|---|
| `grep_search` label/doneLabel | `Search/Searched` â†’ `Grep/Grepped` |
| `file_search` doneLabel | `Searched` â†’ `Found` |
| `search_files` label/doneLabel | `Search/Searched` â†’ `Grep/Grepped` |
| `buildSummaryText` grep æ ¼å¼ | `"pattern"` â†’ `pattern in filename`ï¼ˆå« path å‚æ•°æ—¶è¿½åŠ  "in æ–‡ä»¶å"ï¼‰ |
| explanation å­—å¹• | å·¥å…·è°ƒç”¨è¡Œä¸‹æ–¹æ˜¾ç¤ºç°è‰² `explanation` å‚æ•°å†…å®¹ï¼ˆæŠ˜å æ€ï¼‰ |

#### 2. Agent Loop æ‰§è¡Œé€»è¾‘å¢å¼º

**æ–‡ä»¶**ï¼š`src/core/agent-loop-controller.js`

| å˜æ›´ | è¯´æ˜ |
|---|---|
| STATE_LABELS å¯¹æ ‡ Cursor | `Planning tasks...` â†’ `Planning next moves`ï¼›`Executing tools...` â†’ `Running tools...`ï¼›`Reviewing results...` â†’ `Reviewing changes...` |
| æ‰¹æ¬¡æ‘˜è¦ç»Ÿè®¡ | æ¯è½®å·¥å…·æ‰§è¡Œåè‡ªåŠ¨ç»Ÿè®¡æ¢ç´¢æ–‡ä»¶æ•°å’Œç¼–è¾‘æ–‡ä»¶æ•°ï¼Œå‘å°„ `Explored X files` / `Edited X files` è¿›åº¦æ¶ˆæ¯ |
| è¿­ä»£è¿›åº¦æ±‡æŠ¥ | æ¯ 5 è½®æˆ–ç¬¬ 1 è½®æ±‡æŠ¥ `Iteration X â€” Y/Z tasks done` |
| å‹ç¼©è¿›åº¦æ¶ˆæ¯è‹±æ–‡åŒ– | `ä¸Šä¸‹æ–‡ç”¨é‡è¾ƒé«˜` â†’ `Summarized Chat context (~Xk tokens)` |
| é—¸é—¨è¿›åº¦æ¶ˆæ¯è‹±æ–‡åŒ– | `éªŒæ”¶æœªé€šè¿‡` â†’ `Gate check failed (X/Y): Z issue(s)`ï¼›`éªŒæ”¶å·²å°è¯•` â†’ `Finalizing â€” gate retries exhausted` |

#### 3. Prompt å…¨é¢å¢å¼º â€” èå…¥ Cursor Agent è¡Œä¸ºæ¨¡å¼

**æ–‡ä»¶**ï¼š`src/prompts/system-base.js`

| æ ‡ç­¾ | å˜æ›´ |
|---|---|
| `<tool_calling>` | æ–°å¢ï¼šexplanation å‚æ•°è¦æ±‚ï¼›ç‹¬ç«‹å·¥å…·å¹¶è¡Œè°ƒç”¨ï¼›æœç´¢å¤±è´¥æ¢å…³é”®è¯é‡è¯• |
| `<search_and_reading>` | é‡å†™ä¸º 5 æ¡ç­–ç•¥ï¼šå¤šæ‰¹æ¬¡å¹¶è¡Œæ¢ç´¢ã€é€æ­¥æ·±å…¥ã€æœç´¢ç­–ç•¥ï¼ˆgrepâ†’readï¼‰ã€è‡ªå·±æ‰¾ç­”æ¡ˆã€ç²¾ç¡®è¡Œå·è¯»å– |
| `<making_code_changes>` | æ–°å¢ï¼šå…ˆè¯»åæ”¹ã€ç²¾ç¡®æ›¿æ¢ä¼˜å…ˆ edit_fileã€æ‰¹é‡ä¿®æ”¹åç»Ÿä¸€éªŒè¯ã€ä¸åŠ å¤šä½™æ³¨é‡Š |
| `<task_management>` | æ–°å¢ï¼šåˆ›å»ºæ¸…å•æ—¶ç¬¬ä¸€é¡¹ç›´æ¥ in_progressï¼›merge=true è¿½åŠ æ­¥éª¤ï¼›é¡¹è¦å…·ä½“å¯æ‰§è¡Œ |

**æ–‡ä»¶**ï¼š`src/prompts/mode-agent.js`

| ä½ç½® | å˜æ›´ |
|---|---|
| ç¬¬äº”æ­¥ | æ–°å¢ã€Œå…³é”®æ‰§è¡Œç­–ç•¥ã€ï¼šå…ˆè¯»åæ”¹ã€ç²¾ç¡®ä¿®æ”¹ã€å¤šè·¯å¹¶è¡Œã€æ¸è¿›æ·±å…¥ã€å·¥å…·è¯´æ˜ |
| ç¬¬å…­æ­¥ | ç²¾ç®€ä¸º 4 æ­¥ç³»ç»Ÿæ€§è‡ªæŸ¥ï¼šLint â†’ å›è¯» â†’ é€»è¾‘ â†’ å®Œæ•´æ€§ |

**æ–‡ä»¶**ï¼š`src/prompts/prompt-assembler.js`

| ä½ç½® | å˜æ›´ |
|---|---|
| Codex harness | æ–°å¢ï¼šå…ˆè¯»åæ”¹ã€å¹¶è¡Œå·¥å…·ã€explanation å‚æ•°è¦æ±‚ |

#### 4. UI è¿›åº¦æ¶ˆæ¯è¿‡æ»¤ä¼˜åŒ–

**æ–‡ä»¶**ï¼š`src/components/AskMessageCard.jsx`

| å˜æ›´ | è¯´æ˜ |
|---|---|
| HIDDEN_PATTERNS æ‰©å±• | æ–°å¢ `Tool retries exhausted` éšè— |
| æ–°å¢çŠ¶æ€è¡Œè½¬æ¢ | `Explored X files` â†’ Explored labelï¼›`Edited X files` â†’ Edited labelï¼›`Iteration X...` â†’ Progress label |
| Gate check åŒ¹é…ä¼˜åŒ– | åŒæ—¶åŒ¹é…ä¸­æ–‡ `éªŒæ”¶æœªé€šè¿‡` å’Œè‹±æ–‡ `Gate check failed` |
| VerificationBadge é‡å†™ | å…¨éƒ¨å®Œæˆæ—¶æ˜¾ç¤º Cursor é£æ ¼ `Completed X of Y âœ… éªŒè¯æ‰€æœ‰ä¿®æ”¹æ—  linter é”™è¯¯`ï¼›å¤±è´¥æ—¶ç®€çº¦å‘Šè­¦ |

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|---|---|
| `src/components/ToolCallCard.jsx` | Grep/Grepped æ ¼å¼ + "in filename" + explanation å­—å¹• |
| `src/core/agent-loop-controller.js` | STATE_LABELS + æ‰¹æ¬¡æ‘˜è¦ + è¿­ä»£æ±‡æŠ¥ + è¿›åº¦æ¶ˆæ¯è‹±æ–‡åŒ– |
| `src/prompts/system-base.js` | tool_calling/search_and_reading/making_code_changes/task_management å…¨é¢å¢å¼º |
| `src/prompts/mode-agent.js` | ç¬¬äº”æ­¥æ‰§è¡Œç­–ç•¥ + ç¬¬å…­æ­¥ç²¾ç®€ |
| `src/prompts/prompt-assembler.js` | Codex harness å¢å¼º |
| `src/components/AskMessageCard.jsx` | è¿›åº¦è¿‡æ»¤ä¼˜åŒ– + çŠ¶æ€è¡Œè½¬æ¢ + VerificationBadge é‡å†™ |
