# Cursor Agent 对齐复刻 — AI 执行指令书

> **用途**：将本文档直接交给 AI 编码助手（Cursor Agent / Claude / GPT 等），作为实施的总入口。  
> **最后更新**：2026-02-18

---

## 一、你是谁

你是 `cursor-launcher` 项目的实施工程师。你的任务是按照设计文档，为这个 Electron + React 桌面应用实现 "Cursor Agent 模式 1:1 对齐"。

## 二、项目概况（30 秒了解）

- **技术栈**：Electron 28 + React 18 + Vite 5 + TailwindCSS 3.4 + Node.js
- **现有代码**：`main.js`（主进程）、`preload.js`（IPC桥）、`src/ProjectView.jsx`（主界面）、`src/components/AskMessageCard.jsx`（消息渲染）
- **当前状态**：基础聊天/编辑 UI 已有，但 Agent 核心能力（自治循环、工具调用、上下文管理）全部缺失
- **目标**：实现 Agent Loop + 16 个工具 + 分层 Prompt + 动态上下文 + 安全层 + 完整 UI

## 三、文档地图（必读）

项目根目录有 4 份设计文档，**按以下优先级阅读**：

| 优先级 | 文件 | 内容 | 何时读 |
|--------|------|------|--------|
| **★★★** | `PARITY_90_SPRINT_PLAN.md` | **冲刺方案**：MW1-MW12 每个改造项的完整实现规格（伪代码、接口、状态机、文件清单） | **首先读这个！** 这是行动蓝图 |
| **★★☆** | `CURSOR_AGENT_IMPL_SPEC_V2.md` | **V2 实施规格**：每个模块的字段级协议、触发条件、协作关系、异常策略 | 实现某模块时查阅对应章节 |
| **★☆☆** | `CURSOR_AGENT_REPLICATION_SPEC.md` | **V1 总体设计**：架构全景、Mermaid 流程图、工具协议、Prompt 模板、UI 组件树 | 需要理解全貌或看流程图时查阅 |
| **☆☆☆** | `AGENT_ALIGNMENT_PLAN.md` | **V0 清单**：95+ 项功能条目，已被后续文档取代 | 一般不需要看 |

**核心原则：做任何改造前，先读 `PARITY_90_SPRINT_PLAN.md` 中对应的 MW 章节。**

## 四、实施路线（按顺序执行）

### 🔴 Phase 1：核心对齐（W1-W4，17天，从 68→88 分）

按以下顺序逐个实施。**每完成一个 MW 就测试，确认可用后再开下一个。**

---

#### 任务 1：MW1 — Agent Loop 闭环（4天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D2（AgentLoopController 增强改造）  
**补充参考**：`CURSOR_AGENT_IMPL_SPEC_V2.md` → 章节 E（Agent Loop 闭环实现规范）

**要做什么**：
1. 创建 `src/core/agent-loop-controller.js` — Agent 主循环状态机
2. 创建 `src/core/llm-gateway.js` — LLM 调用封装（支持 tools 参数 + SSE 流式）
3. 创建 `src/core/tool-executor.js` — 工具注册/路由/执行器
4. 创建 `src/main-process/agent-ipc.js` — IPC 桥接层
5. 修改 `preload.js` — 新增 `agent:*` IPC 通道
6. 修改 `main.js` — 引入 agent-ipc 模块

**关键逻辑**：
```
用户消息 → IPC → AgentLoopController.start()
  → 组装上下文 → 调 LLM (带 tools[]) → 收到 tool_calls
  → ToolExecutor.execute() → 结果注入 messages
  → 再调 LLM → 直到 LLM 返回纯文本（无 tool_calls）
  → 结束，返回最终回复
```

**验收**：Agent 可以自主调用工具（如 read_file）并基于结果继续思考。

---

#### 任务 2：MW1 续 — 基础工具集（与任务 1 同步，3天）

**读哪里**：`CURSOR_AGENT_IMPL_SPEC_V2.md` → 章节 I（工具系统实现规范）

**要做什么**：创建 `src/tools/` 目录下 8 个基础工具：

| 文件 | 工具名 | 说明 |
|------|--------|------|
| `read-file.js` | `read_file` | 读文件，支持 offset/limit |
| `write-file.js` | `write_file` | 写新文件 |
| `edit-file.js` | `edit_file` | 字符串替换（old_string→new_string） |
| `run-terminal-cmd.js` | `run_terminal_cmd` | 执行终端命令 |
| `search-files.js` | `search_files` | 正则搜索（基于 ripgrep 或原生） |
| `glob-search.js` | `glob_search` | 文件名模式匹配 |
| `list-directory.js` | `list_directory` | 列目录 |
| `delete-file.js` | `delete_file` | 删除文件 |

加上 `src/tools/index.js` 统一注册。

**验收**：每个工具独立可调用，返回结构化结果。

---

#### 任务 3：MW2 — Prompt V3 分层架构（3天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D3（Prompt V3 全量改造）  
**补充参考**：`PARITY_90_SPRINT_PLAN.md` → 章节 E（Prompt V3 全量模板）

**要做什么**：
1. 创建 `src/prompts/system-base.js` — Layer 0: Meta 系统提示词
2. 创建 `src/prompts/mode-agent.js` — Layer 1: Agent 模式行为定义
3. 创建 `src/prompts/mode-ask.js` — Layer 1: Ask 模式
4. 创建 `src/prompts/mode-plan.js` — Layer 1: Plan 模式
5. 创建 `src/prompts/mode-debug.js` — Layer 1: Debug 模式
6. 创建 `src/prompts/recovery-prompt.js` — Layer 3: 错误恢复策略 ★关键
7. 创建 `src/prompts/summarizer-prompt.js` — Layer 4: 历史压缩
8. 创建 `src/prompts/prompt-assembler.js` — 组装器：按 Layer 拼接 Prompt

**验收**：Agent 遇到工具失败时，能自主读取错误信息、调整策略重试（而不是重复同样的失败调用）。

---

#### 任务 4：MW3 — edit_file 模糊容错（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D4（edit_file 鲁棒性增强）

**要做什么**：
1. 创建 `src/core/edit-fuzzy-matcher.js` — 三级匹配策略（精确→空白规范化→缩进无关）
2. 增强 `src/tools/edit-file.js` — 集成模糊匹配 + 回读验证

**验收**：当 LLM 给出的 old_string 有轻微空白差异时，仍能正确匹配和替换。

---

#### 任务 5：MW4 — 动态上下文 6 源（3天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D1（DynamicContextProvider）

**要做什么**：
1. 创建 `src/core/dynamic-context-provider.js` — 采集 6 种上下文源
2. 修改 `preload.js` — 新增获取当前编辑器状态的 IPC

**6 种上下文源**：
- 当前打开的文件内容
- 光标附近代码（±30行）
- 最近编辑过的文件列表
- Linter 错误列表
- 终端最近输出
- 搜索结果

**验收**：Agent 启动时能自动获取用户当前编辑的文件、光标位置、linter 错误等上下文。

---

#### 任务 6：MW5 — Token 预算管理（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D5（Token 预算与上下文压缩）

**要做什么**：
1. 创建 `src/core/token-counter.js` — Token 估算器
2. 创建 `src/core/context-engine.js` — 预算管理 + 历史压缩

**关键逻辑**：
```
总预算 = 模型 maxTokens
- 系统 Prompt 预留 (~4000)
- 工具定义预留 (~3000)
- 回复预留 (~4096)
= 可用于 history + context 的预算

当 history 超预算 → 自动压缩旧消息为摘要
```

**验收**：长对话（10+ 轮）不会因 token 超限而崩溃。

---

#### 任务 7：MW6 — UI 组件（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 F（UI 详细规范）  
**补充参考**：`CURSOR_AGENT_IMPL_SPEC_V2.md` → 章节 L（UI/UX 规范）

**要做什么**：
1. 创建 `src/components/ToolCallCard.jsx` — 工具调用可视化卡片（6态：pending/running/success/failed/cancelled/approved）
2. 创建 `src/components/ApprovalBar.jsx` — 审批确认条（auto/ask_first 策略）
3. 创建 `src/components/AgentStatusBar.jsx` — Agent 状态指示器
4. 修改 `src/components/AskMessageCard.jsx` — 集成 ToolCallCard（当有 tool_calls 数据时用新组件，否则保留旧的 markdown 解析）

**验收**：Agent 的每个工具调用以独立卡片展示，显示参数/结果/耗时/状态。

---

#### 任务 8：MW7 — 可观测性（1天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 D7

**要做什么**：
1. 创建 `src/core/agent-tracer.js` — 结构化日志系统
2. 在 AgentLoopController 各关键节点埋点

**验收**：可在控制台/日志文件中看到完整的 Agent 执行链路追踪。

---

### 🟡 Phase 2：能力扩展（W5-W6，4天，从 88→91 分）

#### 任务 9：MW8 — Sub-Agent 子代理（3天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 M1

**要做什么**：
1. 创建 `src/tools/task-delegation.js` — task 工具
2. 创建 `src/core/agent-loop-factory.js` — 子代理工厂
3. 创建 `src/components/SubAgentCard.jsx` — 子代理 UI

**验收**：父 Agent 可启动子代理探索代码库，子代理完成后结果回传给父 Agent。

---

#### 任务 10：MW10 — 结构化 Todo（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 M3

**要做什么**：
1. 创建 `src/tools/todo-manager.js` — todo_write 工具
2. 创建 `src/core/todo-store.js` — Todo 状态管理
3. 创建 `src/components/TodoPanel.jsx` — Todo UI

**验收**：Agent 执行多步任务时，左侧显示结构化进度列表。

---

### 🟢 Phase 3：补全工具集（W7，2天，从 91→93 分）

#### 任务 11：MW9 — Web Search / Fetch（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 M2

**要做什么**：
1. 创建 `src/tools/web-search.js` — 搜索引擎集成
2. 创建 `src/tools/web-fetch.js` — URL 内容抓取
3. 修改 `src/App.jsx` — 设置页添加 Web Search 配置

---

### 🔵 Phase 4：高级工具（W8，3天，从 93→95 分）

#### 任务 12：MW11 — Browser 工具（2天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 M4

#### 任务 13：MW12 — 图片生成（1天）

**读哪里**：`PARITY_90_SPRINT_PLAN.md` → 章节 M5

---

## 五、安全红线（所有阶段都必须遵守）

1. **路径安全**：所有文件工具必须验证路径在 `projectPath` 内，禁止路径遍历
2. **命令安全**：`run_terminal_cmd` 禁止 `rm -rf /`、`format`、`:(){ :|:& };:` 等危险命令
3. **审批机制**：`write_file`、`edit_file`、`delete_file`、`run_terminal_cmd` 默认需用户确认
4. **不造假**：不声称拥有 Cursor 私有源码，只做行为级对齐

## 六、提给 AI 的沟通模板

### 模板 A：启动新 Phase

```
请阅读项目根目录下的 PARITY_90_SPRINT_PLAN.md，定位到章节 [D1/D2/D3/...] 
关于 [MW编号] 的实现规范。

然后按规范实现以下文件：
- [文件路径1]：[简要说明]
- [文件路径2]：[简要说明]

实现要求：
1. 严格按文档中的接口定义和数据结构
2. 包含错误处理和边界检查
3. 安全相关（路径验证）不可省略

实现完成后告诉我，我来测试。
```

### 模板 B：实现单个工具

```
请阅读 PARITY_90_SPRINT_PLAN.md 和 CURSOR_AGENT_IMPL_SPEC_V2.md 中关于 
[工具名] 工具的设计规范。

创建 src/tools/[工具文件名].js，要求：
1. 导出 { name, description, parameters, riskLevel, handler }
2. handler 接收 (args, projectPath, context) 参数
3. 返回 { success: boolean, ...其他字段 }
4. 包含路径安全验证（如果是文件操作工具）
5. 参照文档中的伪代码实现核心逻辑

然后在 src/tools/index.js 中注册这个工具。
```

### 模板 C：实现 UI 组件

```
请阅读 PARITY_90_SPRINT_PLAN.md 章节 F（UI 详细规范）中关于 [组件名] 的设计。

创建 src/components/[组件名].jsx，要求：
1. 使用 React + TailwindCSS
2. 参照文档中的状态表和事件表实现交互
3. 风格与现有 AskMessageCard.jsx 保持一致
4. 支持文档中列出的所有状态（pending/running/success/failed 等）
```

### 模板 D：修复/增强现有文件

```
请先阅读以下现有文件：
- [文件路径]

然后阅读 PARITY_90_SPRINT_PLAN.md 章节 [章节号] 中的改造说明。

按文档要求修改该文件，改造点包括：
1. [改造点1]
2. [改造点2]

注意保持向后兼容，旧的 markdown 解析逻辑作为 fallback 保留。
```

### 模板 E：一句话启动整个 Phase

```
你是 cursor-launcher 项目的实施工程师。请先阅读项目根目录的 
HANDOFF_PROMPT.md 了解项目全貌和文档地图，然后执行 Phase [1/2/3/4] 
的所有任务。每完成一个任务（MW编号），先简要报告完成状态，再继续下一个。

遇到设计文档描述不清的地方，按以下优先级决策：
1. 先查 PARITY_90_SPRINT_PLAN.md 对应章节
2. 再查 CURSOR_AGENT_IMPL_SPEC_V2.md 对应章节
3. 都没有的话，按 Cursor Agent 的公开可观测行为推断合理实现
4. 实在不确定的在代码中加 // TODO: [描述不确定点] 标记
```

## 七、常见问题

**Q：文档太长 AI 读不完怎么办？**  
A：不要一次丢全部文档。按 Phase 和任务拆分，每次只让 AI 读对应 MW 的章节。用"模板 A"指定具体章节。

**Q：AI 的实现和文档描述不完全一致怎么办？**  
A：只要接口签名（函数名、参数、返回值结构）一致即可。内部实现可以有合理优化。

**Q：遇到文档没覆盖的边界情况怎么办？**  
A：让 AI 参照 Cursor Agent 的公开行为推断。如果是安全相关，宁可严格拒绝也不要放行。

**Q：哪些是绝对不能跳过的？**  
A：MW1（Agent Loop）→ MW2（Prompt）→ MW3（edit_file）这三个必须按顺序完成，它们是所有后续功能的基础。

**Q：如何验证是否做对了？**  
A：`PARITY_90_SPRINT_PLAN.md` 章节 J 有 20 个 A/B 评测用例，每个 MW 末尾有验收清单。

---

## 八、快速参考卡

```
文档层级：
  HANDOFF_PROMPT.md          ← 你在这里（总入口）
    ├── PARITY_90_SPRINT_PLAN.md    ← 行动蓝图（先读这个）
    ├── CURSOR_AGENT_IMPL_SPEC_V2.md ← 详细规格（按需查阅）
    └── CURSOR_AGENT_REPLICATION_SPEC.md ← 总体设计（看流程图时查阅）

实施顺序：
  MW1(Loop) → MW2(Prompt) → MW3(Edit) → MW4(Context) → MW5(Token) → MW6(UI) → MW7(Log)
  → MW8(SubAgent) → MW10(Todo) → MW9(Web) → MW11(Browser) → MW12(Image)

文件结构（最终）：
  src/
    core/          → agent-loop-controller, llm-gateway, tool-executor, context-engine,
                     dynamic-context-provider, token-counter, security-layer,
                     edit-fuzzy-matcher, agent-tracer, agent-loop-factory, todo-store
    tools/         → read-file, write-file, edit-file, run-terminal-cmd, search-files,
                     glob-search, list-directory, delete-file, task-delegation,
                     todo-manager, web-search, web-fetch, browser-use, generate-image, index
    prompts/       → system-base, mode-agent, mode-ask, mode-plan, mode-debug,
                     recovery-prompt, summarizer-prompt, prompt-assembler
    components/    → ToolCallCard, ApprovalBar, AgentStatusBar, SubAgentCard, TodoPanel
    main-process/  → agent-ipc
```
