# Agent 模式与 Cursor 完全对齐执行清单与计划

> **目标**：使 Agent 模式的处理逻辑和 UI 组件展示与 Cursor Agent 模式完全一致  
> **优先级**：最高优先级 - 这是核心功能，必须达到生产级质量  
> **文档版本**：1.1 | **最后更新**：2026-02-17 | **总功能项**：95+ 项

---

## 📊 快速参考

### 当前状态
- ✅ **已完成**：7 项（基础功能）
- ❌ **待实现**：95+ 项（完整对齐）

### 关键缺失（必须实现）
1. **批量操作** - 提升效率
2. **步骤编号/进度** - 用户体验
3. **步骤折叠** - 界面优化
4. **错误重试** - 容错性
5. **路径安全验证** - 安全性（必须）
6. **命令注入防护** - 安全性（必须）
7. **流式步骤解析** - 实时体验（关键）
8. **Tool Calling** - 核心能力（关键）

### 实施建议
- **最小路径**：实现 P0 功能（5-7 天）
- **完整路径**：实现 P0 + P1 功能（10-14 天）
- **企业路径**：实现所有功能（20-30 天）

---

## 📋 执行清单总览

### ✅ 已完成项
- [x] 步骤卡片 UI（编辑 diff + 终端执行）
- [x] 内联 diff 展示
- [x] Accept/Reject 按钮
- [x] 命令执行与输出展示
- [x] 思考面板（Thought Panel）
- [x] 步骤解析（从回复中提取编辑/命令步骤）
- [x] 应用更改确认弹窗（带 diff 预览）

### ❌ 待实现项（共 95+ 项）

---

## 🎯 核心功能缺失（高优先级 - 必须实现）

### 1. 批量操作（Accept All / Reject All）
**在 Cursor 中的作用**：
- 当 Agent 生成多个文件编辑步骤时，Cursor 会在步骤列表顶部或底部提供 "Accept All" 和 "Reject All" 按钮
- 允许用户一键接受或拒绝所有待处理的步骤
- 提升批量操作的效率，避免逐个点击

**实现要点**：
- 在 `agent-answer-with-steps` 容器顶部添加批量操作栏
- 统计所有 `pending` 状态的步骤
- "Accept All" 依次执行所有 Accept，"Reject All" 隐藏所有步骤
- 提供确认对话框（"确定要接受所有 X 个步骤吗？"）

**文件**：`src/components/AskMessageCard.jsx`

---

### 2. 步骤编号与进度指示
**在 Cursor 中的作用**：
- 每个步骤卡片显示序号（如 "Step 1/5"）
- 在步骤列表顶部显示整体进度（如 "3/5 steps completed"）
- 帮助用户了解当前进度和步骤位置
- 已完成的步骤显示绿色勾选图标

**实现要点**：
- 在 `AgentEditStepCard` 和 `AgentTerminalStepCard` 的 header 中添加步骤编号
- 在 `agent-answer-with-steps` 顶部添加进度条或进度文本
- 计算 `applied` 状态的步骤数量
- 已应用步骤显示 CheckCircle 图标

**文件**：`src/components/AskMessageCard.jsx`, `src/styles/ask-theme.css`

---

### 3. 步骤折叠功能
**在 Cursor 中的作用**：
- 已应用的步骤可以折叠，只显示标题和状态
- 减少界面占用，聚焦未处理的步骤
- 点击标题栏可展开/折叠步骤内容（diff 或输出）

**实现要点**：
- 在 `AgentEditStepCard` 和 `AgentTerminalStepCard` 中添加折叠状态
- 已应用步骤默认折叠，pending 步骤默认展开
- 添加折叠/展开图标（ChevronDown/ChevronRight）
- 添加平滑的展开/折叠动画

**文件**：`src/components/AskMessageCard.jsx`, `src/styles/ask-theme.css`

---

### 4. 错误重试机制
**在 Cursor 中的作用**：
- 命令执行失败时，显示 "Retry" 按钮
- 允许用户重新执行失败的命令
- 文件写入失败时，也提供重试选项

**实现要点**：
- 在 `AgentTerminalStepCard` 中，当 `output.success === false` 时显示 "Retry" 按钮
- 在 `AgentEditStepCard` 中，当写入失败时显示重试按钮
- 重试时重置状态并重新执行

**文件**：`src/components/AskMessageCard.jsx`

---

### 5. 流式步骤解析（实时步骤展示）
**在 Cursor 中的作用**：
- 在流式生成过程中，实时解析已生成的代码块
- 显示 "正在生成步骤..." 的占位卡片
- 代码块完整后立即显示为步骤卡片
- 用户无需等待完整回复即可看到步骤

**实现要点**：
- 修改 `parseAgentSteps` 支持部分解析（处理未闭合的代码块）
- 在流式过程中调用 `parseAgentSteps`（不等待 `!streaming`）
- 为未完成的代码块显示 "生成中..." 占位卡片
- 流式更新时增量更新步骤列表

**文件**：`src/components/AskMessageCard.jsx`

---

### 6. Tool Calling 支持（真正的工具调用）
**在 Cursor 中的作用**：
- Agent 通过 `tool_calls` 调用工具（read_file, edit_file, run_terminal_cmd, search）
- 流式响应中包含 `delta.tool_calls`
- 实时显示工具调用状态（"Reading file...", "Editing...", "Running..."）
- 工具执行结果自动注入到后续对话中

**实现要点**：
- 在 `main.js` 的流式解析中添加 `delta.tool_calls` 处理
- 解析 tool_calls → 执行工具 → 发送 tool_results → 继续流式
- 在前端显示工具调用步骤卡片（与当前步骤卡片类似）
- 支持的工具：read_file, write_file, run_command, search_files

**文件**：`main.js`, `src/components/AskMessageCard.jsx`, `preload.js`

---

## 🔒 安全功能缺失（高优先级 - 必须实现）

### 7. 路径安全验证（防止路径遍历攻击）
**在 Cursor 中的作用**：
- 验证文件路径是否在项目目录内
- 防止 `../../../etc/passwd` 等路径遍历攻击
- 拒绝访问项目外的文件

**实现要点**：
- 在 `resolveFullPath` 中添加路径规范化
- 使用 `path.resolve` 和 `path.relative` 验证路径
- 确保最终路径以项目根目录开头
- 拒绝包含 `..` 的相对路径

**文件**：`src/components/AskMessageCard.jsx`

---

### 8. 命令注入防护（命令白名单/黑名单）
**在 Cursor 中的作用**：
- 检测危险命令（如 `rm -rf /`, `del /f /s /q C:\`）
- 提供命令白名单配置（允许 `npm`, `git`, `tsc` 等）
- 危险命令需要用户明确确认

**实现要点**：
- 定义危险命令模式（正则表达式）
- 定义安全命令白名单
- 在 `agent:runCommand` 中验证命令
- 危险命令弹出确认对话框

**文件**：`main.js`, `src/components/AskMessageCard.jsx`

---

## 🎨 体验优化缺失（中优先级）

### 9. 键盘快捷键支持
**在 Cursor 中的作用**：
- `Enter` / `Space`：接受当前步骤
- `Esc`：拒绝当前步骤
- `Ctrl+Enter`：接受所有步骤
- `Ctrl+Esc`：拒绝所有步骤
- 提升操作效率

**实现要点**：
- 在步骤卡片上添加键盘事件监听
- 聚焦步骤卡片时响应快捷键
- 显示快捷键提示（在按钮 title 或 tooltip 中）

**文件**：`src/components/AskMessageCard.jsx`

---

### 10. 代码语法高亮（Diff 中的代码）
**在 Cursor 中的作用**：
- Diff 中的代码块有语法高亮
- 根据文件语言自动应用高亮
- 提升代码可读性

**实现要点**：
- 集成语法高亮库（如 `prismjs` 或 `highlight.js`）
- 在 `agent-diff-text` 中应用语法高亮
- 根据 `language` prop 选择高亮规则

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 11. ANSI 颜色码保留（终端输出颜色）
**在 Cursor 中的作用**：
- 终端输出保留 ANSI 颜色码
- `npm install` 等命令的输出有彩色显示
- 提升输出可读性

**实现要点**：
- 使用 `ansi-to-html` 或类似库转换 ANSI 码
- 在 `agent-step-output` 中渲染彩色输出
- 支持常见的 ANSI 颜色（红、绿、黄、蓝等）

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 12. 步骤取消功能
**在 Cursor 中的作用**：
- 正在执行的命令可以取消
- 显示 "Cancel" 按钮，点击后终止进程
- 避免长时间等待

**实现要点**：
- 在 `main.js` 中保存命令进程的 PID
- 添加 `agent:cancelCommand` IPC
- 在 `AgentTerminalStepCard` 中添加 Cancel 按钮
- 取消时调用 `process.kill(pid)`

**文件**：`main.js`, `src/components/AskMessageCard.jsx`, `preload.js`

---

### 13. 文件变更检测
**在 Cursor 中的作用**：
- 应用前检测文件是否被外部修改
- 如果文件已变更，显示冲突警告
- 提供 "查看差异"、"覆盖"、"取消" 选项

**实现要点**：
- 在 Accept 前重新读取文件内容
- 比较当前内容与之前读取的内容
- 如果不同，显示冲突对话框
- 提供合并选项（如果可能）

**文件**：`src/components/AskMessageCard.jsx`, `src/components/DialogProvider.jsx`

---

### 14. Git 集成（显示 Git 状态）
**在 Cursor 中的作用**：
- 在文件路径旁显示 Git 状态图标
- 显示文件是 modified、untracked、staged 等
- 帮助用户了解文件版本状态

**实现要点**：
- 添加 `git:getStatus` IPC（执行 `git status --porcelain`）
- 解析 Git 状态并返回文件状态映射
- 在 `AgentEditStepCard` 的路径旁显示状态图标
- 使用不同颜色表示不同状态

**文件**：`main.js`, `src/components/AskMessageCard.jsx`, `preload.js`

---

### 15. 文件上下文预览
**在 Cursor 中的作用**：
- 编辑卡片显示文件的部分上下文（相关代码片段）
- 帮助用户理解修改的上下文
- 可以展开查看完整文件

**实现要点**：
- 在 `AgentEditStepCard` 中读取文件时提取上下文
- 显示修改行前后各 5-10 行的上下文
- 提供 "查看完整文件" 链接

**文件**：`src/components/AskMessageCard.jsx`

---

### 16. 步骤状态图标完善
**在 Cursor 中的作用**：
- pending：时钟图标或待处理图标
- applying：旋转的加载图标
- applied：绿色勾选图标
- failed：红色错误图标
- rejected：灰色 X 图标

**实现要点**：
- 为每种状态添加对应的图标
- 使用 `lucide-react` 的图标组件
- 更新 `AgentEditStepCard` 和 `AgentTerminalStepCard`

**文件**：`src/components/AskMessageCard.jsx`

---

### 17. 步骤执行时间记录
**在 Cursor 中的作用**：
- 显示每个步骤的执行时间（如 "应用耗时 1.2s"）
- 帮助用户了解性能
- 在步骤标题或底部显示

**实现要点**：
- 在 Accept/Run 时记录开始时间
- 完成后计算耗时
- 显示在步骤卡片中

**文件**：`src/components/AskMessageCard.jsx`

---

### 18. 步骤完成通知（Toast）
**在 Cursor 中的作用**：
- 步骤应用成功时显示 Toast 通知
- 非阻塞式提示，自动消失
- 提升用户反馈

**实现要点**：
- 使用现有的 Toast 系统（如果存在）或创建新的
- 在 `onApplied` 回调中触发 Toast
- 显示 "已应用：文件名" 或 "命令执行成功"

**文件**：`src/components/AskMessageCard.jsx`, `src/App.jsx`（如果使用现有 Toast）

---

### 19. 步骤复制功能
**在 Cursor 中的作用**：
- 右键菜单或按钮提供 "复制代码"、"复制命令"
- 快速重用步骤内容
- 提升效率

**实现要点**：
- 在步骤卡片 header 添加复制按钮
- 复制代码块内容或命令内容
- 显示复制成功提示

**文件**：`src/components/AskMessageCard.jsx`

---

### 20. 步骤导出功能
**在 Cursor 中的作用**：
- 导出步骤为 JSON 或 Markdown
- 保存步骤配置以便重用
- 分享步骤给团队成员

**实现要点**：
- 添加 "导出步骤" 按钮（在批量操作栏）
- 序列化步骤数据为 JSON/Markdown
- 触发下载

**文件**：`src/components/AskMessageCard.jsx`

---

## 🚀 高级功能缺失（低优先级 - 可选）

### 21. 步骤依赖关系管理
**在 Cursor 中的作用**：
- 定义步骤间的依赖（如 "步骤2依赖步骤1"）
- 自动按依赖顺序执行
- 可视化依赖图

**实现要点**：
- 解析步骤中的依赖标记（如 `@depends: step-1`）
- 构建依赖图
- 按拓扑排序执行
- 显示依赖关系可视化

**文件**：`src/components/AskMessageCard.jsx`

---

### 22. 步骤并行执行
**在 Cursor 中的作用**：
- 多个独立命令可以并行执行
- 提升执行效率
- 显示并行执行状态

**实现要点**：
- 检测步骤间的依赖关系
- 无依赖的步骤并行执行
- 使用 Promise.all 管理并行执行
- 更新 UI 显示并行状态

**文件**：`src/components/AskMessageCard.jsx`

---

### 23. 步骤回滚功能
**在 Cursor 中的作用**：
- 回滚已应用的步骤
- 恢复文件到之前的状态
- 撤销操作

**实现要点**：
- 保存应用前的文件内容
- 提供 "Rollback" 按钮
- 恢复文件内容

**文件**：`src/components/AskMessageCard.jsx`

---

### 24. 步骤预览模式（Dry-run）
**在 Cursor 中的作用**：
- 预览步骤效果而不实际执行
- 安全测试步骤
- 显示预览结果

**实现要点**：
- 添加 "Preview" 模式
- 模拟执行但不写入文件
- 显示预览结果

**文件**：`src/components/AskMessageCard.jsx`

---

### 25. 步骤撤销栈（Undo/Redo）
**在 Cursor 中的作用**：
- 撤销已应用的步骤
- 重做撤销的步骤
- 维护操作历史

**实现要点**：
- 维护撤销栈（应用前的状态）
- 提供 Undo/Redo 按钮
- 限制栈大小（如最多 50 步）

**文件**：`src/components/AskMessageCard.jsx`

---

### 26. 步骤版本比较
**在 Cursor 中的作用**：
- 比较不同版本的步骤
- 查看步骤变更历史
- 恢复旧版本

**实现要点**：
- 保存步骤版本历史
- 提供版本比较 UI
- 显示差异

**文件**：`src/components/AskMessageCard.jsx`

---

### 27. 步骤搜索功能
**在 Cursor 中的作用**：
- 在长对话中搜索步骤
- 按文件名、命令内容搜索
- 快速定位步骤

**实现要点**：
- 添加搜索输入框
- 过滤步骤列表
- 高亮匹配内容

**文件**：`src/components/AskMessageCard.jsx`

---

### 28. 步骤筛选/过滤
**在 Cursor 中的作用**：
- 按类型筛选（只显示编辑/只显示命令）
- 按状态筛选（pending/applied/failed）
- 快速定位特定步骤

**实现要点**：
- 添加筛选器 UI
- 实现筛选逻辑
- 更新步骤列表显示

**文件**：`src/components/AskMessageCard.jsx`

---

### 29. 步骤模板/预设
**在 Cursor 中的作用**：
- 保存常用步骤组合为模板
- 快速应用模板
- 分享模板给团队

**实现要点**：
- 添加模板保存功能
- 模板库 UI
- 应用模板功能

**文件**：`src/components/AskMessageCard.jsx`, `main.js`（持久化）

---

### 30. 步骤评论/备注
**在 Cursor 中的作用**：
- 为步骤添加注释
- 记录修改原因
- 团队协作说明

**实现要点**：
- 添加评论输入框
- 保存评论到步骤数据
- 显示评论图标和内容

**文件**：`src/components/AskMessageCard.jsx`

---

## 🔧 工程化缺失（中优先级）

### 31. Diff 算法优化（Myers Diff）
**在 Cursor 中的作用**：
- 使用更智能的 diff 算法
- 处理行移动、块变化
- 更准确的差异展示

**实现要点**：
- 集成 `diff` 库（如 `diff` npm 包）
- 替换简单的 `diffLines` 函数
- 支持块级 diff

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 32. 行号点击跳转
**在 Cursor 中的作用**：
- 点击 diff 行号跳转到文件对应行
- 在编辑器中打开文件并定位
- 快速查看上下文

**实现要点**：
- 行号添加点击事件
- 调用 `onOpenFile` 并传递行号
- 在文件编辑器中定位

**文件**：`src/components/AskMessageCard.jsx`, `src/ProjectView.jsx`

---

### 33. 命令执行环境变量
**在 Cursor 中的作用**：
- 正确继承系统环境变量
- 支持项目特定的环境变量（.env）
- 确保命令在正确环境中执行

**实现要点**：
- 在 `agent:runCommand` 中读取 `.env` 文件
- 合并系统环境变量和项目环境变量
- 传递给 exec

**文件**：`main.js`

---

### 34. 大文件性能优化（虚拟滚动）
**在 Cursor 中的作用**：
- 大文件的 diff 使用虚拟滚动
- 只渲染可见区域
- 避免卡顿

**实现要点**：
- 集成虚拟滚动库（如 `react-window`）
- 应用到 `agent-step-diff`
- 限制初始渲染行数

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 35. 组件性能优化（Memo）
**在 Cursor 中的作用**：
- 使用 React.memo 避免不必要的重渲染
- 使用 useMemo/useCallback 优化计算
- 提升性能

**实现要点**：
- 为步骤卡片组件添加 memo
- 优化回调函数
- 减少不必要的渲染

**文件**：`src/components/AskMessageCard.jsx`

---

### 36. 步骤状态持久化
**在 Cursor 中的作用**：
- 刷新后保持步骤状态（已应用/已拒绝）
- 持久化到会话数据
- 恢复会话时恢复状态

**实现要点**：
- 在消息数据中保存步骤状态
- 持久化到 `chat-sessions.json`
- 恢复时读取状态

**文件**：`src/components/AskMessageCard.jsx`, `src/ProjectView.jsx`

---

### 37. 步骤右键菜单
**在 Cursor 中的作用**：
- 右键步骤卡片显示菜单
- 提供复制、导出、删除等选项
- 提升操作便利性

**实现要点**：
- 添加 `onContextMenu` 事件
- 显示上下文菜单组件
- 实现菜单项功能

**文件**：`src/components/AskMessageCard.jsx`

---

### 38. 步骤拖拽排序
**在 Cursor 中的作用**：
- 拖拽调整步骤顺序
- 自定义执行顺序
- 可视化排序

**实现要点**：
- 集成拖拽库（如 `react-beautiful-dnd`）
- 实现拖拽逻辑
- 更新步骤顺序

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 39. 步骤展开/折叠动画
**在 Cursor 中的作用**：
- 平滑的展开/折叠动画
- 提升视觉体验
- 使用 CSS transition

**实现要点**：
- 添加 CSS transition
- 使用 max-height 动画
- 优化动画性能

**文件**：`src/styles/ask-theme.css`

---

### 40. 步骤工具提示完善
**在 Cursor 中的作用**：
- 详细的工具提示说明
- 悬停显示更多信息
- 帮助用户理解功能

**实现要点**：
- 完善所有按钮的 title/tooltip
- 添加 Tooltip 组件（如果不存在）
- 显示快捷键提示

**文件**：`src/components/AskMessageCard.jsx`

---

## 🌐 国际化与可访问性（低优先级）

### 41. 国际化支持（i18n）
**在 Cursor 中的作用**：
- 支持多语言切换
- 英文、中文等
- 提升国际化用户体验

**实现要点**：
- 集成 i18n 库（如 `react-i18next`）
- 提取所有硬编码文本
- 提供语言切换功能

**文件**：`src/components/AskMessageCard.jsx`, `src/App.jsx`

---

### 42. 可访问性完善（A11y）
**在 Cursor 中的作用**：
- 完整的 ARIA 标签
- 键盘导航支持
- 屏幕阅读器支持

**实现要点**：
- 添加 `role`, `aria-label`, `aria-describedby`
- 实现完整的键盘导航
- 测试屏幕阅读器兼容性

**文件**：`src/components/AskMessageCard.jsx`

---

### 43. 响应式设计
**在 Cursor 中的作用**：
- 适配不同屏幕尺寸
- 移动端友好
- 小屏幕优化

**实现要点**：
- 添加响应式 CSS
- 测试不同屏幕尺寸
- 优化移动端体验

**文件**：`src/styles/ask-theme.css`

---

## 📊 补充发现的遗漏项

### 44. 步骤执行日志（详细日志）
**在 Cursor 中的作用**：
- 记录每个步骤的详细执行日志
- 时间戳、执行时长、错误堆栈
- 帮助调试和审计

**实现要点**：
- 在步骤数据中保存执行日志
- 显示日志查看器
- 导出日志功能

**文件**：`src/components/AskMessageCard.jsx`

---

### 45. 步骤依赖图可视化
**在 Cursor 中的作用**：
- 可视化显示步骤间的依赖关系
- 图形化展示执行流程
- 帮助理解复杂任务

**实现要点**：
- 集成图形库（如 `react-flow`）
- 构建依赖图
- 可视化展示

**文件**：`src/components/AskMessageCard.jsx`, `package.json`

---

### 46. 步骤权限控制
**在 Cursor 中的作用**：
- 控制哪些步骤可以执行
- 权限验证
- 安全控制

**实现要点**：
- 定义权限模型
- 验证步骤权限
- 显示权限提示

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 47. 步骤审批流程
**在 Cursor 中的作用**：
- 多级审批机制
- 团队协作审批
- 提升安全性

**实现要点**：
- 定义审批流程
- 实现审批状态
- 审批 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 48. 步骤定时执行
**在 Cursor 中的作用**：
- 定时执行步骤
- 计划任务
- 自动化执行

**实现要点**：
- 添加定时器功能
- 保存定时任务
- 后台执行

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 49. 步骤监控告警
**在 Cursor 中的作用**：
- 监控步骤执行状态
- 失败告警
- 通知用户

**实现要点**：
- 实现监控机制
- 告警规则
- 通知系统

**文件**：`src/components/AskMessageCard.jsx`

---

### 50. 步骤重试策略
**在 Cursor 中的作用**：
- 自动重试失败的步骤
- 可配置重试次数和间隔
- 提升成功率

**实现要点**：
- 定义重试策略
- 实现自动重试
- 配置界面

**文件**：`src/components/AskMessageCard.jsx`

---

### 51. 步骤超时处理
**在 Cursor 中的作用**：
- 设置步骤执行超时
- 超时自动取消
- 避免长时间等待

**实现要点**：
- 添加超时配置
- 实现超时检测
- 超时处理逻辑

**文件**：`main.js`, `src/components/AskMessageCard.jsx`

---

### 52. 步骤并发控制
**在 Cursor 中的作用**：
- 控制同时执行的步骤数量
- 避免资源竞争
- 提升稳定性

**实现要点**：
- 实现并发队列
- 限制并发数
- 队列管理

**文件**：`src/components/AskMessageCard.jsx`

---

### 53. 步骤队列管理
**在 Cursor 中的作用**：
- 管理步骤执行队列
- 优先级排序
- 队列可视化

**实现要点**：
- 实现队列数据结构
- 优先级算法
- 队列 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 54. 步骤优先级设置
**在 Cursor 中的作用**：
- 设置步骤优先级
- 高优先级先执行
- 优化执行顺序

**实现要点**：
- 添加优先级字段
- 排序逻辑
- 优先级 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 55. 步骤标签系统
**在 Cursor 中的作用**：
- 为步骤添加标签
- 分类管理
- 快速筛选

**实现要点**：
- 标签数据结构
- 标签 UI
- 标签筛选

**文件**：`src/components/AskMessageCard.jsx`

---

### 56. 步骤导入功能
**在 Cursor 中的作用**：
- 导入之前导出的步骤
- 重用步骤配置
- 团队共享

**实现要点**：
- 文件选择器
- JSON/Markdown 解析
- 导入验证

**文件**：`src/components/AskMessageCard.jsx`

---

### 57. 步骤历史版本
**在 Cursor 中的作用**：
- 保存步骤的历史版本
- 查看版本变更
- 恢复旧版本

**实现要点**：
- 版本数据结构
- 版本历史 UI
- 版本恢复功能

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 58. 步骤差异对比
**在 Cursor 中的作用**：
- 对比不同版本的步骤
- 显示变更差异
- 帮助理解变更

**实现要点**：
- 版本对比算法
- 差异可视化
- 对比 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 59. 步骤分享链接
**在 Cursor 中的作用**：
- 生成步骤分享链接
- 团队协作
- 快速分享

**实现要点**：
- 步骤序列化
- 链接生成
- 链接解析

**文件**：`src/components/AskMessageCard.jsx`

---

### 60. 步骤执行统计
**在 Cursor 中的作用**：
- 统计步骤执行情况
- 成功率、平均时间
- 性能分析

**实现要点**：
- 统计数据收集
- 统计 UI
- 图表展示

**文件**：`src/components/AskMessageCard.jsx`

---

### 61. 步骤空状态处理
**在 Cursor 中的作用**：
- 当没有步骤时显示友好提示
- 引导用户操作
- 提升体验

**实现要点**：
- 检测空状态
- 空状态 UI
- 引导文案

**文件**：`src/components/AskMessageCard.jsx`

---

### 62. 步骤错误边界
**在 Cursor 中的作用**：
- 捕获步骤执行错误
- 优雅降级
- 错误恢复

**实现要点**：
- React Error Boundary
- 错误捕获
- 错误 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 63. 步骤数据验证
**在 Cursor 中的作用**：
- 验证步骤数据完整性
- 防止无效步骤
- 提升稳定性

**实现要点**：
- 数据验证规则
- 验证逻辑
- 错误提示

**文件**：`src/components/AskMessageCard.jsx`

---

### 64. 步骤缓存机制
**在 Cursor 中的作用**：
- 缓存已解析的步骤
- 避免重复解析
- 提升性能

**实现要点**：
- 缓存数据结构
- 缓存策略
- 缓存失效

**文件**：`src/components/AskMessageCard.jsx`

---

### 65. 步骤执行上下文
**在 Cursor 中的作用**：
- 保存步骤执行上下文
- 环境变量、工作目录等
- 确保一致性

**实现要点**：
- 上下文数据结构
- 上下文传递
- 上下文恢复

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 66. 步骤实时状态更新（流式过程中）
**在 Cursor 中的作用**：
- 在流式生成过程中实时更新步骤状态
- 显示 "正在生成步骤..."、"步骤已完成" 等状态
- 用户无需等待完整回复即可看到进度

**实现要点**：
- 在流式 chunk 中检测步骤开始/结束标记
- 实时创建/更新步骤卡片
- 显示生成中状态

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 67. 步骤执行计划预览
**在 Cursor 中的作用**：
- 在执行前显示完整的执行计划
- 列出所有将要执行的步骤
- 允许用户预览并确认

**实现要点**：
- 解析所有步骤后生成计划视图
- 显示步骤列表和执行顺序
- "开始执行" 按钮

**文件**：`src/components/AskMessageCard.jsx`

---

### 68. 步骤批量编辑
**在 Cursor 中的作用**：
- 批量编辑多个步骤的属性
- 修改路径、命令等
- 提升效率

**实现要点**：
- 多选步骤
- 批量编辑对话框
- 批量更新逻辑

**文件**：`src/components/AskMessageCard.jsx`

---

### 69. 步骤模板变量替换
**在 Cursor 中的作用**：
- 步骤模板支持变量（如 `{{projectName}}`, `{{fileName}}`）
- 应用模板时替换变量
- 提升模板灵活性

**实现要点**：
- 变量解析引擎
- 变量替换逻辑
- 变量输入 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 70. 步骤条件执行（If/Else）
**在 Cursor 中的作用**：
- 根据条件决定是否执行步骤
- 支持 `if`、`else`、`elif` 逻辑
- 实现复杂工作流

**实现要点**：
- 条件表达式解析
- 条件评估引擎
- 条件 UI 展示

**文件**：`src/components/AskMessageCard.jsx`

---

### 71. 步骤循环执行（For/While）
**在 Cursor 中的作用**：
- 循环执行步骤
- 支持 `for`、`while` 循环
- 批量处理

**实现要点**：
- 循环表达式解析
- 循环执行引擎
- 循环 UI 展示

**文件**：`src/components/AskMessageCard.jsx`

---

### 72. 步骤错误处理策略
**在 Cursor 中的作用**：
- 定义步骤失败时的处理策略
- "继续执行"、"停止执行"、"重试"
- 提升容错性

**实现要点**：
- 错误处理策略配置
- 策略执行逻辑
- 策略 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 73. 步骤输出解析（提取关键信息）
**在 Cursor 中的作用**：
- 从命令输出中提取关键信息
- 解析 JSON、提取版本号等
- 用于后续步骤

**实现要点**：
- 输出解析规则
- 解析引擎
- 解析结果展示

**文件**：`src/components/AskMessageCard.jsx`

---

### 74. 步骤后续操作（基于输出）
**在 Cursor 中的作用**：
- 根据步骤输出决定后续操作
- 动态调整执行计划
- 实现智能工作流

**实现要点**：
- 输出分析逻辑
- 动态步骤生成
- 执行计划调整

**文件**：`src/components/AskMessageCard.jsx`

---

### 75. 步骤执行历史记录
**在 Cursor 中的作用**：
- 记录所有步骤的执行历史
- 查看历史执行记录
- 审计和追踪

**实现要点**：
- 历史记录数据结构
- 历史记录存储
- 历史记录查看 UI

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 76. 步骤执行结果对比
**在 Cursor 中的作用**：
- 对比不同执行的结果
- 发现差异
- 帮助调试

**实现要点**：
- 结果数据结构
- 对比算法
- 对比 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 77. 步骤执行性能分析
**在 Cursor 中的作用**：
- 分析步骤执行性能
- 识别瓶颈
- 优化建议

**实现要点**：
- 性能数据收集
- 性能分析算法
- 性能报告 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 78. 步骤执行环境隔离
**在 Cursor 中的作用**：
- 每个步骤在独立环境中执行
- 避免环境污染
- 提升稳定性

**实现要点**：
- 环境隔离机制
- 环境清理逻辑
- 环境配置

**文件**：`main.js`

---

### 79. 步骤执行资源限制
**在 Cursor 中的作用**：
- 限制步骤的资源使用（CPU、内存）
- 防止资源耗尽
- 提升稳定性

**实现要点**：
- 资源监控
- 资源限制机制
- 资源超限处理

**文件**：`main.js`

---

### 80. 步骤执行日志聚合
**在 Cursor 中的作用**：
- 聚合所有步骤的执行日志
- 统一查看和管理
- 便于调试

**实现要点**：
- 日志聚合逻辑
- 日志查看器
- 日志搜索和过滤

**文件**：`src/components/AskMessageCard.jsx`

---

### 81. 步骤实时协作（多人协作）
**在 Cursor 中的作用**：
- 多人同时查看和操作步骤
- 实时同步步骤状态
- 团队协作

**实现要点**：
- WebSocket 实时通信
- 状态同步机制
- 冲突解决策略

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 82. 步骤评论系统（团队协作）
**在 Cursor 中的作用**：
- 为步骤添加评论
- 团队成员讨论
- 协作沟通

**实现要点**：
- 评论数据结构
- 评论 UI
- 评论通知

**文件**：`src/components/AskMessageCard.jsx`

---

### 83. 步骤通知系统（团队通知）
**在 Cursor 中的作用**：
- 步骤完成时通知相关人员
- 团队协作通知
- 提升协作效率

**实现要点**：
- 通知规则配置
- 通知发送机制
- 通知 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 84. 步骤权限管理（角色权限）
**在 Cursor 中的作用**：
- 基于角色的权限控制
- 不同角色不同权限
- 安全控制

**实现要点**：
- 权限模型设计
- 权限验证逻辑
- 权限 UI

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 85. 步骤审批工作流（多级审批）
**在 Cursor 中的作用**：
- 多级审批流程
- 审批状态跟踪
- 提升安全性

**实现要点**：
- 工作流引擎
- 审批状态管理
- 审批 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 86. 步骤 Git 集成（版本控制）
**在 Cursor 中的作用**：
- 步骤自动提交到 Git
- 版本控制集成
- 变更追踪

**实现要点**：
- Git 操作封装
- 自动提交逻辑
- Git 状态显示

**文件**：`main.js`, `src/components/AskMessageCard.jsx`

---

### 87. 步骤测试框架（自动化测试）
**在 Cursor 中的作用**：
- 为步骤编写测试
- 自动化测试执行
- 确保质量

**实现要点**：
- 测试框架集成
- 测试执行引擎
- 测试结果展示

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 88. 步骤监控告警（实时监控）
**在 Cursor 中的作用**：
- 实时监控步骤执行
- 异常告警
- 及时响应

**实现要点**：
- 监控指标收集
- 告警规则配置
- 告警通知

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 89. 步骤日志分析（日志分析）
**在 Cursor 中的作用**：
- 分析步骤执行日志
- 发现模式和问题
- 优化建议

**实现要点**：
- 日志分析算法
- 模式识别
- 分析报告

**文件**：`src/components/AskMessageCard.jsx`

---

### 90. 步骤性能优化（性能调优）
**在 Cursor 中的作用**：
- 分析步骤性能瓶颈
- 提供优化建议
- 自动优化

**实现要点**：
- 性能分析工具
- 优化建议引擎
- 自动优化逻辑

**文件**：`src/components/AskMessageCard.jsx`, `main.js`

---

### 91. 步骤执行环境快照
**在 Cursor 中的作用**：
- 保存步骤执行前的环境快照
- 失败时恢复环境
- 提升可靠性

**实现要点**：
- 环境快照机制
- 快照存储
- 快照恢复

**文件**：`main.js`

---

### 92. 步骤执行回放
**在 Cursor 中的作用**：
- 回放步骤执行过程
- 调试和审计
- 学习工具

**实现要点**：
- 执行记录保存
- 回放引擎
- 回放 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 93. 步骤执行模拟
**在 Cursor 中的作用**：
- 模拟步骤执行
- 不实际执行
- 安全测试

**实现要点**：
- 模拟引擎
- 模拟结果展示
- 模拟 UI

**文件**：`src/components/AskMessageCard.jsx`

---

### 94. 步骤执行验证
**在 Cursor 中的作用**：
- 验证步骤执行结果
- 自动验证
- 确保正确性

**实现要点**：
- 验证规则定义
- 验证引擎
- 验证结果展示

**文件**：`src/components/AskMessageCard.jsx`

---

### 95. 步骤执行报告
**在 Cursor 中的作用**：
- 生成步骤执行报告
- 统计和分析
- 团队分享

**实现要点**：
- 报告生成引擎
- 报告模板
- 报告导出

**文件**：`src/components/AskMessageCard.jsx`

---

## 🎯 实施优先级矩阵

### P0 - 必须实现（核心对齐）
| 功能 | 优先级 | 影响 | 难度 | 预计时间 |
|------|--------|------|------|----------|
| 批量操作 | P0 | 高 | 中 | 4h |
| 步骤编号与进度 | P0 | 高 | 低 | 2h |
| 步骤折叠 | P0 | 中 | 低 | 3h |
| 错误重试 | P0 | 高 | 低 | 2h |
| 路径安全验证 | P0 | 极高 | 中 | 3h |
| 命令注入防护 | P0 | 极高 | 中 | 4h |
| 流式步骤解析 | P0 | 极高 | 高 | 8h |
| Tool Calling | P0 | 极高 | 高 | 12h |

### P1 - 重要（体验对齐）
| 功能 | 优先级 | 影响 | 难度 | 预计时间 |
|------|--------|------|------|----------|
| 键盘快捷键 | P1 | 中 | 低 | 3h |
| 代码语法高亮 | P1 | 中 | 中 | 4h |
| ANSI 颜色 | P1 | 中 | 低 | 2h |
| 步骤取消 | P1 | 中 | 中 | 3h |
| 文件变更检测 | P1 | 高 | 中 | 4h |
| Git 集成 | P1 | 中 | 高 | 6h |
| 文件上下文预览 | P1 | 低 | 中 | 3h |
| 步骤状态图标 | P1 | 低 | 低 | 2h |
| 步骤执行时间 | P1 | 低 | 低 | 1h |
| 步骤完成通知 | P1 | 中 | 低 | 2h |
| 步骤复制 | P1 | 低 | 低 | 1h |
| 步骤导出 | P1 | 低 | 中 | 3h |

### P2 - 可选（高级功能）
| 功能 | 优先级 | 影响 | 难度 | 预计时间 |
|------|--------|------|------|----------|
| Diff 算法优化 | P2 | 中 | 中 | 4h |
| 行号跳转 | P2 | 低 | 中 | 3h |
| 环境变量 | P2 | 中 | 低 | 2h |
| 虚拟滚动 | P2 | 中 | 高 | 6h |
| 组件优化 | P2 | 中 | 低 | 2h |
| 状态持久化 | P2 | 中 | 中 | 3h |
| 右键菜单 | P2 | 低 | 中 | 3h |
| 拖拽排序 | P2 | 低 | 高 | 6h |
| 其他高级功能 | P2 | 低-中 | 中-高 | 按需 |

---

## 📅 实施计划

### 阶段 1：核心功能（必须实现）
**时间**：2-3 天  
**优先级**：最高

1. ✅ 批量操作（Accept All / Reject All）
2. ✅ 步骤编号与进度指示
3. ✅ 步骤折叠功能
4. ✅ 错误重试机制
5. ✅ 路径安全验证
6. ✅ 命令注入防护

**验收标准**：
- 所有核心功能正常工作
- 安全验证通过
- UI 与 Cursor 一致

---

### 阶段 2：体验优化（重要）
**时间**：2-3 天  
**优先级**：高

7. ✅ 键盘快捷键支持
8. ✅ 代码语法高亮
9. ✅ ANSI 颜色码保留
10. ✅ 步骤取消功能
11. ✅ 文件变更检测
12. ✅ Git 集成
13. ✅ 文件上下文预览
14. ✅ 步骤状态图标完善
15. ✅ 步骤执行时间记录
16. ✅ 步骤完成通知
17. ✅ 步骤复制功能
18. ✅ 步骤导出功能

**验收标准**：
- 所有体验优化功能正常
- 性能无明显下降
- 用户体验显著提升

---

### 阶段 3：流式与工具调用（关键）
**时间**：3-4 天  
**优先级**：最高（与阶段1并行）

19. ✅ 流式步骤解析（实时步骤展示）
20. ✅ Tool Calling 支持（真正的工具调用）

**验收标准**：
- 流式过程中实时显示步骤
- Tool calling 正常工作
- 与 Cursor 行为一致

---

### 阶段 4：高级功能（可选）
**时间**：按需  
**优先级**：中低

21-95. 根据实际需求选择性实现

**建议优先实现的高级功能**：
- Diff 算法优化（提升准确性）
- 虚拟滚动（提升性能）
- 状态持久化（提升体验）
- 右键菜单（提升操作便利性）

---

## 🗺️ 关键实施路径

### 路径 A：最小可行对齐（MVP）
**目标**：达到与 Cursor 的核心对齐  
**时间**：5-7 天

1. 阶段 1：核心功能（1-6）+ 安全功能（7-8）
2. 阶段 3：流式步骤解析（19）+ Tool Calling（20）

**验收标准**：
- 核心功能与 Cursor 一致
- 安全功能完善
- 流式步骤解析正常
- Tool Calling 正常工作

---

### 路径 B：完整体验对齐
**目标**：达到与 Cursor 的完整体验对齐  
**时间**：10-14 天

1. 路径 A 的所有功能
2. 阶段 2：体验优化（9-18）

**验收标准**：
- 所有核心功能与 Cursor 一致
- 所有体验优化功能正常
- 用户体验与 Cursor 一致

---

### 路径 C：企业级完整对齐
**目标**：达到企业级功能对齐  
**时间**：20-30 天

1. 路径 B 的所有功能
2. 阶段 4：关键高级功能（21-40）
3. 企业级功能（81-95，按需）

**验收标准**：
- 所有功能与 Cursor 一致
- 企业级功能正常
- 性能和安全达标

---

## 🎯 关键验收标准

### 功能完整性
- [ ] 所有核心功能（1-6）已实现
- [ ] 所有体验优化（7-18）已实现
- [ ] 流式与工具调用（19-20）已实现
- [ ] 关键高级功能（66-80）根据需求实现

### UI/UX 一致性
- [ ] 步骤卡片样式与 Cursor 完全一致
- [ ] 交互行为与 Cursor 完全一致
- [ ] 动画效果与 Cursor 一致

### 安全性
- [ ] 路径安全验证通过
- [ ] 命令注入防护通过
- [ ] 无已知安全漏洞

### 性能
- [ ] 大文件 diff 流畅（<100ms）
- [ ] 流式解析无卡顿
- [ ] 内存占用合理

### 稳定性
- [ ] 无崩溃错误
- [ ] 错误处理完善
- [ ] 边界情况处理正确

---

## 📝 实施注意事项

1. **优先级**：严格按照阶段顺序实施，核心功能优先
2. **测试**：每个功能实现后立即测试，确保无回归
3. **代码质量**：保持代码整洁，添加必要注释
4. **性能**：注意性能影响，必要时优化
5. **安全**：安全功能必须实现，不可妥协
6. **一致性**：始终以 Cursor 的实际行为为准

---

## 🔄 持续改进

- 定期对比 Cursor 最新版本，发现新功能
- 收集用户反馈，优化体验
- 性能监控，持续优化
- 安全审计，及时修复漏洞

---

---

## 📌 补充说明

### 功能分类统计
- **核心功能**：6 项（必须实现）
- **安全功能**：2 项（必须实现）
- **体验优化**：12 项（重要）
- **流式与工具调用**：2 项（关键）
- **高级功能**：58+ 项（可选）
- **企业级功能**：15+ 项（可选，团队协作场景）

### 实施建议
1. **第一阶段**：必须完成核心功能（1-6）和安全功能（7-8），确保基本可用性和安全性
2. **第二阶段**：完成体验优化（9-20），提升用户体验
3. **第三阶段**：实现流式步骤解析和 Tool Calling（21-22），达到与 Cursor 的核心对齐
4. **第四阶段**：根据实际需求选择性实现高级功能（23-80）

### 关键成功因素
- **准确性**：每个功能必须与 Cursor 的实际行为完全一致
- **性能**：不能因为功能增加而影响性能
- **安全**：安全功能不可妥协，必须实现
- **测试**：每个功能实现后必须充分测试
- **文档**：保持文档更新，记录实现细节

---

**文档版本**：1.1  
**最后更新**：2026-02-17  
**维护者**：开发团队  
**总功能项**：95+ 项

---

## 🔍 最终检查清单

### 核心对齐项（必须 100% 对齐）
- [ ] 步骤卡片 UI 与 Cursor 完全一致
- [ ] 批量操作功能与 Cursor 一致
- [ ] 步骤编号与进度与 Cursor 一致
- [ ] 步骤折叠行为与 Cursor 一致
- [ ] 错误重试机制与 Cursor 一致
- [ ] 流式步骤解析与 Cursor 一致
- [ ] Tool Calling 与 Cursor 一致（如果 Cursor 支持）

### 安全对齐项（必须 100% 对齐）
- [ ] 路径安全验证与 Cursor 一致
- [ ] 命令注入防护与 Cursor 一致

### 体验对齐项（应尽可能对齐）
- [ ] 键盘快捷键与 Cursor 一致
- [ ] 代码语法高亮与 Cursor 一致
- [ ] ANSI 颜色与 Cursor 一致
- [ ] 文件变更检测与 Cursor 一致
- [ ] Git 集成与 Cursor 一致

### 高级功能（根据实际需求）
- [ ] 根据 Cursor 最新版本补充新功能
- [ ] 根据用户反馈优化体验
- [ ] 根据性能监控优化性能

---

**重要提醒**：
1. 每个功能实现前，先研究 Cursor 的实际行为
2. 实现后立即对比验证，确保一致性
3. 保持代码质量，添加充分注释
4. 性能和安全不可妥协
5. 持续关注 Cursor 更新，及时对齐新功能
